---
import BaseLayout from '../layouts/BaseLayout.astro';
import TerminalShell from '../components/TerminalShell.astro';
---

<BaseLayout title="BASEMENT OS | About">
  <TerminalShell activeSection="about">
    <div class="content-section active">
      <h2 class="section-header">C:\BASEMENT\ABOUT.TXT</h2>

      <div class="devlog-content">
        <p>Visitors can explore a world that blends retro charm with modern VR features: a functional DOS-style terminal running its own "Basement OS", Xbox 360-style achievements, real-time weather integration, and persistent progress tracking powered by VRChat's PlayerData API. The project has now surpassed <span id="stat-visits-intro">770+</span> visits, continuing to evolve as I refine the underlying methods behind its development.</p>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <h3 style="margin-top: 20px; margin-bottom: 15px;">Core Features</h3>

      <div class="info-grid">
        <div class="info-card">
            <h3>[ Achievement System (Xbox 360-Inspired) ]</h3>
            <ul style="list-style-type: disc; margin-left: 20px; color: var(--text-secondary); margin-top: 8px;">
                <li>19 achievements across Visit, Time, and Activity categories</li>
                <li>Total of 420 Gamerscore</li>
                <li>Persistent tracking through PlayerData</li>
                <li>Seven role-based notification tiers with custom icons and sounds</li>
                <li>Anti-spam logic using edge detection and persistent flags</li>
            </ul>
        </div>

        <div class="info-card">
            <h3>[ Basement OS v29.1 — Interactive DOS Terminal ]</h3>
            <ul style="list-style-type: disc; margin-left: 20px; color: var(--text-secondary); margin-top: 8px;">
                <li>9-page menu with arrow-key navigation</li>
                <li>Auto-generated changelog pulled directly from Git commits</li>
                <li>Real-time stats: weather, player count, uptime, and session data</li>
                <li>Remote content loading from GitHub Pages via domain whitelisting</li>
            </ul>
        </div>

        <div class="info-card">
            <h3>[ Live Weather Integration ]</h3>
            <ul style="list-style-type: disc; margin-left: 20px; color: var(--text-secondary); margin-top: 8px;">
                <li>Dynamic weather powered by an external API</li>
                <li>Rain shader on basement windows</li>
                <li>Weather-based achievements (e.g., Heavy Rain)</li>
                <li>Optimized caching: 2 minutes on PC VR, 10 minutes on Quest</li>
                <li>Support for seven atmospheric conditions</li>
            </ul>
        </div>

        <div class="info-card">
            <h3>[ Network-Synced Notifications ]</h3>
            <ul style="list-style-type: disc; margin-left: 20px; color: var(--text-secondary); margin-top: 8px;">
                <li>FIFO queue system for chronological ordering (max 100 items)</li>
                <li>Smooth fade animations and icon alternation</li>
                <li>Multiplayer broadcasting via UdonSynced variables</li>
                <li>Role-aware personalization for visitors</li>
            </ul>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <div class="info-grid">
        <div class="info-card">
            <h3>[ Tech Stack ]</h3>
            <div class="stat-row">
                <span class="stat-label">Engine</span>
                <span class="stat-value">Unity 2022.3.22f1</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">SDK</span>
                <span class="stat-value">VRChat SDK 3.8.2+</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Scripting</span>
                <span class="stat-value">UdonSharp</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Platform</span>
                <span class="stat-value">PC VR + Quest</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Status</span>
                <span class="stat-value">Active Development</span>
            </div>
        </div>

        <div class="info-card">
            <h3>[ Lower Level Stats ]</h3>
            <div class="stat-row">
                <span class="stat-label">Total Visits</span>
                <span class="stat-value" id="stat-visits">Loading...</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Total Favorites</span>
                <span class="stat-value" id="stat-favorites">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Popularity</span>
                <span class="stat-value" id="stat-popularity">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Last Updated</span>
                <span class="stat-value" id="stat-updated">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">First Uploaded</span>
                <span class="stat-value" id="stat-created">--</span>
            </div>
        </div>
      </div>
    </div>
  </TerminalShell>
</BaseLayout>

<script>
// VRChat Stats Fetcher with Caching
document.addEventListener("DOMContentLoaded", function() {
    const worldId = "wrld_7302897c-be0f-4037-ac67-76f0ea065c2b";
    const apiKey = "JlE5Jldo5Jibnk5O5hTx6XVqsJyIkZVd";
    const CACHE_KEY = "vrchat-world-stats";
    const CACHE_DURATION = 10 * 60 * 1000; // 10 minutes

    // Default fallback stats
    const defaultStats = {
        visits: 770,
        favorites: 25,
        popularity: 42,
        updated_at: "2025-12-09T00:00:00.000Z",
        created_at: "2024-07-08T00:00:00.000Z",
        timestamp: Date.now()
    };

    const targetUrl = `https://api.vrchat.cloud/api/1/worlds/${worldId}?apiKey=${apiKey}`;
    const corsProxies = [
        `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`,
        `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`,
        `https://cors-anywhere.herokuapp.com/${targetUrl}`
    ];

    function getCachedStats() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const data = JSON.parse(cached);
                if (Date.now() - data.timestamp < CACHE_DURATION) {
                    return data;
                }
            }
        } catch (e) {
            console.log('Cache read failed:', e);
        }
        return null;
    }

    function setCachedStats(stats: any) {
        try {
            localStorage.setItem(CACHE_KEY, JSON.stringify({
                ...stats,
                timestamp: Date.now()
            }));
        } catch (e) {
            console.log('Cache write failed:', e);
        }
    }

    async function fetchWithFallback(proxies: string[]) {
        for (let i = 0; i < proxies.length; i++) {
            try {
                const response = await fetch(proxies[i], {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                if (!response.ok) continue;
                const data = await response.json();
                const worldData = data.contents ? JSON.parse(data.contents) : data;
                return worldData;
            } catch (e) {
                console.log(`Proxy ${i + 1} failed:`, e);
                continue;
            }
        }
        throw new Error('All proxies failed');
    }

    function formatDate(dateString: string) {
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (e) {
            return '--';
        }
    }

    function updateStats(worldData: any) {
        const formatNum = (num: number) => new Intl.NumberFormat().format(num);

        const elements = {
            visits: document.getElementById("stat-visits"),
            favorites: document.getElementById("stat-favorites"),
            popularity: document.getElementById("stat-popularity"),
            updated: document.getElementById("stat-updated"),
            created: document.getElementById("stat-created"),
            intro: document.getElementById("stat-visits-intro")
        };

        if (elements.visits) elements.visits.textContent = formatNum(worldData.visits);
        if (elements.favorites) elements.favorites.textContent = formatNum(worldData.favorites || 0);
        if (elements.popularity) elements.popularity.textContent = formatNum(worldData.popularity || 0);
        if (elements.updated) elements.updated.textContent = formatDate(worldData.updated_at);
        if (elements.created) elements.created.textContent = formatDate(worldData.created_at);
        if (elements.intro) elements.intro.textContent = formatNum(worldData.visits) + "+";
    }

    // Try to load from cache first
    const cachedData = getCachedStats();
    if (cachedData) {
        updateStats(cachedData);
    }

    // Fetch fresh data
    fetchWithFallback(corsProxies)
        .then(worldData => {
            updateStats(worldData);
            setCachedStats(worldData);
        })
        .catch(error => {
            console.log('All fetch attempts failed, using cached or default stats');
            // If no cached data, use defaults
            if (!cachedData) {
                updateStats(defaultStats);
                setCachedStats(defaultStats);
            }
        });
});
</script>
