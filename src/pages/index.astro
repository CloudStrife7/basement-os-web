---
import BaseLayout from '../layouts/BaseLayout.astro';
import TerminalShell from '../components/TerminalShell.astro';
---

<BaseLayout title="BASEMENT OS">
  <TerminalShell activeSection="home">
    <div class="content-section active">
      <h2 class="section-header">C:\BASEMENT\HOME.TXT</h2>

      <div class="mission-statement">
        <h3>A 2000s Basement VRChat World</h3>
        <p>Xbox 360 achievements, retro DOS terminal, real-time weather, cross-platform VR. Lower Level 2.0 recreates the quintessential 2000s basement gaming atmosphere—complete with persistent progress tracking, dynamic weather effects, and an interactive DOS terminal that feels like coming home.</p>
      </div>

      <!-- PROJECT STATS -->
      <div class="info-card">
        <h3>[ Project Stats ]</h3>
        <div class="stats-grid-compact">
          <div class="stat-block-compact">
            <span class="stat-number-compact" id="stat-visits-top">936</span>
            <span class="stat-label-compact">VISITS</span>
          </div>
          <div class="stat-block-compact">
            <span class="stat-number-compact">18,000</span>
            <span class="stat-label-compact">LINES</span>
          </div>
          <div class="stat-block-compact">
            <span class="stat-number-compact">47</span>
            <span class="stat-label-compact">SCRIPTS</span>
          </div>
          <div class="stat-block-compact">
            <span class="stat-number-compact">19</span>
            <span class="stat-label-compact">ACHIEVEMENTS</span>
          </div>
          <div class="stat-block-compact">
            <span class="stat-number-compact">420</span>
            <span class="stat-label-compact">GAMERSCORE</span>
          </div>
          <div class="stat-block-compact">
            <span class="stat-number-compact" id="stat-favorites-top">68</span>
            <span class="stat-label-compact">FAVORITES</span>
          </div>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- THE STORY -->
      <div class="info-card">
        <h3>[ The Story ]</h3>
        <div class="devlog-content story-content">
          <p>Lower Level 2.0 started as a simple VRChat world and evolved into an 18,000+ line codebase built entirely with AI collaboration. From zero UdonSharp experience to a fully-featured achievement system, interactive DOS terminal, and real-time weather integration—all developed through systematic Claude Code workflows.</p>
          <p class="story-paragraph">The project demonstrates what's possible when combining modern AI tools with creative vision: persistent player data, cross-platform optimization, and a nostalgic 2000s basement aesthetic that feels like coming home.</p>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- SCREENSHOTS -->
      <div class="info-card">
        <h3>[ Screenshots ]</h3>
        <div class="screenshot-grid-compact">
          <div class="crt-screen screenshot-compact">
            <a href="https://i.imgur.com/N8da6pU.jpeg" target="_blank">
              <img src="https://i.imgur.com/N8da6pU.jpeg" alt="The Gaming Area" loading="lazy" />
            </a>
            <p class="screenshot-caption">THE GAMING AREA</p>
          </div>
          <div class="crt-screen screenshot-compact">
            <a href="https://i.imgur.com/Kpu5VSp.png" target="_blank">
              <img src="https://i.imgur.com/Kpu5VSp.png" alt="Achievement Notification" loading="lazy" />
            </a>
            <p class="screenshot-caption">NOTIFICATIONS</p>
          </div>
          <div class="crt-screen screenshot-compact">
            <a href="https://i.imgur.com/BOlvKfD.jpeg" target="_blank">
              <img src="https://i.imgur.com/BOlvKfD.jpeg" alt="Arcade and Theater" loading="lazy" />
            </a>
            <p class="screenshot-caption">ARCADE & THEATER</p>
          </div>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- CORE FEATURES -->
      <div class="info-card">
        <h3>[ Core Features ]</h3>
        <div class="features-grid-compact">
          <div class="feature-card-compact">
            <strong>Achievement System</strong>
            <ul>
              <li>19 achievements (420G)</li>
              <li>PlayerData persistence</li>
              <li>7 role-based tiers</li>
            </ul>
            <p class="feature-desc">Xbox 360-style popups that save your progress across sessions—earn them all and flex your Gamerscore.</p>
          </div>
          <div class="feature-card-compact">
            <strong>Basement OS</strong>
            <ul>
              <li>80-char DOS terminal</li>
              <li>14 Terminal Tales</li>
              <li>MUSIC.EXE player</li>
            </ul>
            <p class="feature-desc">A fully interactive retro terminal with short stories, a music player, and live world stats.</p>
          </div>
          <div class="feature-card-compact">
            <strong>Weather Integration</strong>
            <ul>
              <li>Live weather API</li>
              <li>7 weather conditions</li>
              <li>Quest-optimized cache</li>
            </ul>
            <p class="feature-desc">Real-world weather synced to the basement—rain on the windows when it's raining outside.</p>
          </div>
          <div class="feature-card-compact">
            <strong>Network Sync</strong>
            <ul>
              <li>FIFO notification queue</li>
              <li>UdonSynced broadcast</li>
              <li>Role personalization</li>
            </ul>
            <p class="feature-desc">Everyone sees achievement unlocks in real-time—celebrate together when someone hits a milestone.</p>
          </div>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- ARCHITECTURE -->
      <div class="info-card">
        <h3>[ Architecture ]</h3>
        <div class="architecture-container">
          <pre class="architecture-diagram">
                 ┌─────────────────────────────────────────┐
                 │           User Interaction              │
                 └─────────────────────┬───────────────────┘
                                       │
       ┌───────────────────────────────┼───────────────────────────────┐
       │                    │                    │                     │
       ▼                    ▼                    ▼                     ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Achievement │    │ DOS Terminal│    │ Weather API │    │   ProTV 3   │
│ Tracker     │    │ Controller  │    │ Integration │    │ (MUSIC.EXE) │
└──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘
       │                  │                  │                  │
       │                  └─────────┬────────┘                  │
       │                            │                           │
       ▼                            ▼                           │
┌────────────────────────────────────────────────────────┐      │
│           NotificationEventHub (Bridge)                │◄─────┘
│  ─────────────────────────────────────────────────     │
│  • Network Broadcasting  • Event Routing               │
│  • Queue Management      • Music State Sync            │
└────────────────────────────┬───────────────────────────┘
                             │
                 ┌───────────┴───────────┐
                 │                       │
                 ▼                       ▼
       ┌─────────────────┐     ┌─────────────────┐
       │ XboxNotification│     │ Notification    │
       │ UI (FIFO)       │     │ Roles Module    │
       └────────┬────────┘     └─────────────────┘
                │
                ▼
       ┌─────────────────────────┐
       │ AchievementDataManager  │
       │ (VRChat PlayerData)     │
       └─────────────────────────┘
          </pre>
          <p class="architecture-caption">Hub-spoke event-driven architecture optimized for VRChat's UdonSharp environment</p>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- TECH STACK & WORLD STATS -->
      <div class="info-grid">
        <div class="info-card">
          <h3>[ Tech Stack ]</h3>
          <div class="stat-row">
            <span class="stat-label">Engine</span>
            <span class="stat-value">Unity 2022.3.22f1</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">SDK</span>
            <span class="stat-value">VRChat SDK 3.8.2+</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Scripting</span>
            <span class="stat-value">UdonSharp</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Platform</span>
            <span class="stat-value">PC VR + Quest</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Status</span>
            <span class="stat-value">Active Development</span>
          </div>
        </div>

        <div class="info-card">
          <h3>[ Lower Level Stats ]</h3>
          <div class="stat-row">
            <span class="stat-label">Total Visits</span>
            <span class="stat-value" id="stat-visits">Loading...</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Total Favorites</span>
            <span class="stat-value" id="stat-favorites">--</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Popularity</span>
            <span class="stat-value" id="stat-popularity">--</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Last Updated</span>
            <span class="stat-value" id="stat-updated">--</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">First Uploaded</span>
            <span class="stat-value" id="stat-created">--</span>
          </div>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- CALL TO ACTION -->
      <div class="cta-section">
        <p class="cta-heading">Ready to visit?</p>

        <a href="https://vrchat.com/home/launch?worldId=wrld_7302897c-be0f-4037-ac67-76f0ea065c2b" class="cta-button" target="_blank">
          <span class="cta-icon">▶</span>
          <span>ENTER LOWER LEVEL 2.0</span>
        </a>

        <div class="platform-badges">
          <span class="platform-badge">PC VR</span>
          <span class="platform-badge">Meta Quest</span>
          <span class="platform-badge">Desktop</span>
        </div>
      </div>

    </div>
  </TerminalShell>
</BaseLayout>

<style>
  /* Left-aligned routing header */
  .routing-header.left-align {
    text-align: left;
  }

  /* Compact Stats Grid - 6 items in one row */
  .stats-grid-compact {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 10px;
    text-align: center;
  }

  .stat-block-compact {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px 5px;
  }

  .stat-number-compact {
    font-size: 1.4em;
    font-weight: bold;
    color: var(--accent-primary);
    font-family: var(--font-mono);
    line-height: 1;
    margin-bottom: 4px;
  }

  .stat-label-compact {
    font-size: 0.6em;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-family: var(--font-mono);
  }

  /* Compact Screenshot Grid - 3 items in one row */
  .screenshot-grid-compact {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
  }

  .screenshot-compact {
    overflow: hidden;
  }

  .screenshot-compact img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    display: block;
    transition: transform 0.3s ease;
  }

  .screenshot-compact:hover img {
    transform: scale(1.05);
  }

  .screenshot-caption {
    text-align: center;
    color: var(--accent-primary);
    font-size: 0.7em;
    margin-top: 8px;
    letter-spacing: 1px;
  }

  /* Compact Features Grid - 4 items in one row */
  .features-grid-compact {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
  }

  .feature-card-compact {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    padding: 12px;
    font-size: 0.85em;
  }

  .feature-card-compact strong {
    display: block;
    color: var(--accent-primary);
    margin-bottom: 8px;
    font-size: 0.9em;
  }

  .feature-card-compact ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .feature-card-compact li {
    color: var(--text-secondary);
    padding: 2px 0;
    font-size: 0.85em;
  }

  .feature-card-compact li::before {
    content: "› ";
    color: var(--accent-primary);
  }

  .feature-desc {
    margin-top: 10px;
    padding-top: 8px;
    border-top: 1px solid var(--border);
    color: var(--text-muted);
    font-size: 0.8em;
    font-style: italic;
    line-height: 1.4;
  }

  /* Architecture Container */
  .architecture-container {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border);
    padding: 20px;
    margin-top: 10px;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
    overflow-x: auto;
  }

  .architecture-diagram {
    color: var(--accent-primary);
    font-family: var(--font-mono);
    font-size: 0.65em;
    line-height: 1.2;
    margin: 0;
    white-space: pre;
  }

  /* Story Content Styles (replacing inline styles) */
  .story-content {
    margin-top: 10px;
  }

  .story-paragraph {
    margin-top: 15px;
  }

  .architecture-caption {
    text-align: center;
    color: var(--text-secondary);
    margin-top: 15px;
    font-style: italic;
  }

  .cta-heading {
    color: var(--accent-primary);
    font-size: 1.1em;
    margin-bottom: 20px;
  }

  /* CTA Section */
  .cta-section {
    text-align: center;
    padding: 30px 0;
  }

  .cta-button {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: var(--accent-primary);
    color: #000;
    padding: 15px 30px;
    font-family: var(--font-mono);
    font-size: 1.1em;
    font-weight: bold;
    text-decoration: none;
    border: 2px solid var(--accent-primary);
    transition: all 0.3s ease;
  }

  .cta-button:hover {
    background: transparent;
    color: var(--accent-primary);
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
  }

  .cta-icon {
    font-size: 1.2em;
  }

  .platform-badges {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .platform-badge {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid var(--accent-primary);
    color: var(--accent-primary);
    padding: 5px 15px;
    font-family: var(--font-mono);
    font-size: 0.85em;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .stats-grid-compact {
      grid-template-columns: repeat(3, 1fr);
    }

    .features-grid-compact {
      grid-template-columns: repeat(2, 1fr);
    }

    .screenshot-grid-compact {
      grid-template-columns: repeat(3, 1fr);
    }

    .screenshot-compact img {
      height: 100px;
    }
  }

  @media (max-width: 600px) {
    .stats-grid-compact {
      grid-template-columns: repeat(3, 1fr);
    }

    .features-grid-compact {
      grid-template-columns: 1fr;
    }

    .screenshot-grid-compact {
      grid-template-columns: 1fr;
    }

    .screenshot-compact img {
      height: 150px;
    }

    .architecture-diagram {
      font-size: 0.45em;
    }
  }
</style>

<script>
/**
 * Number Spin-Up Animation
 * @param {HTMLElement} element - The DOM element to animate
 * @param {number} target - Target number to count up to
 * @param {number} duration - Animation duration in ms (default 1500)
 */
function animateNumber(element, target, duration = 1500) {
    const start = 0;
    const startTime = performance.now();
    /** @param {number} num */
    const formatNum = (num) => new Intl.NumberFormat().format(Math.floor(num));

    /** @param {number} currentTime */
    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);

        // Easing function for smooth deceleration
        const easeOut = 1 - Math.pow(1 - progress, 3);
        const current = start + (target - start) * easeOut;

        element.textContent = formatNum(current);

        if (progress < 1) {
            requestAnimationFrame(update);
        } else {
            // Final value with formatting
            element.textContent = formatNum(target);
        }
    }

    requestAnimationFrame(update);
}

// VRChat Stats Fetcher with Caching
document.addEventListener("astro:page-load", function() {
    const worldId = "wrld_7302897c-be0f-4037-ac67-76f0ea065c2b";
    // NOTE: This is VRChat's PUBLIC API key used for unauthenticated world info requests.
    // It is intentionally public and documented in VRChat community resources.
    const apiKey = "JlE5Jldo5Jibnk5O5hTx6XVqsJyIkZVd";
    const CACHE_KEY = "vrchat-world-stats";
    const CACHE_DURATION = 10 * 60 * 1000; // 10 minutes

    // Default fallback stats
    const defaultStats = {
        visits: 937,
        favorites: 68,
        popularity: 4,
        updated_at: "2025-12-28T00:00:00.000Z",
        created_at: "2024-07-22T00:00:00.000Z",
        timestamp: Date.now()
    };

    const targetUrl = `https://api.vrchat.cloud/api/1/worlds/${worldId}?apiKey=${apiKey}`;
    const corsProxies = [
        `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`,
        `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`,
        `https://cors-anywhere.herokuapp.com/${targetUrl}`
    ];

    function getCachedStats() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const data = JSON.parse(cached);
                if (Date.now() - data.timestamp < CACHE_DURATION) {
                    return data;
                }
            }
        } catch (e) {
            console.log('Cache read failed:', e);
        }
        return null;
    }

    /** @param {Object} stats */
    function setCachedStats(stats) {
        try {
            localStorage.setItem(CACHE_KEY, JSON.stringify({
                ...stats,
                timestamp: Date.now()
            }));
        } catch (e) {
            console.log('Cache write failed:', e);
        }
    }

    /** @param {string[]} proxies */
    async function fetchWithFallback(proxies) {
        for (let i = 0; i < proxies.length; i++) {
            try {
                const response = await fetch(proxies[i], {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                if (!response.ok) continue;
                const data = await response.json();
                const worldData = data.contents ? JSON.parse(data.contents) : data;
                return worldData;
            } catch (e) {
                console.log(`Proxy ${i + 1} failed:`, e);
                continue;
            }
        }
        throw new Error('All proxies failed');
    }

    /** @param {string} dateString */
    function formatDate(dateString) {
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (e) {
            return '--';
        }
    }

    /**
     * Update stat numbers with live data (no animation)
     * @param {Object} [worldData]
     */
    function updateTopStats(worldData) {
        /** @param {number} num */
        const formatNum = (num) => new Intl.NumberFormat().format(num);
        
        if (worldData) {
            const visitsEl = document.getElementById('stat-visits-top');
            const favoritesEl = document.getElementById('stat-favorites-top');
            
            if (visitsEl && worldData.visits) {
                visitsEl.textContent = formatNum(worldData.visits);
            }
            if (favoritesEl && worldData.favorites) {
                favoritesEl.textContent = formatNum(worldData.favorites);
            }
        }
    }

    /** @param {Object} worldData */
    function updateWorldStats(worldData) {
        /** @param {number} num */
        const formatNum = (num) => new Intl.NumberFormat().format(num);

        // World Stats section at bottom
        const visits = document.getElementById("stat-visits");
        const favorites = document.getElementById("stat-favorites");
        const popularity = document.getElementById("stat-popularity");
        const updated = document.getElementById("stat-updated");
        const created = document.getElementById("stat-created");

        if (visits) visits.textContent = formatNum(worldData.visits);
        if (favorites) favorites.textContent = formatNum(worldData.favorites || 0);
        if (popularity) popularity.textContent = formatNum(worldData.popularity || 0);
        if (updated) updated.textContent = formatDate(worldData.updated_at);
        if (created) created.textContent = formatDate(worldData.created_at);
    }

    // Try to load from cache first
    const cachedData = getCachedStats();

    // Fetch fresh data then update stats
    fetchWithFallback(corsProxies)
        .then(worldData => {
            updateTopStats(worldData);
            updateWorldStats(worldData);
            setCachedStats(worldData);
        })
        .catch(error => {
            console.log('All fetch attempts failed, using cached or default stats');
            const fallbackData = cachedData || defaultStats;
            updateTopStats(fallbackData);
            updateWorldStats(fallbackData);
            if (!cachedData) {
                setCachedStats(defaultStats);
            }
        });
});
</script>
