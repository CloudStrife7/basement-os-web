---
import BaseLayout from '../layouts/BaseLayout.astro';
import TerminalShell from '../components/TerminalShell.astro';
---

<BaseLayout title="BASEMENT OS">
  <TerminalShell activeSection="home">
    <div class="content-section active">
      <h2 class="section-header">C:\BASEMENT\HOME.TXT</h2>

      <div class="mission-statement">
        <h3>A 2000s Basement VRChat World</h3>
        <p>Xbox 360 achievements, retro DOS terminal, real-time weather, cross-platform VR. Lower Level 2.0 recreates the quintessential 2000s basement gaming atmosphere—complete with persistent progress tracking, dynamic weather effects, and an interactive DOS terminal that feels like coming home.</p>
      </div>

      <!-- PROJECT STATS -->
      <div class="info-card developer-only">
        <h3>[ Project Stats ]</h3>
        <div class="stats-grid-compact">
          <div class="stat-block-compact">
            <span class="stat-number-compact" id="stat-visits-top">936</span>
            <span class="stat-label-compact">VISITS</span>
          </div>
          <div class="stat-block-compact">
            <span class="stat-number-compact">20,000</span>
            <span class="stat-label-compact">LINES</span>
          </div>
          <div class="stat-block-compact">
            <span class="stat-number-compact">44</span>
            <span class="stat-label-compact">SCRIPTS</span>
          </div>
          <div class="stat-block-compact">
            <span class="stat-number-compact">19</span>
            <span class="stat-label-compact">ACHIEVEMENTS</span>
          </div>
          <div class="stat-block-compact">
            <span class="stat-number-compact">420</span>
            <span class="stat-label-compact">GAMERSCORE</span>
          </div>
          <div class="stat-block-compact">
            <span class="stat-number-compact" id="stat-favorites-top">68</span>
            <span class="stat-label-compact">FAVORITES</span>
          </div>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- THE STORY -->
      <div class="info-card developer-only">
        <h3>[ The Story ]</h3>
        <div class="devlog-content story-content">
          <p>Lower Level 2.0 started as a simple VRChat world and evolved into a 20,000+ line codebase built entirely with AI collaboration. From zero UdonSharp experience to a fully-featured achievement system, interactive DOS terminal, and real-time weather integration—all developed through systematic Claude Code workflows.</p>
          <p class="story-paragraph">The project demonstrates what's possible when combining modern AI tools with creative vision: persistent player data, cross-platform optimization, and a nostalgic 2000s basement aesthetic that feels like coming home.</p>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- SCREENSHOTS -->
      <div class="info-card">
        <h3>[ Screenshots ]</h3>
        <div class="screenshot-grid-compact">
          <div class="crt-screen screenshot-compact">
            <a href="/images/2026/01/basement-os-v2.png" target="_blank">
              <img src="/images/2026/01/basement-os-v2.png" alt="Basement OS V2" loading="lazy" />
            </a>
            <p class="screenshot-caption">OS VERSION 2</p>
          </div>
          <div class="crt-screen screenshot-compact">
            <a href="https://i.imgur.com/N8da6pU.jpeg" target="_blank">
              <img src="https://i.imgur.com/N8da6pU.jpeg" alt="The Gaming Area" loading="lazy" />
            </a>
            <p class="screenshot-caption">THE GAMING AREA</p>
          </div>
          <div class="crt-screen screenshot-compact">
            <a href="/images/2026/01/basement-view.png" target="_blank">
              <img src="/images/2026/01/basement-view.png" alt="Basement Perspective" loading="lazy" />
            </a>
            <p class="screenshot-caption">BASEMENT VIEW</p>
          </div>
          <div class="crt-screen screenshot-compact">
            <a href="https://i.imgur.com/Kpu5VSp.png" target="_blank">
              <img src="https://i.imgur.com/Kpu5VSp.png" alt="Achievement Notification" loading="lazy" />
            </a>
            <p class="screenshot-caption">NOTIFICATIONS</p>
          </div>
          <div class="crt-screen screenshot-compact">
            <a href="https://i.imgur.com/BOlvKfD.jpeg" target="_blank">
              <img src="https://i.imgur.com/BOlvKfD.jpeg" alt="Arcade and Theater" loading="lazy" />
            </a>
            <p class="screenshot-caption">ARCADE & THEATER</p>
          </div>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- CORE FEATURES -->
      <div class="info-card">
        <h3>[ Core Features ]</h3>
        <div class="features-grid-compact">
          <div class="feature-card-compact">
            <strong>Achievement System</strong>
            <ul>
              <li>19 achievements (420G)</li>
              <li>PlayerData persistence</li>
              <li>9 role-based tiers</li>
            </ul>
            <p class="feature-desc">Xbox 360-style popups that save your progress across sessions—earn them all and flex your Gamerscore.</p>
          </div>
          <div class="feature-card-compact">
            <strong>Basement OS</strong>
            <ul>
              <li>80-char DOS terminal</li>
              <li>14 Terminal Tales</li>
              <li>MUSIC.EXE player</li>
            </ul>
            <p class="feature-desc">A fully interactive retro terminal with short stories, a music player, and live world stats.</p>
          </div>
          <div class="feature-card-compact">
            <strong>Weather Integration</strong>
            <ul>
              <li>Live weather API</li>
              <li>Live weather sync</li>
              <li>Quest-optimized cache</li>
            </ul>
            <p class="feature-desc">Real-world weather synced to the basement—rain on the windows when it's raining outside.</p>
          </div>
          <div class="feature-card-compact">
            <strong>Network Sync</strong>
            <ul>
              <li>FIFO notification queue</li>
              <li>UdonSynced broadcast</li>
              <li>Role personalization</li>
            </ul>
            <p class="feature-desc">Everyone sees achievement unlocks in real-time—celebrate together when someone hits a milestone.</p>
          </div>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>



      <!-- LOWER LEVEL STATS -->
      <div class="info-card">
        <h3>[ Lower Level Stats ]</h3>
        <div class="stats-row-inline">
          <div class="stat-item">
            <span class="stat-label">Total Visits</span>
            <span class="stat-value" id="stat-visits">Loading...</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Favorites</span>
            <span class="stat-value" id="stat-favorites">--</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Popularity</span>
            <span class="stat-value" id="stat-popularity">--</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Last Updated</span>
            <span class="stat-value" id="stat-updated">--</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">First Uploaded</span>
            <span class="stat-value" id="stat-created">--</span>
          </div>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- CALL TO ACTION -->
      <div class="cta-section">
        <p class="cta-heading">Ready to visit?</p>

        <a href="https://vrchat.com/home/launch?worldId=wrld_7302897c-be0f-4037-ac67-76f0ea065c2b" class="cta-button" target="_blank">
          <span class="cta-icon">▶</span>
          <span>ENTER LOWER LEVEL 2.0</span>
        </a>

        <div class="platform-badges">
          <span class="platform-badge">PC VR</span>
          <span class="platform-badge">Meta Quest</span>
          <span class="platform-badge">Desktop</span>
        </div>

        <div class="cta-divider">─────────────────────────────</div>

        <!-- Tech Stack (boxed card) -->
        <div class="info-card tech-stack-card">
          <h3>[ Tech Stack ]</h3>
          <div class="badge-row centered">
            <a href="https://unity.com/releases/editor/whats-new/2022.3.22" class="dep-badge-sm unity" target="_blank">Unity 2022.3</a>
            <a href="https://developers.vrchat.com/sdk/" class="dep-badge-sm vrchat" target="_blank">VRChat SDK</a>
            <a href="https://udonsharp.docs.vrchat.com/" class="dep-badge-sm udon" target="_blank">UdonSharp</a>
            <a href="https://geom.io/bakery/" class="dep-badge-sm bakery" target="_blank">Bakery</a>
            <a href="https://github.com/pimaker/ltcgi" class="dep-badge-sm ltcgi" target="_blank">LTCGI</a>
            <a href="https://shaders.orels.sh/" class="dep-badge-sm orl" target="_blank">ORL Shaders</a>
            <a href="https://gitlab.com/techanon/protv" class="dep-badge-sm protv" target="_blank">ProTV</a>
          </div>
          <div class="badge-row centered">
            <a href="https://github.com/CyanLaser/CyanTrigger" class="dep-badge-sm cyan" target="_blank">CyanTrigger</a>
            <a href="https://github.com/oneVR/VRWorldToolkit" class="dep-badge-sm vrworld" target="_blank">VRWorld Toolkit</a>
            <a href="https://github.com/CoplayDev/unity-mcp" class="dep-badge-sm mcp" target="_blank">UnityMCP</a>
            <a href="https://claude.ai" class="dep-badge-sm claude" target="_blank">Claude Code</a>
            <span class="dep-badge-sm platform">PC VR | Quest</span>
          </div>
        </div>
      </div>

    </div>
  </TerminalShell>
</BaseLayout>

<style>
  /* Left-aligned routing header */
  .routing-header.left-align {
    text-align: left;
  }

  /* Compact Stats Grid - 6 items in one row */
  .stats-grid-compact {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 10px;
    text-align: center;
  }

  .stat-block-compact {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px 5px;
  }

  .stat-number-compact {
    font-size: 1.4em;
    font-weight: bold;
    color: var(--accent-primary);
    font-family: var(--font-mono);
    line-height: 1;
    margin-bottom: 4px;
  }

  .stat-label-compact {
    font-size: 0.6em;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-family: var(--font-mono);
  }

  /* Compact Screenshot Grid - 3 items in one row */
  .screenshot-grid-compact {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
  }

  .screenshot-compact {
    overflow: hidden;
  }

  .screenshot-compact img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    display: block;
    transition: transform 0.3s ease;
  }

  .screenshot-compact:hover img {
    transform: scale(1.05);
  }

  .screenshot-caption {
    text-align: center;
    color: var(--accent-primary);
    font-size: 0.7em;
    margin-top: 8px;
    letter-spacing: 1px;
  }

  /* Compact Features Grid - 4 items in one row */
  .features-grid-compact {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
  }

  .feature-card-compact {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    padding: 12px;
    font-size: 0.85em;
  }

  .feature-card-compact strong {
    display: block;
    color: var(--accent-primary);
    margin-bottom: 8px;
    font-size: 0.9em;
  }

  .feature-card-compact ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .feature-card-compact li {
    color: var(--text-secondary);
    padding: 2px 0;
    font-size: 0.85em;
  }

  .feature-card-compact li::before {
    content: "› ";
    color: var(--accent-primary);
  }

  .feature-desc {
    margin-top: 10px;
    padding-top: 8px;
    border-top: 1px solid var(--border);
    color: var(--text-muted);
    font-size: 0.8em;
    font-style: italic;
    line-height: 1.4;
  }



  /* Story Content Styles (replacing inline styles) */
  .story-content {
    margin-top: 10px;
  }

  .story-paragraph {
    margin-top: 15px;
  }

  /* Architecture Container */
  .architecture-container {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border);
    padding: 20px;
    margin-top: 10px;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
    overflow-x: auto;
  }

  .architecture-diagram {
    color: var(--accent-primary);
    font-family: var(--font-mono);
    font-size: 0.65em;
    line-height: 1.2;
    margin: 0;
    white-space: pre;
  }

  .cta-heading {
    color: var(--accent-primary);
    font-size: 1.1em;
    margin-bottom: 20px;
  }

  /* CTA Section */
  .cta-section {
    text-align: center;
    padding: 30px 0;
  }

  .cta-button {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: var(--accent-primary);
    color: #000;
    padding: 15px 30px;
    font-family: var(--font-mono);
    font-size: 1.1em;
    font-weight: bold;
    text-decoration: none;
    border: 2px solid var(--accent-primary);
    transition: all 0.3s ease;
  }

  .cta-button:hover {
    background: transparent;
    color: var(--accent-primary);
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
  }

  .cta-icon {
    font-size: 1.2em;
  }

  .platform-badges {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .platform-badge {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid var(--accent-primary);
    color: var(--accent-primary);
    padding: 5px 15px;
    font-family: var(--font-mono);
    font-size: 0.85em;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .stats-grid-compact {
      grid-template-columns: repeat(3, 1fr);
    }

    .features-grid-compact {
      grid-template-columns: repeat(2, 1fr);
    }

    .screenshot-grid-compact {
      grid-template-columns: repeat(3, 1fr);
    }

    .screenshot-compact img {
      height: 100px;
    }
  }

  @media (max-width: 600px) {
    .stats-grid-compact {
      grid-template-columns: repeat(3, 1fr);
    }

    .features-grid-compact {
      grid-template-columns: 1fr;
    }

    .screenshot-grid-compact {
      grid-template-columns: 1fr;
    }

    .screenshot-compact img {
      height: 150px;
    }

    .architecture-diagram {
      font-size: 0.45em;
    }
  }

  /* Inline Stats Row */
  .stats-row-inline {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: space-between;
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    flex: 1;
    min-width: 100px;
  }

  .stat-item .stat-label {
    font-size: 0.7em;
    color: var(--text-dim);
    margin-bottom: 4px;
  }

  .stat-item .stat-value {
    font-size: 1.1em;
    color: var(--accent-primary);
    font-weight: bold;
  }

  /* Dependency Badges */
  .badge-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 8px 0;
  }

  .dep-badge {
    display: inline-block;
    padding: 4px 10px;
    font-size: 0.75rem;
    font-family: var(--font-mono);
    border-radius: 3px;
    font-weight: bold;
    text-decoration: none;
    transition: opacity 0.2s, transform 0.2s;
  }

  .dep-badge:hover {
    opacity: 0.85;
    transform: translateY(-1px);
  }

  .dep-badge.unity { background: #222; color: #fff; border: 1px solid #555; }
  .dep-badge.vrchat { background: #1778f2; color: #fff; }
  .dep-badge.udon { background: #9b59b6; color: #fff; }
  .dep-badge.platform { background: #27ae60; color: #fff; }
  .dep-badge.bakery { background: #e67e22; color: #fff; }
  .dep-badge.gpu { background: #f1c40f; color: #222; }
  .dep-badge.cyan { background: #00bcd4; color: #222; }
  .dep-badge.ltcgi { background: #e91e63; color: #fff; }
  .dep-badge.orl { background: #3498db; color: #fff; }
  .dep-badge.protv { background: #2ecc71; color: #222; }
  .dep-badge.vrworld { background: #9c27b0; color: #fff; }
  .dep-badge.mcp { background: var(--accent-primary); color: #000; }
  .dep-badge.claude { background: #d4a574; color: #222; }

  /* Centered badge rows */
  .badge-row.centered {
    justify-content: center;
  }

  /* CTA Divider */
  .cta-divider {
    color: var(--text-dim);
    margin: 20px 0;
    font-size: 0.8em;
  }

  /* Tech Stack Card (boxed) */
  .tech-stack-card {
    margin-top: 0;
  }

  .tech-stack-card h3 {
    margin-bottom: 12px;
    text-align: left;
  }

  /* Smaller badges - unified theme matching platform badges */
  .dep-badge-sm {
    display: inline-block;
    padding: 3px 8px;
    font-size: 0.65rem;
    font-family: var(--font-mono);
    border-radius: 3px;
    font-weight: bold;
    text-decoration: none;
    transition: opacity 0.2s, transform 0.2s, background 0.2s;
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid var(--accent-primary);
    color: var(--accent-primary);
  }

  .dep-badge-sm:hover {
    opacity: 0.85;
    transform: translateY(-1px);
    background: rgba(16, 185, 129, 0.2);
  }
</style>

<script>
// VRChat Stats Fetcher with Caching
document.addEventListener("astro:page-load", function() {
    const worldId = "wrld_7302897c-be0f-4037-ac67-76f0ea065c2b";
    // NOTE: This is VRChat's PUBLIC API key used for unauthenticated world info requests.
    // It is intentionally public and documented in VRChat community resources.
    const apiKey = "JlE5Jldo5Jibnk5O5hTx6XVqsJyIkZVd";
    const CACHE_KEY = "vrchat-world-stats";
    const CACHE_DURATION = 10 * 60 * 1000; // 10 minutes

    // Default fallback stats
    const defaultStats = {
        visits: 937,
        favorites: 68,
        popularity: 4,
        updated_at: "2025-12-28T00:00:00.000Z",
        created_at: "2024-07-22T00:00:00.000Z",
        timestamp: Date.now()
    };

    const targetUrl = `https://api.vrchat.cloud/api/1/worlds/${worldId}?apiKey=${apiKey}`;
    const corsProxies = [
        `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`,
        `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`,
        `https://cors-anywhere.herokuapp.com/${targetUrl}`
    ];

    function getCachedStats() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const data = JSON.parse(cached);
                if (Date.now() - data.timestamp < CACHE_DURATION) {
                    return data;
                }
            }
        } catch (e) {
            console.log('Cache read failed:', e);
        }
        return null;
    }

    /** @param {Object} stats */
    function setCachedStats(stats) {
        try {
            localStorage.setItem(CACHE_KEY, JSON.stringify({
                ...stats,
                timestamp: Date.now()
            }));
        } catch (e) {
            console.log('Cache write failed:', e);
        }
    }

    /** @param {string[]} proxies */
    async function fetchWithFallback(proxies) {
        for (let i = 0; i < proxies.length; i++) {
            try {
                const response = await fetch(proxies[i], {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                if (!response.ok) continue;
                const data = await response.json();
                const worldData = data.contents ? JSON.parse(data.contents) : data;
                return worldData;
            } catch (e) {
                console.log(`Proxy ${i + 1} failed:`, e);
                continue;
            }
        }
        throw new Error('All proxies failed');
    }

    /** @param {string} dateString */
    function formatDate(dateString) {
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (e) {
            return '--';
        }
    }

    /**
     * Update stat numbers with live data (no animation)
     * @param {Object} [worldData]
     */
    function updateTopStats(worldData) {
        /** @param {number} num */
        const formatNum = (num) => new Intl.NumberFormat().format(num);
        
        if (worldData) {
            const visitsEl = document.getElementById('stat-visits-top');
            const favoritesEl = document.getElementById('stat-favorites-top');
            
            if (visitsEl && worldData.visits) {
                visitsEl.textContent = formatNum(worldData.visits);
            }
            if (favoritesEl && worldData.favorites) {
                favoritesEl.textContent = formatNum(worldData.favorites);
            }
        }
    }

    /** @param {Object} worldData */
    function updateWorldStats(worldData) {
        /** @param {number} num */
        const formatNum = (num) => new Intl.NumberFormat().format(num);

        // World Stats section at bottom
        const visits = document.getElementById("stat-visits");
        const favorites = document.getElementById("stat-favorites");
        const popularity = document.getElementById("stat-popularity");
        const updated = document.getElementById("stat-updated");
        const created = document.getElementById("stat-created");

        if (visits) visits.textContent = formatNum(worldData.visits);
        if (favorites) favorites.textContent = formatNum(worldData.favorites || 0);
        if (popularity) popularity.textContent = formatNum(worldData.popularity || 0);
        if (updated) updated.textContent = formatDate(worldData.updated_at);
        if (created) created.textContent = formatDate(worldData.created_at);
    }

    // Try to load from cache first
    const cachedData = getCachedStats();

    // Fetch fresh data then update stats
    fetchWithFallback(corsProxies)
        .then(worldData => {
            updateTopStats(worldData);
            updateWorldStats(worldData);
            setCachedStats(worldData);
        })
        .catch(error => {
            console.log('All fetch attempts failed, using cached or default stats');
            const fallbackData = cachedData || defaultStats;
            updateTopStats(fallbackData);
            updateWorldStats(fallbackData);
            if (!cachedData) {
                setCachedStats(defaultStats);
            }
        });
});
</script>
