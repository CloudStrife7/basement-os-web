---
import BaseLayout from '../layouts/BaseLayout.astro';
import TerminalShell from '../components/TerminalShell.astro';
---

<BaseLayout title="BASEMENT OS | Roadmap">
  <TerminalShell activeSection="roadmap">
    <div class="content-section active">
      <h2 class="section-header">C:\BASEMENT\ROADMAP.TXT</h2>

      <div class="mission-statement">
        <h3>Development Roadmap</h3>
        <p>Live project status synced from GitHub Issues every 6 hours. Track what's being worked on, what's coming next, and the full backlog.</p>
      </div>

      <!-- CURRENT FOCUS -->
      <div class="roadmap-section">
        <h3>[ Current Focus ]</h3>
        <p class="section-desc">High priority items actively being worked on</p>
        <div id="current-focus" class="issues-grid">
          <div class="loading-indicator">Loading from GitHub...</div>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- MILESTONES -->
      <div class="roadmap-section">
        <h3>[ Milestones ]</h3>
        <p class="section-desc">Major releases and feature sets</p>
        <div id="milestones" class="milestones-grid">
          <div class="loading-indicator">Loading from GitHub...</div>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- COMING SOON -->
      <div class="roadmap-section">
        <h3>[ Coming Soon ]</h3>
        <p class="section-desc">Medium priority - planned for upcoming releases</p>
        <div id="coming-soon" class="issues-grid">
          <div class="loading-indicator">Loading from GitHub...</div>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- BACKLOG -->
      <div class="roadmap-section">
        <h3>[ Backlog ]</h3>
        <p class="section-desc">Ideas and enhancements for the future</p>
        <div id="backlog" class="issues-grid collapsed">
          <div class="loading-indicator">Loading from GitHub...</div>
        </div>
        <button class="expand-btn" id="toggle-backlog">Show All Backlog Items</button>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- RECENTLY COMPLETED -->
      <div class="roadmap-section">
        <h3>[ Recently Completed ]</h3>
        <p class="section-desc">Shipped in the last 30 days</p>
        <div id="completed" class="issues-grid">
          <div class="loading-indicator">Loading from GitHub...</div>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <div class="cta-section">
        <p style="color: var(--text-secondary); margin-bottom: 15px;">Want to suggest a feature or report a bug?</p>
        <a href="mailto:admin@BasementOS.com" class="cta-button-small">
          <span>@</span>
          <span>E-MAIL ME</span>
        </a>
      </div>

    </div>
  </TerminalShell>
</BaseLayout>

<style>
  /* Roadmap section - NO box around it */
  .roadmap-section {
    margin-bottom: 10px;
  }

  .roadmap-section h3 {
    color: var(--accent-primary);
    font-size: 1.1em;
    margin-bottom: 5px;
  }

  .section-desc {
    color: var(--text-dim);
    font-size: 0.85em;
    margin-bottom: 15px;
    font-style: italic;
  }

  /* Issue Cards Grid */
  .issues-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px;
  }

  .issues-grid.collapsed {
    max-height: 400px;
    overflow: hidden;
    position: relative;
  }

  .issues-grid.collapsed::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 80px;
    background: linear-gradient(transparent, var(--bg-secondary));
    pointer-events: none;
  }

  /* Issue Card - structured layout like Tech Stack */
  .issue-card {
    background: var(--bg-secondary);
    border: 1px solid var(--accent-primary);
    border-radius: 4px;
    transition: all 0.3s ease;
    overflow: hidden;
    box-shadow: 0 0 8px rgba(0, 255, 204, 0.15);
  }

  .issue-card:hover {
    border-color: var(--accent-primary);
    box-shadow: 0 0 15px rgba(0, 255, 0, 0.1);
    transform: translateY(-2px);
  }

  .issue-card.completed {
    opacity: 0.8;
  }

  .issue-card.completed .issue-card-header {
    border-left: 3px solid var(--accent-primary);
  }

  .issue-card.priority-critical .issue-card-header {
    border-left: 3px solid #ff4444;
  }

  .issue-card.priority-high .issue-card-header {
    border-left: 3px solid #ff8844;
  }

  .issue-card.priority-medium .issue-card-header {
    border-left: 3px solid #ffcc44;
  }

  .issue-card.priority-low .issue-card-header {
    border-left: 3px solid var(--border-color);
  }

  /* Card Header */
  .issue-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 14px;
    background: rgba(0, 0, 0, 0.3);
    border-bottom: 1px solid var(--accent-primary);
  }

  .issue-status-icon {
    font-size: 0.9em;
  }

  .issue-status-icon.open {
    color: #44bb44;
  }

  .issue-status-icon.closed {
    color: var(--accent-primary);
  }

  .issue-title {
    color: var(--text-primary);
    font-size: 0.9em;
    font-weight: 500;
    line-height: 1.3;
    flex: 1;
  }

  .issue-number {
    color: var(--text-dim);
    font-size: 0.8em;
    white-space: nowrap;
  }

  /* Card Body - stat rows */
  .issue-card-body {
    padding: 10px 14px;
  }

  .issue-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px dotted var(--accent-primary);
    opacity: 0.8;
  }

  .issue-row:hover {
    opacity: 1;
  }

  .issue-row:last-child {
    border-bottom: none;
  }

  .issue-row-label {
    color: var(--text-dim);
    font-size: 0.8em;
    min-width: 70px;
  }

  .issue-row-value {
    color: var(--text-secondary);
    font-size: 0.85em;
    text-align: right;
    flex: 1;
  }

  .issue-row-value.priority-critical {
    color: #ff4444;
  }

  .issue-row-value.priority-high {
    color: #ff8844;
  }

  .issue-row-value.priority-medium {
    color: #ffcc44;
  }

  .issue-row-value.priority-low {
    color: var(--text-dim);
  }

  /* Labels in row */
  .issue-labels {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    justify-content: flex-end;
  }

  .issue-label {
    font-size: 0.7em;
    padding: 2px 6px;
    border-radius: 2px;
    font-weight: 500;
    text-transform: lowercase;
  }

  /* Milestone row value */
  .issue-milestone {
    color: var(--accent-primary);
    font-size: 0.85em;
  }

  /* Milestones */
  .milestones-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
  }

  .milestone-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 15px;
    transition: all 0.3s ease;
  }

  .milestone-card:hover {
    border-color: var(--accent-primary);
    box-shadow: 0 0 10px rgba(0, 255, 0, 0.1);
  }

  .milestone-title {
    color: var(--accent-primary);
    font-weight: bold;
    margin-bottom: 8px;
    font-size: 0.95em;
  }

  .milestone-progress {
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    margin-bottom: 8px;
    overflow: hidden;
  }

  .milestone-progress-bar {
    height: 100%;
    background: var(--accent-primary);
    transition: width 0.5s ease;
  }

  .milestone-stats {
    display: flex;
    justify-content: space-between;
    font-size: 0.8em;
    color: var(--text-dim);
  }

  /* Buttons */
  .expand-btn {
    margin-top: 15px;
    padding: 8px 15px;
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    font-family: var(--font-mono);
    font-size: 0.85em;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .expand-btn:hover {
    border-color: var(--accent-primary);
    color: var(--accent-primary);
  }

  .cta-button-small {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--accent-primary);
    color: #000;
    padding: 10px 20px;
    font-family: var(--font-mono);
    font-weight: bold;
    text-decoration: none;
    border: 2px solid var(--accent-primary);
    transition: all 0.3s ease;
  }

  .cta-button-small:hover {
    background: transparent;
    color: var(--accent-primary);
  }

  .cta-section {
    text-align: center;
    padding: 20px 0;
  }

  .loading-indicator {
    color: var(--text-dim);
    font-style: italic;
    padding: 20px;
    text-align: center;
    grid-column: 1 / -1;
  }

  .empty-state {
    color: var(--text-dim);
    font-style: italic;
    padding: 15px;
    text-align: center;
    grid-column: 1 / -1;
  }

  @media (max-width: 600px) {
    .issues-grid {
      grid-template-columns: 1fr;
    }

    .milestones-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
// Initialize roadmap - called by both astro:page-load and DOMContentLoaded
function initRoadmap() {
    // Prevent double initialization
    if ((window as any).__roadmapInitialized) return;
    (window as any).__roadmapInitialized = true;

    const ROADMAP_URL = '/data/roadmap.json';

    function getPriority(labels: any[]): string {
        const labelNames = labels.map(l => typeof l === 'string' ? l : l.name);
        if (labelNames.includes('priority: critical')) return 'critical';
        if (labelNames.includes('priority: high')) return 'high';
        if (labelNames.includes('priority: medium')) return 'medium';
        return 'low';
    }

    function getLabelColor(label: any): string {
        if (typeof label === 'object' && label.color) {
            return `#${label.color}`;
        }
        const name = typeof label === 'string' ? label : label.name;
        if (name === 'bug') return '#ff4444';
        if (name === 'enhancement') return '#44aa44';
        if (name === 'documentation') return '#0066cc';
        if (name.startsWith('area:')) return '#6666ff';
        if (name.startsWith('priority:')) return '#ffaa00';
        if (name === 'concept') return '#aa66cc';
        if (name === 'maintenance') return '#888888';
        if (name === 'needs-testing') return '#ff8800';
        return '#666666';
    }

    function getDisplayLabels(labels: any[]): any[] {
        return labels.filter(l => {
            const name = typeof l === 'string' ? l : l.name;
            return !name.startsWith('priority:');
        }).slice(0, 4);
    }

    function cleanTitle(title: string): string {
        return title.replace(/^\[.*?\]\s*/, '');
    }

    function formatPriority(priority: string): string {
        return priority.charAt(0).toUpperCase() + priority.slice(1);
    }

    function getTimeAgo(dateString: string): string {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now.getTime() - date.getTime();
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffDays === 0) return 'Today';
        if (diffDays === 1) return 'Yesterday';
        if (diffDays < 7) return `${diffDays} days ago`;
        if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
        if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
        return `${Math.floor(diffDays / 365)} years ago`;
    }

    function createIssueCard(issue: any, isCompleted = false): HTMLElement {
        const labels = issue.labels || [];
        const priority = getPriority(labels);
        const displayLabels = getDisplayLabels(labels);

        const card = document.createElement('div');
        card.className = `issue-card ${isCompleted ? 'completed' : `priority-${priority}`}`;

        // Build labels HTML
        const labelsHtml = displayLabels.length > 0
            ? displayLabels.map((l: any) => {
                const name = typeof l === 'string' ? l : l.name;
                const color = getLabelColor(l);
                const textColor = isLightColor(color) ? '#000' : '#fff';
                return `<span class="issue-label" style="background: ${color}; color: ${textColor}">${name.replace('area: ', '')}</span>`;
            }).join('')
            : '<span style="color: var(--text-dim); font-style: italic;">None</span>';

        // Build milestone row (only if exists)
        const milestoneRow = issue.milestone
            ? `<div class="issue-row">
                <span class="issue-row-label">Milestone</span>
                <span class="issue-row-value issue-milestone">${issue.milestone}</span>
               </div>`
            : '';

        // Status icon and text
        const statusIcon = isCompleted ? '✓' : '●';
        const statusClass = isCompleted ? 'closed' : 'open';
        const statusText = isCompleted ? 'Closed' : 'Open';

        card.innerHTML = `
            <div class="issue-card-header">
                <span class="issue-status-icon ${statusClass}">${statusIcon}</span>
                <span class="issue-title">${cleanTitle(issue.title)}</span>
                <span class="issue-number">#${issue.number}</span>
            </div>
            <div class="issue-card-body">
                <div class="issue-row">
                    <span class="issue-row-label">Status</span>
                    <span class="issue-row-value">${statusText}</span>
                </div>
                <div class="issue-row">
                    <span class="issue-row-label">Priority</span>
                    <span class="issue-row-value priority-${priority}">${formatPriority(priority)}</span>
                </div>
                <div class="issue-row">
                    <span class="issue-row-label">Labels</span>
                    <span class="issue-row-value"><div class="issue-labels">${labelsHtml}</div></span>
                </div>
                ${milestoneRow}
                <div class="issue-row">
                    <span class="issue-row-label">Created</span>
                    <span class="issue-row-value">${getTimeAgo(issue.created_at)}</span>
                </div>
            </div>
        `;

        return card;
    }

    function isLightColor(hex: string): boolean {
        const c = hex.replace('#', '');
        const r = parseInt(c.substr(0, 2), 16);
        const g = parseInt(c.substr(2, 2), 16);
        const b = parseInt(c.substr(4, 2), 16);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        return brightness > 155;
    }

    function createMilestoneElement(milestone: any): HTMLElement {
        const progress = milestone.open_issues + milestone.closed_issues > 0
            ? Math.round((milestone.closed_issues / (milestone.open_issues + milestone.closed_issues)) * 100)
            : 0;

        const div = document.createElement('div');
        div.className = 'milestone-card';
        div.innerHTML = `
            <div class="milestone-title">${milestone.title}</div>
            <div class="milestone-progress">
                <div class="milestone-progress-bar" style="width: ${progress}%"></div>
            </div>
            <div class="milestone-stats">
                <span>${milestone.closed_issues} done</span>
                <span>${milestone.open_issues} remaining</span>
                <span>${progress}%</span>
            </div>
        `;

        return div;
    }

    function renderData(data: any) {
        const { issues, milestones, closed } = data;

        const currentFocus = issues.filter((i: any) => {
            const labels = i.labels || [];
            const labelNames = labels.map((l: any) => typeof l === 'string' ? l : l.name);
            return labelNames.includes('priority: critical') || labelNames.includes('priority: high');
        });

        const comingSoon = issues.filter((i: any) => {
            const labels = i.labels || [];
            const labelNames = labels.map((l: any) => typeof l === 'string' ? l : l.name);
            return labelNames.includes('priority: medium');
        });

        const backlog = issues.filter((i: any) => {
            const labels = i.labels || [];
            const labelNames = labels.map((l: any) => typeof l === 'string' ? l : l.name);
            const priority = getPriority(labels);
            return priority === 'low' || (!labelNames.includes('priority: critical') && !labelNames.includes('priority: high') && !labelNames.includes('priority: medium'));
        });

        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const recentlyClosed = closed.filter((i: any) => {
            return i.closed_at && new Date(i.closed_at) > thirtyDaysAgo;
        });

        const currentFocusEl = document.getElementById('current-focus');
        if (currentFocusEl) {
            currentFocusEl.innerHTML = '';
            if (currentFocus.length === 0) {
                currentFocusEl.innerHTML = '<div class="empty-state">No high-priority items right now</div>';
            } else {
                currentFocus.forEach((issue: any) => currentFocusEl.appendChild(createIssueCard(issue)));
            }
        }

        const milestonesEl = document.getElementById('milestones');
        if (milestonesEl) {
            milestonesEl.innerHTML = '';
            const openMilestones = milestones.filter((m: any) => m.state === 'open');
            if (openMilestones.length === 0) {
                milestonesEl.innerHTML = '<div class="empty-state">No active milestones</div>';
            } else {
                openMilestones.forEach((m: any) => milestonesEl.appendChild(createMilestoneElement(m)));
            }
        }

        const comingSoonEl = document.getElementById('coming-soon');
        if (comingSoonEl) {
            comingSoonEl.innerHTML = '';
            if (comingSoon.length === 0) {
                comingSoonEl.innerHTML = '<div class="empty-state">No medium-priority items queued</div>';
            } else {
                comingSoon.forEach((issue: any) => comingSoonEl.appendChild(createIssueCard(issue)));
            }
        }

        const backlogEl = document.getElementById('backlog');
        if (backlogEl) {
            backlogEl.innerHTML = '';
            if (backlog.length === 0) {
                backlogEl.innerHTML = '<div class="empty-state">Backlog is empty</div>';
            } else {
                backlog.forEach((issue: any) => backlogEl.appendChild(createIssueCard(issue)));
            }
        }

        const completedEl = document.getElementById('completed');
        if (completedEl) {
            completedEl.innerHTML = '';
            if (recentlyClosed.length === 0) {
                completedEl.innerHTML = '<div class="empty-state">No issues closed in the last 30 days</div>';
            } else {
                recentlyClosed.slice(0, 10).forEach((issue: any) => completedEl.appendChild(createIssueCard(issue, true)));
            }
        }

        if (data.generated_at) {
            const syncTime = new Date(data.generated_at).toLocaleString();
            console.log(`Roadmap data last synced: ${syncTime}`);
        }
    }

    const toggleBtn = document.getElementById('toggle-backlog');
    const backlogList = document.getElementById('backlog');
    if (toggleBtn && backlogList) {
        toggleBtn.addEventListener('click', () => {
            backlogList.classList.toggle('collapsed');
            toggleBtn.textContent = backlogList.classList.contains('collapsed')
                ? 'Show All Backlog Items'
                : 'Collapse Backlog';
        });
    }

    fetch(ROADMAP_URL)
        .then(response => {
            if (!response.ok) throw new Error('Roadmap data not found');
            return response.json();
        })
        .then(data => {
            renderData(data);
        })
        .catch(error => {
            console.error('Failed to load roadmap:', error);
            document.querySelectorAll('.loading-indicator').forEach(el => {
                el.textContent = 'Roadmap data not yet synced';
            });
        });
}

// Reset flag on page swap (for view transitions)
document.addEventListener("astro:before-swap", () => {
    (window as any).__roadmapInitialized = false;
});

// Listen for both events to handle Astro 5.x edge cases
document.addEventListener("astro:page-load", initRoadmap);
document.addEventListener("DOMContentLoaded", initRoadmap);

// Also run immediately if DOM is already loaded (handles cached pages)
if (document.readyState !== 'loading') {
    initRoadmap();
}
</script>
