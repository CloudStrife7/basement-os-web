---
import BaseLayout from '../layouts/BaseLayout.astro';
import TerminalShell from '../components/TerminalShell.astro';
---

<BaseLayout title="BASEMENT OS | Showcase">
  <TerminalShell activeSection="about">
    <div class="content-section active">
      <h2 class="section-header">C:\BASEMENT\ABOUT.TXT</h2>

      <div class="mission-statement">
        <h3>A 2000s Basement VRChat World</h3>
        <p>Xbox 360 achievements, retro DOS terminal, real-time weather, cross-platform VR. Lower Level 2.0 recreates the quintessential 2000s basement gaming atmosphere—complete with persistent progress tracking, dynamic weather effects, and an interactive DOS terminal that feels like coming home.</p>
      </div>

      <!-- PROJECT STATS -->
      <div class="nav-routing">
        <h3 class="routing-header left-align">[ PROJECT STATS ]</h3>
        <div class="stats-grid-compact">
          <div class="stat-block-compact">
            <span class="stat-number-compact" id="stat-visits" data-target="936">0</span>
            <span class="stat-label-compact">VISITS</span>
          </div>
          <div class="stat-block-compact">
            <span class="stat-number-compact" data-target="18000">0</span>
            <span class="stat-label-compact">LINES</span>
          </div>
          <div class="stat-block-compact">
            <span class="stat-number-compact" data-target="47">0</span>
            <span class="stat-label-compact">SCRIPTS</span>
          </div>
          <div class="stat-block-compact">
            <span class="stat-number-compact" data-target="19">0</span>
            <span class="stat-label-compact">ACHIEVEMENTS</span>
          </div>
          <div class="stat-block-compact">
            <span class="stat-number-compact" data-target="420">0</span>
            <span class="stat-label-compact">GAMERSCORE</span>
          </div>
          <div class="stat-block-compact">
            <span class="stat-number-compact" id="stat-favorites" data-target="68">0</span>
            <span class="stat-label-compact">FAVORITES</span>
          </div>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- SCREENSHOTS -->
      <div class="nav-routing">
        <h3 class="routing-header left-align">[ SCREENSHOTS ]</h3>
        <div class="screenshot-grid-compact">
          <div class="crt-screen screenshot-compact">
            <a href="/images/2026/01/basement-os-v2.png" target="_blank">
              <img src="/images/2026/01/basement-os-v2.png" alt="Basement OS V2" loading="lazy" />
            </a>
            <p class="screenshot-caption">OS VERSION 2</p>
          </div>
          <div class="crt-screen screenshot-compact">
            <a href="https://i.imgur.com/N8da6pU.jpeg" target="_blank">
              <img src="https://i.imgur.com/N8da6pU.jpeg" alt="The Gaming Area" loading="lazy" />
            </a>
            <p class="screenshot-caption">THE GAMING AREA</p>
          </div>
          <div class="crt-screen screenshot-compact">
            <a href="/images/2026/01/basement-view.png" target="_blank">
              <img src="/images/2026/01/basement-view.png" alt="Basement Perspective" loading="lazy" />
            </a>
            <p class="screenshot-caption">BASEMENT VIEW</p>
          </div>
          <div class="crt-screen screenshot-compact">
            <a href="https://i.imgur.com/Kpu5VSp.png" target="_blank">
              <img src="https://i.imgur.com/Kpu5VSp.png" alt="Achievement Notification" loading="lazy" />
            </a>
            <p class="screenshot-caption">NOTIFICATIONS</p>
          </div>
          <div class="crt-screen screenshot-compact">
            <a href="https://i.imgur.com/BOlvKfD.jpeg" target="_blank">
              <img src="https://i.imgur.com/BOlvKfD.jpeg" alt="Arcade and Theater" loading="lazy" />
            </a>
            <p class="screenshot-caption">ARCADE & THEATER</p>
          </div>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- CORE FEATURES -->
      <div class="nav-routing">
        <h3 class="routing-header left-align">[ CORE FEATURES ]</h3>
        <div class="features-grid-compact">
          <div class="feature-card-compact">
            <strong>Achievement System</strong>
            <ul>
              <li>19 achievements (420G)</li>
              <li>PlayerData persistence</li>
              <li>7 role-based tiers</li>
            </ul>
          </div>
          <div class="feature-card-compact">
            <strong>Basement OS v29.1</strong>
            <ul>
              <li>80-char DOS terminal</li>
              <li>14 Terminal Tales</li>
              <li>MUSIC.EXE player</li>
            </ul>
          </div>
          <div class="feature-card-compact">
            <strong>Weather Integration</strong>
            <ul>
              <li>Live API + rain shader</li>
              <li>7 weather conditions</li>
              <li>Quest-optimized cache</li>
            </ul>
          </div>
          <div class="feature-card-compact">
            <strong>Network Sync</strong>
            <ul>
              <li>FIFO notification queue</li>
              <li>UdonSynced broadcast</li>
              <li>Role personalization</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- ARCHITECTURE -->
      <div class="nav-routing">
        <h3 class="routing-header left-align">[ ARCHITECTURE ]</h3>
        <div class="architecture-container">
          <pre class="architecture-diagram">
                 ┌─────────────────────────────────────────┐
                 │           User Interaction              │
                 └─────────────────────┬───────────────────┘
                                       │
              ┌────────────────────────┼────────────────────────┐
              │                        │                        │
              ▼                        ▼                        ▼
     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
     │  Achievement    │     │  DOS Terminal   │     │  Weather API    │
     │  Tracker        │     │  Controller     │     │  Integration    │
     └────────┬────────┘     └────────┬────────┘     └────────┬────────┘
              │                       │                       │
              │                       └───────────┬───────────┘
              │                                   │
              ▼                                   ▼
     ┌────────────────────────────────────────────────────────┐
     │           NotificationEventHub (Bridge)                │
     │  ─────────────────────────────────────────────────     │
     │  • Network Broadcasting                                │
     │  • Event Routing                                       │
     │  • Queue Management                                    │
     └────────────────────────────┬───────────────────────────┘
                                  │
                      ┌───────────┴───────────┐
                      │                       │
                      ▼                       ▼
            ┌─────────────────┐     ┌─────────────────┐
            │ XboxNotification│     │ Notification    │
            │ UI (FIFO)       │     │ Roles Module    │
            └────────┬────────┘     └─────────────────┘
                     │
                     ▼
            ┌─────────────────────────┐
            │ AchievementDataManager  │
            │ (VRChat PlayerData)     │
            └─────────────────────────┘
          </pre>
          <p style="text-align: center; color: var(--text-secondary); margin-top: 15px; font-style: italic;">Hub-spoke event-driven architecture optimized for VRChat's UdonSharp environment</p>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- TECH STACK & WORLD STATS -->
      <div class="info-grid">
        <div class="info-card">
          <h3>[ Tech Stack ]</h3>
          <div class="stat-row">
            <span class="stat-label">Engine</span>
            <span class="stat-value">Unity 2022.3.22f1</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">SDK</span>
            <span class="stat-value">VRChat SDK 3.8.2+</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Scripting</span>
            <span class="stat-value">UdonSharp 1.1+</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">UI</span>
            <span class="stat-value">TextMeshPro</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Remote Content</span>
            <span class="stat-value">GitHub Pages</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Platform</span>
            <span class="stat-value">PC VR + Quest</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Status</span>
            <span class="stat-value">Active Development</span>
          </div>
        </div>

        <div class="info-card">
          <h3>[ World Stats ]</h3>
          <div class="stat-row">
            <span class="stat-label">Total Visits</span>
            <span class="stat-value" id="stat-visits-2">Loading...</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Total Favorites</span>
            <span class="stat-value" id="stat-favorites-2">--</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Popularity</span>
            <span class="stat-value" id="stat-popularity">--</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Last Updated</span>
            <span class="stat-value" id="stat-updated">--</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">First Uploaded</span>
            <span class="stat-value" id="stat-created">--</span>
          </div>
        </div>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- THE STORY -->
      <h3 style="margin-top: 20px; margin-bottom: 15px;">The Story</h3>

      <div class="devlog-content">
        <p>Lower Level 2.0 started as a simple VRChat world and evolved into an 18,000+ line codebase built entirely with AI collaboration. From zero UdonSharp experience to a fully-featured achievement system, interactive DOS terminal, and real-time weather integration—all developed through systematic Claude Code workflows.</p>
        <p style="margin-top: 15px;">The project demonstrates what's possible when combining modern AI tools with creative vision: persistent player data, cross-platform optimization, and a nostalgic 2000s basement aesthetic that feels like coming home.</p>
      </div>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <!-- CALL TO ACTION -->
      <div class="cta-section">
        <p style="color: var(--accent-primary); font-size: 1.1em; margin-bottom: 20px;">Ready to visit?</p>

        <a href="https://vrchat.com/home/launch?worldId=wrld_7302897c-be0f-4037-ac67-76f0ea065c2b" class="cta-button" target="_blank">
          <span class="cta-icon">▶</span>
          <span>ENTER LOWER LEVEL 2.0</span>
        </a>

        <div class="platform-badges">
          <span class="platform-badge">PC VR</span>
          <span class="platform-badge">Meta Quest</span>
          <span class="platform-badge">Desktop</span>
        </div>

        <p style="color: var(--text-muted); font-size: 0.85em; margin-top: 20px;">Requires VRChat (PC VR or Meta Quest)</p>
      </div>

    </div>
  </TerminalShell>
</BaseLayout>

<style>
  /* Left-aligned routing header */
  .routing-header.left-align {
    text-align: left;
  }

  /* Compact Stats Grid - 6 items in one row */
  .stats-grid-compact {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 10px;
    text-align: center;
  }

  .stat-block-compact {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px 5px;
  }

  .stat-number-compact {
    font-size: 1.4em;
    font-weight: bold;
    color: var(--accent-primary);
    font-family: var(--font-mono);
    line-height: 1;
    margin-bottom: 4px;
  }

  .stat-label-compact {
    font-size: 0.6em;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-family: var(--font-mono);
  }

  /* Compact Screenshot Grid - 3 items in one row */
  .screenshot-grid-compact {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
  }

  .screenshot-compact {
    overflow: hidden;
  }

  .screenshot-compact img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    display: block;
    transition: transform 0.3s ease;
  }

  .screenshot-compact:hover img {
    transform: scale(1.05);
  }

  .screenshot-caption {
    text-align: center;
    color: var(--accent-primary);
    font-size: 0.7em;
    margin-top: 8px;
    letter-spacing: 1px;
  }

  /* Compact Features Grid - 4 items in one row */
  .features-grid-compact {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
  }

  .feature-card-compact {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    padding: 12px;
    font-size: 0.85em;
  }

  .feature-card-compact strong {
    display: block;
    color: var(--accent-primary);
    margin-bottom: 8px;
    font-size: 0.9em;
  }

  .feature-card-compact ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .feature-card-compact li {
    color: var(--text-secondary);
    padding: 2px 0;
    font-size: 0.85em;
  }

  .feature-card-compact li::before {
    content: "› ";
    color: var(--accent-primary);
  }

  /* Architecture Container */
  .architecture-container {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border);
    padding: 20px;
    margin-top: 10px;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
    overflow-x: auto;
  }

  .architecture-diagram {
    color: var(--accent-primary);
    font-family: var(--font-mono);
    font-size: 0.65em;
    line-height: 1.2;
    margin: 0;
    white-space: pre;
  }

  /* CTA Section */
  .cta-section {
    text-align: center;
    padding: 30px 0;
  }

  .cta-button {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: var(--accent-primary);
    color: #000;
    padding: 15px 30px;
    font-family: var(--font-mono);
    font-size: 1.1em;
    font-weight: bold;
    text-decoration: none;
    border: 2px solid var(--accent-primary);
    transition: all 0.3s ease;
  }

  .cta-button:hover {
    background: transparent;
    color: var(--accent-primary);
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
  }

  .cta-icon {
    font-size: 1.2em;
  }

  .platform-badges {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .platform-badge {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid var(--accent-primary);
    color: var(--accent-primary);
    padding: 5px 15px;
    font-family: var(--font-mono);
    font-size: 0.85em;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .stats-grid-compact {
      grid-template-columns: repeat(3, 1fr);
    }

    .features-grid-compact {
      grid-template-columns: repeat(2, 1fr);
    }

    .screenshot-grid-compact {
      grid-template-columns: repeat(3, 1fr);
    }

    .screenshot-compact img {
      height: 100px;
    }
  }

  @media (max-width: 600px) {
    .stats-grid-compact {
      grid-template-columns: repeat(3, 1fr);
    }

    .features-grid-compact {
      grid-template-columns: 1fr;
    }

    .screenshot-grid-compact {
      grid-template-columns: 1fr;
    }

    .screenshot-compact img {
      height: 150px;
    }

    .architecture-diagram {
      font-size: 0.45em;
    }
  }
</style>

<script>
// Number Spin-Up Animation
/**
 * @param {HTMLElement} element
 * @param {number} target
 * @param {number} [duration=1500]
 */
function animateNumber(element, target, duration = 1500) {
    const start = 0;
    const startTime = performance.now();
    /** @param {number} num */
    const formatNum = (num) => new Intl.NumberFormat().format(Math.floor(num));

    /** @param {number} currentTime */
    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);

        // Easing function for smooth deceleration
        const easeOut = 1 - Math.pow(1 - progress, 3);
        const current = start + (target - start) * easeOut;

        element.textContent = formatNum(current);

        if (progress < 1) {
            requestAnimationFrame(update);
        } else {
            // Final value with formatting
            element.textContent = formatNum(target);
        }
    }

    requestAnimationFrame(update);
}

// VRChat Stats Fetcher with Caching
document.addEventListener("astro:page-load", function() {
    const worldId = "wrld_7302897c-be0f-4037-ac67-76f0ea065c2b";
    const apiKey = "JlE5Jldo5Jibnk5O5hTx6XVqsJyIkZVd";
    const CACHE_KEY = "vrchat-world-stats";
    const CACHE_DURATION = 10 * 60 * 1000; // 10 minutes

    // Default fallback stats
    const defaultStats = {
        visits: 936,
        favorites: 68,
        popularity: 42,
        updated_at: "2025-12-28T00:00:00.000Z",
        created_at: "2024-07-08T00:00:00.000Z",
        timestamp: Date.now()
    };

    const targetUrl = `https://api.vrchat.cloud/api/1/worlds/${worldId}?apiKey=${apiKey}`;
    const corsProxies = [
        `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`,
        `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`,
        `https://cors-anywhere.herokuapp.com/${targetUrl}`
    ];

    function getCachedStats() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const data = JSON.parse(cached);
                if (Date.now() - data.timestamp < CACHE_DURATION) {
                    return data;
                }
            }
        } catch (e) {
            console.log('Cache read failed:', e);
        }
        return null;
    }

    /** @param {any} stats */
    function setCachedStats(stats) {
        try {
            localStorage.setItem(CACHE_KEY, JSON.stringify({
                ...stats,
                timestamp: Date.now()
            }));
        } catch (e) {
            console.log('Cache write failed:', e);
        }
    }

    /** @param {string[]} proxies */
    async function fetchWithFallback(proxies) {
        for (let i = 0; i < proxies.length; i++) {
            try {
                const response = await fetch(proxies[i], {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                if (!response.ok) continue;
                const data = await response.json();
                const worldData = data.contents ? JSON.parse(data.contents) : data;
                return worldData;
            } catch (e) {
                console.log(`Proxy ${i + 1} failed:`, e);
                continue;
            }
        }
        throw new Error('All proxies failed');
    }

    /** @param {string} dateString */
    function formatDate(dateString) {
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (e) {
            return '--';
        }
    }

    // Animate all stat numbers with spin-up effect
    /** @param {any} [worldData] */
    function runSpinUpAnimations(worldData) {
        const statNumbers = document.querySelectorAll('.stat-block-compact .stat-number-compact');
        statNumbers.forEach((el, index) => {
            const element = /** @type {HTMLElement} */ (el);
            let target = parseInt(element.dataset.target || '0', 10);

            // Override with live data for visits and favorites
            if (worldData) {
                if (element.id === 'stat-visits') {
                    target = worldData.visits || target;
                    element.dataset.target = target.toString();
                }
                if (element.id === 'stat-favorites') {
                    target = worldData.favorites || target;
                    element.dataset.target = target.toString();
                }
            }

            // Stagger the animations slightly
            setTimeout(() => {
                animateNumber(element, target, 1500);
            }, index * 100);
        });
    }

    /** @param {any} worldData */
    function updateWorldStats(worldData) {
        /** @param {number} num */
        const formatNum = (num) => new Intl.NumberFormat().format(num);

        // World Stats section at bottom
        const visits2 = document.getElementById("stat-visits-2");
        const favorites2 = document.getElementById("stat-favorites-2");
        const popularity = document.getElementById("stat-popularity");
        const updated = document.getElementById("stat-updated");
        const created = document.getElementById("stat-created");

        if (visits2) visits2.textContent = formatNum(worldData.visits);
        if (favorites2) favorites2.textContent = formatNum(worldData.favorites || 0);
        if (popularity) popularity.textContent = formatNum(worldData.popularity || 0);
        if (updated) updated.textContent = formatDate(worldData.updated_at);
        if (created) created.textContent = formatDate(worldData.created_at);
    }

    // Try to load from cache first
    const cachedData = getCachedStats();

    // Fetch fresh data then run animations
    fetchWithFallback(corsProxies)
        .then(worldData => {
            runSpinUpAnimations(worldData);
            updateWorldStats(worldData);
            setCachedStats(worldData);
        })
        .catch(error => {
            console.log('All fetch attempts failed, using cached or default stats');
            const fallbackData = cachedData || defaultStats;
            runSpinUpAnimations(fallbackData);
            updateWorldStats(fallbackData);
            if (!cachedData) {
                setCachedStats(defaultStats);
            }
        });
});
</script>
