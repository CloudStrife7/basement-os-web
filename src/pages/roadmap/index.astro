---
import BaseLayout from '../../layouts/BaseLayout.astro';
import TerminalShell from '../../components/TerminalShell.astro';
---

<BaseLayout title="BASEMENT OS | Roadmap">
  <TerminalShell activeSection="roadmap">
    <div class="content-section active">
      <h2 class="section-header">C:\BASEMENT\ROADMAP.TXT</h2>

      <div class="mission-statement">
        <h3>Development Roadmap</h3>
        <p>Live project status synced from GitHub Issues every 6 hours. Track what's being worked on, what's coming next, and the full backlog.</p>
      </div>

      <!-- CURRENT FOCUS -->
      <details class="roadmap-section section-primary" open>
        <summary>[ Current Focus ]</summary>
        <p class="section-desc">High priority items actively being worked on</p>
        <div id="current-focus" class="issues-grid">
          <div class="loading-indicator">Loading from GitHub...</div>
        </div>
      </details>

      <!-- MILESTONES -->
      <details class="roadmap-section section-primary">
        <summary>[ Milestones ]</summary>
        <p class="section-desc">Major releases and feature sets</p>
        <div id="milestones" class="milestones-grid">
          <div class="loading-indicator">Loading from GitHub...</div>
        </div>
      </details>

      <!-- COMING SOON -->
      <details class="roadmap-section section-secondary">
        <summary>[ Coming Soon ]</summary>
        <p class="section-desc">Medium priority - planned for upcoming releases</p>
        <div id="coming-soon" class="issues-grid">
          <div class="loading-indicator">Loading from GitHub...</div>
        </div>
      </details>

      <!-- BACKLOG -->
      <details class="roadmap-section section-muted">
        <summary>[ Backlog ]</summary>
        <p class="section-desc">Ideas and enhancements for the future</p>
        <div id="backlog" class="issues-grid">
          <div class="loading-indicator">Loading from GitHub...</div>
        </div>
      </details>

      <!-- RECENTLY COMPLETED -->
      <details class="roadmap-section section-completed">
        <summary>[ Recently Completed ]</summary>
        <p class="section-desc">Shipped in the last 30 days</p>
        <div id="completed" class="issues-grid">
          <div class="loading-indicator">Loading from GitHub...</div>
        </div>
      </details>

      <div class="separator">────────────────────────────────────────────────────────────────────</div>

      <div class="cta-section">
        <p style="color: var(--text-secondary); margin-bottom: 15px;">Want to suggest a feature or report a bug?</p>
        <a href="mailto:admin@BasementOS.com" class="cta-button-small">
          <span>@</span>
          <span>E-MAIL ME</span>
        </a>
      </div>

    </div>
  </TerminalShell>
</BaseLayout>

<style>
  /* Collapsible Roadmap Sections using details/summary */
  .roadmap-section {
    margin-bottom: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-secondary);
  }

  .roadmap-section summary {
    color: var(--accent-primary);
    font-size: 1em;
    font-weight: bold;
    padding: 10px 15px;
    cursor: pointer;
    list-style: none;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .roadmap-section summary::-webkit-details-marker {
    display: none;
  }

  .roadmap-section summary::after {
    content: '+';
    font-size: 1.2em;
    color: var(--text-dim);
  }

  .roadmap-section[open] summary::after {
    content: '−';
  }

  .roadmap-section[open] summary {
    border-bottom: 1px solid var(--border-color);
  }

  .roadmap-section .section-desc {
    color: var(--text-dim);
    font-size: 0.8em;
    margin: 0;
    padding: 8px 15px;
    font-style: italic;
  }

  .roadmap-section .issues-grid,
  .roadmap-section .milestones-grid {
    padding: 10px 15px 15px 15px;
  }

  /* Visual Hierarchy - Section variants */
  .section-primary summary {
    color: var(--accent-primary);
  }

  .section-secondary summary {
    color: var(--accent-secondary);
  }

  .section-secondary .issue-card {
    opacity: 0.9;
  }

  .section-muted summary {
    color: var(--text-dim);
  }

  .section-muted .issue-card {
    opacity: 0.75;
  }

  .section-completed summary {
    color: var(--accent-primary);
  }

  .section-completed .issue-card {
    opacity: 0.7;
  }

  /* Condensed Issue Cards Grid */
  .issues-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 8px;
  }

  /* Condensed Issue Card */
  .issue-card {
    padding: 10px !important;
    font-size: 0.8em;
  }

  .issue-card h3 {
    color: var(--accent-secondary);
    margin-bottom: 6px;
    font-size: 0.9em;
    line-height: 1.2;
  }

  .issue-card .stat-row {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    padding: 3px 0;
    border-bottom: 1px dotted var(--border-color);
    font-size: 0.9em;
  }

  .issue-card .stat-row:last-child {
    border-bottom: none;
  }

  .issue-card .stat-label {
    color: var(--text-dim);
    flex-shrink: 0;
    min-width: 55px;
  }

  .issue-card .stat-value {
    color: var(--accent-primary);
    text-align: right;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .issue-card .stat-value.priority-critical {
    color: #ff4444;
  }

  .issue-card .stat-value.priority-high {
    color: #ff8844;
  }

  .issue-card .stat-value.priority-medium {
    color: #ffcc44;
  }

  /* Smaller labels - auto-scale to fit */
  .issue-card .stat-row.labels-row {
    font-size: 0.5em;
  }

  .issue-card .stat-row.labels-row .stat-value {
    white-space: nowrap;
  }

  /* Milestone row */
  .issue-card .stat-row.milestone-row {
    font-size: clamp(0.6em, 0.75em, 0.85em);
  }

  .issue-card .stat-row.milestone-row .stat-value {
    white-space: nowrap;
  }

  /* Smaller created timestamp */
  .issue-card .stat-row.created-row {
    font-size: 0.75em;
    color: var(--text-dim);
  }

  /* Milestones */
  .milestones-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
  }

  .milestone-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 15px;
    transition: all 0.3s ease;
  }

  .milestone-card:hover {
    border-color: var(--accent-primary);
    box-shadow: 0 0 10px rgba(0, 255, 0, 0.1);
  }

  .milestone-title {
    color: var(--accent-primary);
    font-weight: bold;
    margin-bottom: 8px;
    font-size: 0.95em;
  }

  .milestone-progress {
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    margin-bottom: 8px;
    overflow: hidden;
  }

  .milestone-progress-bar {
    height: 100%;
    background: var(--accent-primary);
    transition: width 0.5s ease;
  }

  .milestone-stats {
    display: flex;
    justify-content: space-between;
    font-size: 0.8em;
    color: var(--text-dim);
  }

  /* Buttons */
  .expand-btn {
    margin-top: 15px;
    padding: 8px 15px;
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    font-family: var(--font-mono);
    font-size: 0.85em;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .expand-btn:hover {
    border-color: var(--accent-primary);
    color: var(--accent-primary);
  }

  .cta-button-small {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--accent-primary);
    color: #000;
    padding: 10px 20px;
    font-family: var(--font-mono);
    font-weight: bold;
    text-decoration: none;
    border: 2px solid var(--accent-primary);
    transition: all 0.3s ease;
  }

  .cta-button-small:hover {
    background: transparent;
    color: var(--accent-primary);
  }

  .cta-section {
    text-align: center;
    padding: 20px 0;
  }

  .loading-indicator {
    color: var(--text-dim);
    font-style: italic;
    padding: 20px;
    text-align: center;
    grid-column: 1 / -1;
  }

  .empty-state {
    color: var(--text-dim);
    font-style: italic;
    padding: 15px;
    text-align: center;
    grid-column: 1 / -1;
  }

  @media (max-width: 600px) {
    .issues-grid {
      grid-template-columns: 1fr;
    }

    .milestones-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
// Initialize roadmap - called by both astro:page-load and DOMContentLoaded
function initRoadmap() {
    // Prevent double initialization
    // @ts-ignore - Global window property
    if (window.__roadmapInitialized) return;
    // @ts-ignore - Global window property
    window.__roadmapInitialized = true;

    const ROADMAP_URL = '/data/roadmap.json';

    /** @param {any[]} labels @returns {string} */
    function getPriority(labels) {
        const labelNames = labels.map(l => typeof l === 'string' ? l : l.name);
        if (labelNames.includes('priority: critical')) return 'critical';
        if (labelNames.includes('priority: high')) return 'high';
        if (labelNames.includes('priority: medium')) return 'medium';
        return 'low';
    }

    /** @param {any} label @returns {string} */
    function getLabelColor(label) {
        if (typeof label === 'object' && label.color) {
            return `#${label.color}`;
        }
        const name = typeof label === 'string' ? label : label.name;
        if (name === 'bug') return '#ff4444';
        if (name === 'enhancement') return '#44aa44';
        if (name === 'documentation') return '#0066cc';
        if (name.startsWith('area:')) return '#6666ff';
        if (name.startsWith('priority:')) return '#ffaa00';
        if (name === 'concept') return '#aa66cc';
        if (name === 'maintenance') return '#888888';
        if (name === 'needs-testing') return '#ff8800';
        return '#666666';
    }

    /** @param {any[]} labels @returns {any[]} */
    function getDisplayLabels(labels) {
        return labels.filter(l => {
            const name = typeof l === 'string' ? l : l.name;
            return !name.startsWith('priority:');
        }).slice(0, 4);
    }

    /** @param {string} title @returns {string} */
    function cleanTitle(title) {
        return title.replace(/^\[.*?\]\s*/, '');
    }

    /** @param {string} priority @returns {string} */
    function formatPriority(priority) {
        return priority.charAt(0).toUpperCase() + priority.slice(1);
    }

    /** @param {string} dateString @returns {string} */
    function getTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now.getTime() - date.getTime();
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffDays === 0) return 'Today';
        if (diffDays === 1) return 'Yesterday';
        if (diffDays < 7) return `${diffDays} days ago`;
        if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
        if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
        return `${Math.floor(diffDays / 365)} years ago`;
    }

    /**
     * @param {any} issue
     * @param {boolean} [isCompleted=false]
     * @returns {HTMLElement}
     */
    function createIssueCard(issue, isCompleted = false) {
        const labels = issue.labels || [];
        const priority = getPriority(labels);
        const displayLabels = getDisplayLabels(labels);

        const card = document.createElement('div');
        // Use info-card class for proper styling
        card.className = `info-card issue-card ${isCompleted ? 'completed' : `priority-${priority}`}`;

        // Build labels HTML with brackets
        const labelsHtml = displayLabels.length > 0
            ? displayLabels.map((l) => {
                const name = typeof l === 'string' ? l : l.name;
                const cleanName = name.replace('area: ', '').toUpperCase();
                return `<span class="issue-label">[ ${cleanName} ]</span>`;
            }).join(' ')
            : '<span style="color: var(--text-dim); font-style: italic;">None</span>';

        // Status icon and text
        const statusIcon = isCompleted ? '✓' : '●';
        const statusClass = isCompleted ? 'closed' : 'open';
        const statusText = isCompleted ? 'Closed' : 'Open';

        // Build milestone row (only if exists)
        const milestoneRow = issue.milestone
            ? `<div class="stat-row milestone-row">
                <span class="stat-label">Milestone</span>
                <span class="stat-value">${issue.milestone}</span>
               </div>`
            : '';

        card.innerHTML = `
            <h3>[ ${cleanTitle(issue.title)} #${issue.number} ]</h3>
            <div class="stat-row">
                <span class="stat-label">Priority</span>
                <span class="stat-value priority-${priority}">${formatPriority(priority)}</span>
            </div>
            ${milestoneRow}
            <div class="stat-row created-row">
                <span class="stat-label">Created</span>
                <span class="stat-value">${getTimeAgo(issue.created_at)}</span>
            </div>
        `;

        return card;
    }

    /** @param {string} hex @returns {boolean} */
    function isLightColor(hex) {
        const c = hex.replace('#', '');
        const r = parseInt(c.substr(0, 2), 16);
        const g = parseInt(c.substr(2, 2), 16);
        const b = parseInt(c.substr(4, 2), 16);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        return brightness > 155;
    }

    /** @param {any} milestone @returns {HTMLElement} */
    function createMilestoneElement(milestone) {
        const progress = milestone.open_issues + milestone.closed_issues > 0
            ? Math.round((milestone.closed_issues / (milestone.open_issues + milestone.closed_issues)) * 100)
            : 0;

        const div = document.createElement('div');
        div.className = 'milestone-card';
        div.innerHTML = `
            <div class="milestone-title">${milestone.title}</div>
            <div class="milestone-progress">
                <div class="milestone-progress-bar" style="width: ${progress}%"></div>
            </div>
            <div class="milestone-stats">
                <span>${milestone.closed_issues} done</span>
                <span>${milestone.open_issues} remaining</span>
                <span>${progress}%</span>
            </div>
        `;

        return div;
    }

    /** @param {any} data */
    function renderData(data) {
        const { issues, milestones, closed } = data;

        const currentFocus = issues.filter((i) => {
            const labels = i.labels || [];
            const labelNames = labels.map((l) => typeof l === 'string' ? l : l.name);
            return labelNames.includes('priority: critical') || labelNames.includes('priority: high');
        });

        const comingSoon = issues.filter((i) => {
            const labels = i.labels || [];
            const labelNames = labels.map((l) => typeof l === 'string' ? l : l.name);
            return labelNames.includes('priority: medium');
        });

        const backlog = issues.filter((i) => {
            const labels = i.labels || [];
            const labelNames = labels.map((l) => typeof l === 'string' ? l : l.name);
            const priority = getPriority(labels);
            return priority === 'low' || (!labelNames.includes('priority: critical') && !labelNames.includes('priority: high') && !labelNames.includes('priority: medium'));
        });

        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const recentlyClosed = closed.filter((i) => {
            return i.closed_at && new Date(i.closed_at) > thirtyDaysAgo;
        });

        const currentFocusEl = document.getElementById('current-focus');
        if (currentFocusEl) {
            currentFocusEl.innerHTML = '';
            if (currentFocus.length === 0) {
                currentFocusEl.innerHTML = '<div class="empty-state">No high-priority items right now</div>';
            } else {
                currentFocus.forEach((issue) => currentFocusEl.appendChild(createIssueCard(issue)));
            }
        }

        const milestonesEl = document.getElementById('milestones');
        if (milestonesEl) {
            milestonesEl.innerHTML = '';
            const openMilestones = milestones.filter((m) => m.state === 'open');
            if (openMilestones.length === 0) {
                milestonesEl.innerHTML = '<div class="empty-state">No active milestones</div>';
            } else {
                openMilestones.forEach((m) => milestonesEl.appendChild(createMilestoneElement(m)));
            }
        }

        const comingSoonEl = document.getElementById('coming-soon');
        if (comingSoonEl) {
            comingSoonEl.innerHTML = '';
            if (comingSoon.length === 0) {
                comingSoonEl.innerHTML = '<div class="empty-state">No medium-priority items queued</div>';
            } else {
                comingSoon.forEach((issue) => comingSoonEl.appendChild(createIssueCard(issue)));
            }
        }

        const backlogEl = document.getElementById('backlog');
        if (backlogEl) {
            backlogEl.innerHTML = '';
            if (backlog.length === 0) {
                backlogEl.innerHTML = '<div class="empty-state">Backlog is empty</div>';
            } else {
                backlog.forEach((issue) => backlogEl.appendChild(createIssueCard(issue)));
            }
        }

        const completedEl = document.getElementById('completed');
        if (completedEl) {
            completedEl.innerHTML = '';
            if (recentlyClosed.length === 0) {
                completedEl.innerHTML = '<div class="empty-state">No issues closed in the last 30 days</div>';
            } else {
                recentlyClosed.slice(0, 10).forEach((issue) => completedEl.appendChild(createIssueCard(issue, true)));
            }
        }

        if (data.generated_at) {
            const syncTime = new Date(data.generated_at).toLocaleString();
            console.log(`Roadmap data last synced: ${syncTime}`);
        }
    }

    fetch(ROADMAP_URL)
        .then(response => {
            if (!response.ok) throw new Error('Roadmap data not found');
            return response.json();
        })
        .then(data => {
            renderData(data);
        })
        .catch(error => {
            console.error('Failed to load roadmap:', error);
            document.querySelectorAll('.loading-indicator').forEach(el => {
                el.textContent = 'Roadmap data not yet synced';
            });
        });
}

// Reset flag on page swap (for view transitions)
document.addEventListener("astro:before-swap", () => {
    // @ts-ignore - Global window property
    window.__roadmapInitialized = false;
});

// Listen for both events to handle Astro 5.x edge cases
document.addEventListener("astro:page-load", initRoadmap);
document.addEventListener("DOMContentLoaded", initRoadmap);

// Also run immediately if DOM is already loaded (handles cached pages)
if (document.readyState !== 'loading') {
    initRoadmap();
}
</script>
