---
interface Props {
  activeSection?: 'intro' | 'about' | 'devlog' | 'skills' | 'links';
}

const { activeSection = 'intro' } = Astro.props;
---

<div class="terminal-wrapper">
  <div class="terminal">
    <!-- Header -->
    <div class="terminal-header">
      <div class="window-controls">
        <span class="window-btn btn-close" id="btn-reboot" title="Reboot Me!"></span>
        <a href="/businesscards.html" class="window-btn btn-minimize" title="Back to Business Cards" style="display:block"></a>
        <span class="window-btn btn-maximize"></span>
      </div>
      <div class="terminal-title">BASEMENT OS</div>
      <div class="theme-selector">
        <label for="theme-select">THEME:</label>
        <select id="theme-select">
          <option value="high-contrast">High Contrast</option>
          <option value="synthwave">Synthwave</option>
          <option value="framer-dark">Framer Dark</option>
          <option value="framer-light">Framer Light</option>
          <option value="solarized-dark">Solarized Dark</option>
          <option value="solarized-light">Solarized Light</option>
          <option value="catppuccin">Catppuccin</option>
          <option value="monokai">Monokai</option>
          <option value="gruvbox-dark">Gruvbox Dark</option>
          <option value="gruvbox-light">Gruvbox Light</option>
          <option value="rose-pine">Rose Pine</option>
          <option value="rose-pine-dawn">Rose Pine Dawn</option>
          <option value="rose-pine-moon">Rose Pine Moon</option>
          <option value="cappuccino">Cappuccino</option>
        </select>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="nav-menu active" id="nav-menu">
      <a href="/" class={`nav-btn ${activeSection === 'intro' ? 'active' : ''}`}>
        <span class="type">&lt;BOOT&gt;</span> INTRO
      </a>
      <a href="/about" class={`nav-btn ${activeSection === 'about' ? 'active' : ''}`}>
        <span class="type">&lt;DIR&gt;</span> ABOUT
      </a>
      <a href="/devlog" class={`nav-btn ${activeSection === 'devlog' ? 'active' : ''}`}>
        <span class="type">&lt;LOG&gt;</span> DEVLOG
      </a>
      <a href="/skills" class={`nav-btn ${activeSection === 'skills' ? 'active' : ''}`}>
        <span class="type">&lt;AI&gt;</span> SKILLS
      </a>
      <a href="/links" class={`nav-btn ${activeSection === 'links' ? 'active' : ''}`}>
        <span class="type">&lt;NET&gt;</span> LINKS
      </a>
      <button class="nav-btn" id="search-toggle">
        <span class="type">&lt;CMD&gt;</span> SEARCH
      </button>
    </nav>

    <!-- Search Overlay -->
    <div class="search-container" id="search-container">
      <input type="text" class="search-input" id="search-input"
             placeholder="Search database..."
             autocomplete="off">
      <div class="search-results" id="search-results"></div>
    </div>

    <!-- AI Disclosure -->
    <div class="ai-disclosure" id="ai-disclosure">
      <div class="ai-disclosure-header">[ NEXT-GEN AI DEVLOG ]</div>
      <div class="ai-disclosure-content">
        Content Generated by Developer-Led AI Workflows. Reviewed by a Human-In-the-Loop.
      </div>
    </div>

    <!-- Boot Screen -->
    <div class="boot-screen" id="boot-screen" style="display:none"></div>

    <!-- Shutdown Screen -->
    <div id="shutdown-screen">
        <div class="shutdown-msg-1">Please wait while your computer shuts down...</div>
        <div class="shutdown-msg-2" style="color: #ff3e8a;">IT'S NOW SAFE TO TURN OFF YOUR COMPUTER</div>
    </div>

    <!-- Main Content Slot -->
    <div class="terminal-content active" id="main-content" transition:animate="fade">
      <slot />
    </div>

    <!-- Prompt & Status Bar -->
    <div class="prompt-line">
      <span class="prompt">C:\BASEMENT&gt;</span>
      <span class="cursor"></span>
    </div>

    <div class="status-bar">
      <span class="status-item">
        MEM: <span class="status-value">640K OK</span>
      </span>
      <span class="status-item">
        TIME: <span class="status-value" id="clock">00:00:00</span>
      </span>
      <span class="status-item">
        SYS: <span class="status-value">BASEMENT OS</span>
      </span>
    </div>
  </div>

  <footer class="terminal-footer">
    <p>&copy; 2025 <a href="https://github.com/CloudStrife7" class="link">CloudStrife7</a> | Lower Level 2.0</p>
  </footer>
</div>

<script>
  // Boot Sequence Configuration
  const BOOT_SEQUENCE = [
    { text: '════════════════════════════════════════════════════════════════════════════════', delay: 0 },
    { text: '', delay: 50 },
    { text: 'BASEMENT OS (Web Terminal)', delay: 100, class: 'text-secondary' },
    { text: '(C) 2025 CloudStrife7', delay: 150, class: 'text-dim' },
    { text: '', delay: 200 },
    { text: '════════════════════════════════════════════════════════════════════════════════', delay: 250 },
    { text: '', delay: 300 },
    { text: 'POST: Power-On Self Test...', delay: 400 },
    { text: '  Checking BIOS.................... OK', delay: 600, class: 'boot-ok' },
    { text: '  Memory Test: 640K................ OK', delay: 800, class: 'boot-ok' },
    { text: '  Display Adapter.................. OK', delay: 1000, class: 'boot-ok' },
    { text: '', delay: 1100 },
    { text: 'Loading Devlog...', delay: 1300 },
    { text: '  Connecting to GitHub............. OK', delay: 1500, class: 'boot-ok' },
    { text: '  Loading blog entries............. OK', delay: 1700, class: 'boot-ok' },
    { text: '  Initializing search.............. OK', delay: 1900, class: 'boot-ok' },
    { text: '', delay: 2000 },
    { text: '════════════════════════════════════════════════════════════════════════════════', delay: 2100 },
    { text: 'Boot complete. Welcome to Basement OS.', delay: 2300, class: 'boot-info' },
    { text: '════════════════════════════════════════════════════════════════════════════════', delay: 2500 },
  ];

  document.addEventListener('astro:page-load', () => {
      // Boot Logic
      const bootScreen = document.getElementById('boot-screen');
      const mainContent = document.getElementById('main-content');
      const navMenu = document.getElementById('nav-menu');
      const aiDisclosure = document.getElementById('ai-disclosure');
      
      let bootIndex = 0;

      function runBootSequence() {
          if (!bootScreen) return;
          
          if (bootIndex < BOOT_SEQUENCE.length) {
              const item = BOOT_SEQUENCE[bootIndex];
              const line = document.createElement('div');
              line.className = 'boot-line';
              if (item.class) line.classList.add(item.class);
              line.textContent = item.text;
              line.style.animationDelay = '0s';
              bootScreen.appendChild(line);
              bootIndex++;

              const nextDelay = bootIndex < BOOT_SEQUENCE.length
                  ? BOOT_SEQUENCE[bootIndex].delay - item.delay
                  : 500;
              setTimeout(runBootSequence, nextDelay);
          } else {
              setTimeout(() => {
                  bootScreen.style.display = 'none';
                  if (mainContent) mainContent.classList.add('active');
                  if (navMenu) navMenu.classList.add('active');
                  if (aiDisclosure) aiDisclosure.style.display = 'block';
              }, 800);
          }
      }

      // Check if already booted
      const hasBooted = sessionStorage.getItem('basement-os-booted');
      
      // Override for forced reboot (optional, for debugging)
      const urlParams = new URLSearchParams(window.location.search);
      const forceBoot = urlParams.get('boot') === 'true';

      if (!hasBooted || forceBoot) {
          // Start Boot
          if (bootScreen) {
              bootScreen.style.display = 'block';
              if (mainContent) mainContent.classList.remove('active');
              if (navMenu) navMenu.classList.remove('active');
              if (aiDisclosure) aiDisclosure.style.display = 'none';
              
              bootIndex = 0;
              bootScreen.innerHTML = ''; // clear previous if any
              runBootSequence();
              sessionStorage.setItem('basement-os-booted', 'true');
          }
      } else {
          // Ensure immediate display if already booted
           if (bootScreen) bootScreen.style.display = 'none';
           if (mainContent) mainContent.classList.add('active');
           if (navMenu) navMenu.classList.add('active');
           if (aiDisclosure) aiDisclosure.style.display = 'block';
      }

      // Theme Logic
      const THEMES = [
        'high-contrast', 'synthwave', 'framer-dark', 'framer-light',
        'solarized-dark', 'solarized-light', 'catppuccin',
        'monokai', 'gruvbox-dark', 'gruvbox-light',
        'rose-pine', 'rose-pine-dawn', 'rose-pine-moon', 'cappuccino'
      ];

      const themeSelect = document.getElementById('theme-select') as HTMLSelectElement;

      function setTheme(theme: string) {
        if (!THEMES.includes(theme)) theme = 'synthwave';
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('basement-os-theme', theme);
        if (themeSelect) themeSelect.value = theme;
      }

      if (themeSelect) {
        themeSelect.addEventListener('change', (e) => {
          setTheme((e.target as HTMLSelectElement).value);
        });
        // Set initial value
        const saved = localStorage.getItem('basement-os-theme') || 'synthwave';
        themeSelect.value = saved;
      }

      // Clock
      function updateClock() {
        const now = new Date();
        const time = now.toLocaleTimeString('en-US', { hour12: true });
        const clock = document.getElementById('clock');
        if (clock) clock.textContent = time;
      }
      
      // Clear existing interval to prevent duplicates on nav
      if ((window as any).clockInterval) clearInterval((window as any).clockInterval);
      (window as any).clockInterval = setInterval(updateClock, 1000);
      updateClock();

      // Reboot Logic
      const rebootBtn = document.getElementById('btn-reboot');
      const shutdownScreen = document.getElementById('shutdown-screen');
      
      if (rebootBtn && shutdownScreen) {
          rebootBtn.addEventListener('click', () => {
              // 1. Show waiting screen
              shutdownScreen.style.display = 'flex';
              document.body.style.cursor = 'wait';
              
              setTimeout(() => {
                  // 2. Show "Safe to turn off"
                  const msg1 = shutdownScreen.querySelector('.shutdown-msg-1') as HTMLElement;
                  const msg2 = shutdownScreen.querySelector('.shutdown-msg-2') as HTMLElement;
                  
                  if (msg1) msg1.style.display = 'none';
                  if (msg2) msg2.style.display = 'block';
                  
                  setTimeout(() => {
                      // 3. CRT Turn Off Animation
                      document.body.classList.add('crt-off');
                      
                      setTimeout(() => {
                          // 4. Reset and Reboot
                          sessionStorage.removeItem('basement-os-booted');
                          window.location.reload();
                      }, 1000); // Wait for CSS animation
                  }, 2000); // Read text duration
              }, 2000); // Shutdown wait duration
          });
      }

      // Search Logic
      const searchToggle = document.getElementById('search-toggle');
      const searchContainer = document.getElementById('search-container');
      const searchInput = document.getElementById('search-input') as HTMLInputElement;
      const searchResults = document.getElementById('search-results');

      if (searchToggle && searchContainer && searchInput) {
        searchToggle.addEventListener('click', () => {
            searchContainer.classList.toggle('active');
            if (searchContainer.classList.contains('active')) {
                searchInput.focus();
            }
        });

        // Close on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && searchContainer.classList.contains('active')) {
                searchContainer.classList.remove('active');
            }
        });

        // Perform Search
        searchInput.addEventListener('input', async (e) => {
            const query = (e.target as HTMLInputElement).value;
            if (query.length < 2) {
                if (searchResults) searchResults.innerHTML = '';
                return;
            }

            if (searchResults) searchResults.innerHTML = '<div class="searching">Searching database...</div>';

            try {
                if (import.meta.env.DEV) {
                    if (searchResults) {
                        searchResults.innerHTML = '<div class="result-error">Search index unavailable in DEV mode.<br>Run "npm run build" to test search.</div>';
                    }
                    return;
                }

                // dynamic import for pagefind (only works in prod/after build)
                // Use variable to avoid Vite analysis
                const pagefindUrl = '/pagefind/pagefind.js';
                // @ts-ignore
                const pagefind = await import(/* @vite-ignore */ pagefindUrl);
                const search = await pagefind.search(query);
                const results = await Promise.all(search.results.slice(0, 5).map((r: any) => r.data()));

                if (searchResults) {
                    if (results.length === 0) {
                        searchResults.innerHTML = '<div class="no-results">No matching records found.</div>';
                    } else {
                        searchResults.innerHTML = results.map((r: any) => `
                            <div class="search-result-item">
                                <a href="${r.url}">
                                    <div class="result-title">${r.meta.title}</div>
                                    <div class="result-excerpt">${r.excerpt}</div>
                                </a>
                            </div>
                        `).join('');
                    }
                }
            } catch (err) {
                console.log('Pagefind not loaded (dev mode)', err);
                if (searchResults) {
                     searchResults.innerHTML = `
                        <div class="result-error">
                            Search index unavailable in DEV mode.<br>
                            Run 'npm run build' to generate index.
                        </div>`;
                }
            }
        });
      }
  });
</script>
