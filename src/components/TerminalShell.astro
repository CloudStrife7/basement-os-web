---
interface Props {
  activeSection?: 'home' | 'devlog' | 'skills' | 'support' | 'roadmap';
}

const { activeSection = 'home' } = Astro.props;
---

<div class="terminal-wrapper">
  <div class="terminal">
    <!-- Header -->
    <div class="terminal-header">
      <div class="window-controls">
        <span class="window-btn btn-close" id="btn-reboot" title="Reboot Me!"></span>
        <a href="/businesscards.html" class="window-btn btn-minimize" title="Back to Business Cards" style="display:block"></a>
        <a href="/terminal" class="window-btn btn-maximize" title="Connect!" style="display:block"></a>
      </div>
      <div class="terminal-title">BASEMENT OS</div>
      <div class="theme-selector">
        <label for="theme-select">THEME:</label>
        <select id="theme-select">
          <option value="high-contrast">High Contrast</option>
          <option value="synthwave">Synthwave</option>
          <option value="framer-dark">Framer Dark</option>
          <option value="framer-light">Framer Light</option>
          <option value="solarized-dark">Solarized Dark</option>
          <option value="solarized-light">Solarized Light</option>
          <option value="catppuccin">Catppuccin</option>
          <option value="monokai">Monokai</option>
          <option value="gruvbox-dark">Gruvbox Dark</option>
          <option value="gruvbox-light">Gruvbox Light</option>
          <option value="rose-pine">Rose Pine</option>
          <option value="rose-pine-dawn">Rose Pine Dawn</option>
          <option value="rose-pine-moon">Rose Pine Moon</option>
          <option value="cappuccino">Cappuccino</option>
          <option value="basementos">BasementOS</option>
        </select>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="nav-menu active" id="nav-menu">
      <a href="/" class={`nav-btn ${activeSection === 'home' ? 'active' : ''}`}>
        <span class="type">&lt;BOOT&gt;</span> HOME
      </a>
      <a href="/devlog" class={`nav-btn ${activeSection === 'devlog' ? 'active' : ''}`}>
        <span class="type">&lt;LOG&gt;</span> DEVLOG
      </a>
      <a href="/skills" class={`nav-btn ${activeSection === 'skills' ? 'active' : ''}`}>
        <span class="type">&lt;AI&gt;</span> SKILLS
      </a>
      <a href="/support" class={`nav-btn ${activeSection === 'support' ? 'active' : ''}`}>
        <span class="type">&lt;NET&gt;</span> SUPPORT
      </a>
      <a href="/roadmap" class={`nav-btn ${activeSection === 'roadmap' ? 'active' : ''}`}>
        <span class="type">&lt;MAP&gt;</span> ROADMAP
      </a>
      <button class="nav-btn" id="terminal-toggle">
        <span class="type">&lt;SSH&gt;</span> TERMINAL
      </button>
      <a href="https://vrchat.com/home/launch?worldId=wrld_7302897c-be0f-4037-ac67-76f0ea065c2b" class="nav-btn" target="_blank">
        <span class="type">&lt;VRC&gt;</span> VISIT
      </a>
    </nav>

    <!-- Terminal Demo Container (inline, replaces main-content when active) -->
    <div class="terminal-demo-container" id="terminal-demo" style="display:none">
      <div class="terminal-demo-screen" id="terminal-demo-root"></div>
      <div class="terminal-disconnect" id="terminal-disconnect" style="display:none">
        <span class="disconnect-text">Disconnecting</span><span class="disconnect-dots" id="disconnect-dots"></span>
      </div>
    </div>

    <!-- AI Disclosure -->
    <div class="ai-disclosure" id="ai-disclosure">
      <div class="ai-disclosure-header">[ NEXT-GEN AI DEVLOG ]</div>
      <div class="ai-disclosure-content">
        Content Generated by Developer-Led AI Workflows. Reviewed by a Human-In-the-Loop.
      </div>
    </div>

    <!-- Boot Screen -->
    <div class="boot-screen" id="boot-screen" style="display:none"></div>

    <!-- Shutdown Screen -->
    <div id="shutdown-screen">
        <div class="shutdown-msg-1">Please wait while your computer shuts down...</div>
        <div class="shutdown-msg-2" style="color: #ff3e8a;">IT'S NOW SAFE TO TURN OFF YOUR COMPUTER</div>
    </div>

    <!-- Main Content Slot -->
    <div class="terminal-content active" id="main-content" transition:animate="fade">
      <slot />
    </div>

    <!-- Prompt & Status Bar -->
    <div class="prompt-line">
      <span class="prompt">C:\BASEMENT&gt;</span>
      <span class="cursor"></span>
    </div>

    <div class="status-bar">
      <span class="status-item">
        MEM: <span class="status-value">640K OK</span>
      </span>
      <span class="status-item">
        TIME: <span class="status-value" id="clock">00:00:00</span>
      </span>
      <span class="status-item">
        SYS: <span class="status-value">BASEMENT OS</span>
      </span>
    </div>
  </div>

  <footer class="terminal-footer">
    <p>&copy; 2025 <a href="https://github.com/CloudStrife7" class="link">CloudStrife7</a> | Lower Level 2.0</p>
  </footer>
</div>

<!-- Lightbox for devlog images -->
<div class="lightbox" id="lightbox">
  <button class="lightbox-close" id="lightbox-close">✕ CLOSE</button>
  <button class="lightbox-nav lightbox-prev" id="lightbox-prev">‹</button>
  <div class="lightbox-content">
    <img class="lightbox-image" id="lightbox-image" src="" alt="">
  </div>
  <button class="lightbox-nav lightbox-next" id="lightbox-next">›</button>
  <div class="lightbox-counter" id="lightbox-counter">1 / 1</div>
</div>

<script>
  // Boot Sequence Configuration
  const BOOT_SEQUENCE = [
    { text: '════════════════════════════════════════════════════════════════════════════════', delay: 0 },
    { text: '', delay: 50 },
    { text: 'BASEMENT OS (Web Terminal)', delay: 100, class: 'text-secondary' },
    { text: '(C) 2025 CloudStrife7', delay: 150, class: 'text-dim' },
    { text: '', delay: 200 },
    { text: '════════════════════════════════════════════════════════════════════════════════', delay: 250 },
    { text: '', delay: 300 },
    { text: 'POST: Power-On Self Test...', delay: 400 },
    { text: '  Checking BIOS.................... OK', delay: 600, class: 'boot-ok' },
    { text: '  Memory Test: 640K................ OK', delay: 800, class: 'boot-ok' },
    { text: '  Display Adapter.................. OK', delay: 1000, class: 'boot-ok' },
    { text: '', delay: 1100 },
    { text: 'Loading Devlog...', delay: 1300 },
    { text: '  Connecting to GitHub............. OK', delay: 1500, class: 'boot-ok' },
    { text: '  Loading blog entries............. OK', delay: 1700, class: 'boot-ok' },
    { text: '  Initializing search.............. OK', delay: 1900, class: 'boot-ok' },
    { text: '', delay: 2000 },
    { text: '════════════════════════════════════════════════════════════════════════════════', delay: 2100 },
    { text: 'Boot complete. Welcome to Basement OS.', delay: 2300, class: 'boot-info' },
    { text: '════════════════════════════════════════════════════════════════════════════════', delay: 2500 },
  ];

  document.addEventListener('astro:page-load', () => {
      // Boot Logic
      const bootScreen = document.getElementById('boot-screen');
      const mainContent = document.getElementById('main-content');
      const navMenu = document.getElementById('nav-menu');
      const aiDisclosure = document.getElementById('ai-disclosure');
      
      let bootIndex = 0;

      function runBootSequence() {
          if (!bootScreen) return;
          
          if (bootIndex < BOOT_SEQUENCE.length) {
              const item = BOOT_SEQUENCE[bootIndex];
              const line = document.createElement('div');
              line.className = 'boot-line';
              if (item.class) line.classList.add(item.class);
              line.textContent = item.text;
              line.style.animationDelay = '0s';
              bootScreen.appendChild(line);
              bootIndex++;

              const nextDelay = bootIndex < BOOT_SEQUENCE.length
                  ? BOOT_SEQUENCE[bootIndex].delay - item.delay
                  : 500;
              setTimeout(runBootSequence, nextDelay);
          } else {
              setTimeout(() => {
                  bootScreen.style.display = 'none';
                  if (mainContent) mainContent.classList.add('active');
                  if (navMenu) navMenu.classList.add('active');
                  if (aiDisclosure) aiDisclosure.style.display = 'block';
              }, 800);
          }
      }

      // Check if already booted
      const hasBooted = sessionStorage.getItem('basement-os-booted');
      
      // Override for forced reboot (optional, for debugging)
      const urlParams = new URLSearchParams(window.location.search);
      const forceBoot = urlParams.get('boot') === 'true';

      if (!hasBooted || forceBoot) {
          // Start Boot
          if (bootScreen) {
              bootScreen.style.display = 'block';
              if (mainContent) mainContent.classList.remove('active');
              if (navMenu) navMenu.classList.remove('active');
              if (aiDisclosure) aiDisclosure.style.display = 'none';
              
              bootIndex = 0;
              bootScreen.innerHTML = ''; // clear previous if any
              runBootSequence();
              sessionStorage.setItem('basement-os-booted', 'true');
          }
      } else {
          // Ensure immediate display if already booted
           if (bootScreen) bootScreen.style.display = 'none';
           if (mainContent) mainContent.classList.add('active');
           if (navMenu) navMenu.classList.add('active');
           if (aiDisclosure) aiDisclosure.style.display = 'block';
      }

      // Theme Logic
      const THEMES = [
        'high-contrast', 'synthwave', 'framer-dark', 'framer-light',
        'solarized-dark', 'solarized-light', 'catppuccin',
        'monokai', 'gruvbox-dark', 'gruvbox-light',
        'rose-pine', 'rose-pine-dawn', 'rose-pine-moon', 'cappuccino',
        'basementos'
      ];

      const themeSelect = document.getElementById('theme-select') as HTMLSelectElement;

      function setTheme(theme: string) {
        if (!THEMES.includes(theme)) theme = 'synthwave';
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('basement-os-theme', theme);
        if (themeSelect) themeSelect.value = theme;
      }

      // Apply saved theme immediately on page load
      const savedTheme = localStorage.getItem('basement-os-theme') || 'synthwave';
      setTheme(savedTheme);

      if (themeSelect) {
        themeSelect.addEventListener('change', (e) => {
          setTheme((e.target as HTMLSelectElement).value);
        });
      }

      // Clock
      function updateClock() {
        const now = new Date();
        const time = now.toLocaleTimeString('en-US', { hour12: true });
        const clock = document.getElementById('clock');
        if (clock) clock.textContent = time;
      }
      
      // Clear existing interval to prevent duplicates on nav
      if ((window as any).clockInterval) clearInterval((window as any).clockInterval);
      (window as any).clockInterval = setInterval(updateClock, 1000);
      updateClock();

      // Reboot Logic
      const rebootBtn = document.getElementById('btn-reboot');
      const shutdownScreen = document.getElementById('shutdown-screen');
      
      if (rebootBtn && shutdownScreen) {
          rebootBtn.addEventListener('click', () => {
              // 1. Show waiting screen
              shutdownScreen.style.display = 'flex';
              document.body.style.cursor = 'wait';
              
              setTimeout(() => {
                  // 2. Show "Safe to turn off"
                  const msg1 = shutdownScreen.querySelector('.shutdown-msg-1') as HTMLElement;
                  const msg2 = shutdownScreen.querySelector('.shutdown-msg-2') as HTMLElement;
                  
                  if (msg1) msg1.style.display = 'none';
                  if (msg2) msg2.style.display = 'block';
                  
                  setTimeout(() => {
                      // 3. Random Turn Off Animation
                      const animations = ['anim-crt', 'anim-vhs', 'anim-phosphor'];
                      const randomAnim = animations[Math.floor(Math.random() * animations.length)];
                      
                      // For CRT effect, we need to center the transform origin to the viewport
                      if (randomAnim === 'anim-crt') {
                          const scrollY = window.scrollY;
                          const viewportHeight = window.innerHeight;
                          const docHeight = document.body.scrollHeight;
                          const centerY = scrollY + (viewportHeight / 2);
                          
                          // Set origin to center of current viewport
                          document.body.style.transformOrigin = `50% ${centerY}px`;
                      }

                      document.body.classList.add(randomAnim);
                      
                      setTimeout(() => {
                          // 4. Reset and Reboot
                          sessionStorage.removeItem('basement-os-booted');
                          window.location.reload();
                      }, 2500); // Increased wait for slower animations (phosphor is 2.5s)
                  }, 2000); // Read text duration
              }, 2000); // Shutdown wait duration
          });
      }


      // Terminal Demo Logic
      const terminalToggle = document.getElementById('terminal-toggle');
      const terminalDemo = document.getElementById('terminal-demo');
      const terminalRoot = document.getElementById('terminal-demo-root');
      const terminalDisconnect = document.getElementById('terminal-disconnect');
      const disconnectDots = document.getElementById('disconnect-dots');
      
      let terminalInstance: any = null;
      let originalTheme: string | null = null;
      let originalActiveBtn: Element | null = null;
      let isTerminalActive = false;

      // Load terminal script dynamically
      function loadTerminalScript(): Promise<void> {
        return new Promise((resolve, reject) => {
          if ((window as any).BasementOSDemo) {
            resolve();
            return;
          }
          const script = document.createElement('script');
          script.src = '/js/basement-os-demo.js';
          script.onload = () => resolve();
          script.onerror = () => reject(new Error('Failed to load terminal script'));
          document.head.appendChild(script);
        });
      }

      async function openTerminal() {
        if (isTerminalActive) return;
        isTerminalActive = true;

        // Save current theme and fade to basementos
        originalTheme = localStorage.getItem('basement-os-theme') || 'synthwave';
        document.documentElement.style.transition = 'all 0.3s ease';
        document.documentElement.setAttribute('data-theme', 'basementos');

        // Update disclosure text for terminal mode
        const disclosureHeader = document.querySelector('.ai-disclosure-header');
        const disclosureContent = document.querySelector('.ai-disclosure-content');
        if (disclosureHeader) disclosureHeader.textContent = '[ BASEMENT OS SIMULATION ACTIVE ]';
        if (disclosureContent) disclosureContent.textContent = 'Terminal code simulates VRChat environment and is direct copy of C# Code modified for Web View. Navigate with ↑ ↓ ← → , Enter to select, Esc to go back.';

        // Hide main content, show terminal
        if (mainContent) mainContent.style.display = 'none';
        if (terminalDemo) terminalDemo.style.display = 'block';

        // Load and init terminal
        try {
          await loadTerminalScript();
          if (terminalRoot && (window as any).BasementOSDemo) {
            terminalInstance = new (window as any).BasementOSDemo('terminal-demo-root');
            (window as any).basementOSInstance = terminalInstance;
            terminalInstance.init();
          }
        } catch (e) {
          console.error('Terminal init error:', e);
        }

        // Mark terminal button as active - save and remove active from others first
        originalActiveBtn = document.querySelector('.nav-btn.active');
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        if (terminalToggle) terminalToggle.classList.add('active');
      }

      function closeTerminal() {
        if (!isTerminalActive) return;

        // Show disconnect animation
        if (terminalDisconnect && disconnectDots && terminalRoot) {
          terminalRoot.style.opacity = '0.3';
          terminalDisconnect.style.display = 'flex';
          
          // Animate dots: . -> .. -> ...
          let dotCount = 0;
          const dotInterval = setInterval(() => {
            dotCount++;
            if (disconnectDots) disconnectDots.textContent = '.'.repeat(dotCount);
            if (dotCount >= 3) {
              clearInterval(dotInterval);
              
              // After animation, clean up and show content
              setTimeout(() => {
                finishClose();
              }, 300);
            }
          }, 400);
        } else {
          finishClose();
        }
      }

      function finishClose() {
        // Destroy terminal instance
        if (terminalInstance && terminalInstance.destroy) {
          terminalInstance.destroy();
        }
        terminalInstance = null;
        (window as any).basementOSInstance = null;
        isTerminalActive = false;

        // Clear terminal container
        if (terminalRoot) {
          terminalRoot.innerHTML = '';
          terminalRoot.style.opacity = '1';
        }
        if (terminalDisconnect) terminalDisconnect.style.display = 'none';
        if (disconnectDots) disconnectDots.textContent = '';

        // Fade back to original theme
        if (originalTheme) {
          document.documentElement.setAttribute('data-theme', originalTheme);
        }

        // Restore disclosure text
        const disclosureHeader = document.querySelector('.ai-disclosure-header');
        const disclosureContent = document.querySelector('.ai-disclosure-content');
        if (disclosureHeader) disclosureHeader.textContent = '[ NEXT-GEN AI DEVLOG ]';
        if (disclosureContent) disclosureContent.textContent = 'Content Generated by Developer-Led AI Workflows. Reviewed by a Human-In-the-Loop.';

        // Show main content, hide terminal
        if (terminalDemo) terminalDemo.style.display = 'none';
        if (mainContent) mainContent.style.display = 'block';

        // Remove active state from terminal button and restore original
        if (terminalToggle) terminalToggle.classList.remove('active');
        if (originalActiveBtn) originalActiveBtn.classList.add('active');
      }

      // Terminal toggle click
      if (terminalToggle) {
        terminalToggle.addEventListener('click', () => {
          if (isTerminalActive) {
            closeTerminal();
          } else {
            openTerminal();
          }
        });
      }

      // Close terminal when clicking other nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.id !== 'terminal-toggle') {
          btn.addEventListener('click', () => {
            if (isTerminalActive) {
              closeTerminal();
            }
          });
        }
      });

      // ESC to close terminal (but not to interfere with terminal's internal ESC handling)
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isTerminalActive && terminalInstance?.currentApp === 'SHELL') {
          closeTerminal();
          e.preventDefault();
        }
      });

      // Typewriter Effect for Section Headers
      const headers = document.querySelectorAll('.section-header');
      headers.forEach(header => {
          // Prevent re-running on same element if already processed (though page-load usually resets DOM)
          if (header.classList.contains('typewriter-text')) return;

          const text = header.textContent || '';
          header.innerHTML = '<span class="typewriter-cursor"></span>';
          header.classList.add('typewriter-text');
          
          let index = 0;
          function typeChar() {
              if (index < text.length) {
                  header.innerHTML = text.substring(0, index + 1) + '<span class="typewriter-cursor"></span>';
                  index++;
                  setTimeout(typeChar, 50); // Speed for headers
              }
          }
          
          // Slight delay before starting to simulate "loading"
          setTimeout(typeChar, 200);
      });

      // Lightbox Logic for devlog images
      const lightbox = document.getElementById('lightbox');
      const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
      const lightboxClose = document.getElementById('lightbox-close');
      const lightboxPrev = document.getElementById('lightbox-prev');
      const lightboxNext = document.getElementById('lightbox-next');
      const lightboxCounter = document.getElementById('lightbox-counter');
      
      let currentImageIndex = 0;
      let devlogImages: HTMLImageElement[] = [];

      function openLightbox(index: number) {
          if (!lightbox || !lightboxImage || devlogImages.length === 0) return;
          
          currentImageIndex = index;
          lightboxImage.src = devlogImages[index].src;
          lightboxImage.alt = devlogImages[index].alt || 'Devlog image';
          lightbox.classList.add('active');
          document.body.style.overflow = 'hidden'; // Prevent scroll
          updateCounter();
      }

      function closeLightbox() {
          if (!lightbox) return;
          lightbox.classList.remove('active');
          document.body.style.overflow = '';
      }

      function showPrevImage() {
          if (devlogImages.length === 0) return;
          currentImageIndex = (currentImageIndex - 1 + devlogImages.length) % devlogImages.length;
          if (lightboxImage) {
              lightboxImage.src = devlogImages[currentImageIndex].src;
              lightboxImage.alt = devlogImages[currentImageIndex].alt || 'Devlog image';
          }
          updateCounter();
      }

      function showNextImage() {
          if (devlogImages.length === 0) return;
          currentImageIndex = (currentImageIndex + 1) % devlogImages.length;
          if (lightboxImage) {
              lightboxImage.src = devlogImages[currentImageIndex].src;
              lightboxImage.alt = devlogImages[currentImageIndex].alt || 'Devlog image';
          }
          updateCounter();
      }

      function updateCounter() {
          if (lightboxCounter) {
              lightboxCounter.textContent = `${currentImageIndex + 1} / ${devlogImages.length}`;
          }
      }

      // Collect images from devlog content AND main landing page (crt-screen)
      devlogImages = Array.from(document.querySelectorAll('.devlog-content img, .crt-screen img')) as HTMLImageElement[];
      devlogImages.forEach((img, index) => {
          img.style.cursor = 'pointer'; // Ensure pointer cursor
          img.addEventListener('click', (e) => {
              e.preventDefault(); // Prevent anchor links from opening
              openLightbox(index);
          });
      });

      // Event listeners
      if (lightboxClose) lightboxClose.addEventListener('click', closeLightbox);
      if (lightboxPrev) lightboxPrev.addEventListener('click', showPrevImage);
      if (lightboxNext) lightboxNext.addEventListener('click', showNextImage);
      
      // Close on background click
      if (lightbox) {
          lightbox.addEventListener('click', (e) => {
              if (e.target === lightbox) closeLightbox();
          });
      }

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
          if (!lightbox?.classList.contains('active')) return;
          
          if (e.key === 'Escape') closeLightbox();
          if (e.key === 'ArrowLeft') showPrevImage();
          if (e.key === 'ArrowRight') showNextImage();
      });
  });
</script>
