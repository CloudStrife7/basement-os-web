---
interface Props {
  activeSection?: 'home' | 'story' | 'devlog' | 'skills' | 'support' | 'achievements' | 'roadmap' | 'bifrost';
}

import ModeSelection from './ModeSelection.astro';

const { activeSection = 'home' } = Astro.props;
---

<div class="terminal-wrapper">
  <div class="terminal">
    <!-- Header -->
    <div class="terminal-header">
      <div class="window-controls">
        <span class="window-btn btn-close" id="btn-reboot" title="Reboot Me!"></span>
        <a href="/businesscards.html" class="window-btn btn-minimize" title="Back to Business Cards" style="display:block"></a>
        <a href="/egg-hunt" class="window-btn btn-maximize" title="???" style="display:block"></a>
      </div>
      <div class="terminal-title">BASEMENT OS</div>
      <div class="system-selectors">
        <div class="theme-selector">
          <label for="theme-select">THEME:</label>
          <select id="theme-select">
            <option value="high-contrast">High Contrast</option>
            <option value="synthwave">Synthwave</option>
            <option value="framer-dark">Framer Dark</option>
            <option value="framer-light">Framer Light</option>
            <option value="solarized-dark">Solarized Dark</option>
            <option value="solarized-light">Solarized Light</option>
            <option value="catppuccin">Catppuccin</option>
            <option value="monokai">Monokai</option>
            <option value="gruvbox-dark">Gruvbox Dark</option>
            <option value="gruvbox-light">Gruvbox Light</option>
            <option value="rose-pine">Rose Pine</option>
            <option value="rose-pine-dawn">Rose Pine Dawn</option>
            <option value="rose-pine-moon">Rose Pine Moon</option>
            <option value="cappuccino">Cappuccino</option>
            <option value="basementos">BasementOS</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="nav-menu active" id="nav-menu">
      <a href="/" class={`nav-btn ${activeSection === 'home' ? 'active' : ''}`}>
        <span class="type">&lt;BOOT&gt;</span> HOME
      </a>
      <a href="/story" class={`nav-btn developer-only ${activeSection === 'story' ? 'active' : ''}`}>
        <span class="type">&lt;OSx&gt;</span> MY STORY
      </a>
      <a href="/devlog" class={`nav-btn developer-only ${activeSection === 'devlog' ? 'active' : ''}`}>
        <span class="type">&lt;LOG&gt;</span> DEVLOG
      </a>
      <a href="/skills" class={`nav-btn developer-only ${activeSection === 'skills' ? 'active' : ''}`}>
        <span class="type">&lt;AI&gt;</span> SKILLS
      </a>
      <a href="/bifrost" class={`nav-btn developer-only ${activeSection === 'bifrost' ? 'active' : ''}`}>
        <span class="type">&lt;RUN&gt;</span> WORKFLOW
      </a>
      <a href="/support" class={`nav-btn ${activeSection === 'support' ? 'active' : ''}`}>
        <span class="type">&lt;NET&gt;</span> SUPPORT
      </a>
      <a href="/achievements" class={`nav-btn ${activeSection === 'achievements' ? 'active' : ''}`}>
        <span class="type">&lt;360&gt;</span> ACHIEVEMENTS
      </a>
      <a href="/roadmap" id="roadmap-link" class={`nav-btn ${activeSection === 'roadmap' ? 'active' : ''}`}>
        <span class="type">&lt;MAP&gt;</span> ROADMAP
      </a>
      <button class="nav-btn" id="terminal-toggle">
        <span class="type">&lt;SSH&gt;</span> TERMINAL
      </button>
      <a href="https://vrchat.com/home/launch?worldId=wrld_7302897c-be0f-4037-ac67-76f0ea065c2b" class="nav-btn" target="_blank">
        <span class="type">&lt;VRC&gt;</span> VISIT
      </a>
    </nav>

    <!-- Terminal Demo Container (inline, replaces main-content when active) -->
    <div class="terminal-demo-container" id="terminal-demo" style="display:none">
      <div class="crt-mode-switcher" id="crt-mode-switcher">
        <button class="crt-mode-btn" data-crt-mode="off" title="No CRT effects">OFF</button>
        <button class="crt-mode-btn" data-crt-mode="css" title="CSS CRT effects">CRT</button>
      </div>
      <div class="terminal-demo-screen" id="terminal-demo-root"></div>
      <div class="terminal-disconnect" id="terminal-disconnect" style="display:none">
        <span class="disconnect-text">Disconnecting</span><span class="disconnect-dots" id="disconnect-dots"></span>
      </div>
    </div>

    <!-- AI Disclosure -->
    <div class="ai-disclosure" id="ai-disclosure">
      <div class="ai-disclosure-header">[ NEXT-GEN AI DEVLOG ]</div>
      <div class="ai-disclosure-content">
        Content Generated by Developer-Led AI Workflows. Reviewed by a Human-In-the-Loop.
      </div>
    </div>

    <!-- Boot Screen -->
    <div class="boot-screen" id="boot-screen" style="display:none"></div>

    <!-- Shutdown Screen -->
    <div id="shutdown-screen">
        <div class="shutdown-msg-1">Please wait while your computer shuts down...</div>
        <div class="shutdown-msg-2" style="color: #ff3e8a;">IT'S NOW SAFE TO TURN OFF YOUR COMPUTER</div>
    </div>

    <!-- Main Content Slot -->
    <div class="terminal-content active" id="main-content" transition:animate="fade">
      <slot />
    </div>

    <!-- Prompt & Status Bar -->
    <div class="prompt-line">
      <span class="prompt">C:\BASEMENT&gt;</span>
      <span class="cursor"></span>
    </div>

    <div class="status-bar">
      <span class="status-item mem-tooltip-container">
        MEM: <span class="status-value" id="visit-counter">64K OK</span>
        <div class="mem-tooltip" id="mem-tooltip">
          <div class="mem-tooltip-title">Memory = Page Views</div>
          <div class="mem-tooltip-row current"><span></span><span id="tooltip-current">64K</span><span id="tooltip-visits">0</span></div>
          <div class="mem-tooltip-divider"></div>
          <div class="mem-tooltip-row active-tier" data-tier="64K"><span class="tier-arrow"></span><span>64K</span><span>0-63</span></div>
          <div class="mem-tooltip-row" data-tier="128K"><span class="tier-arrow"></span><span>128K</span><span>64-127</span></div>
          <div class="mem-tooltip-row" data-tier="256K"><span class="tier-arrow"></span><span>256K</span><span>128-255</span></div>
          <div class="mem-tooltip-row" data-tier="512K"><span class="tier-arrow"></span><span>512K</span><span>256-511</span></div>
          <div class="mem-tooltip-row" data-tier="640K"><span class="tier-arrow"></span><span>640K</span><span>512-639</span></div>
          <div class="mem-tooltip-row" data-tier="1MB"><span class="tier-arrow"></span><span>1MB</span><span>640-1023</span></div>
          <div class="mem-tooltip-row" data-tier="2MB"><span class="tier-arrow"></span><span>2MB</span><span>1024-2047</span></div>
          <div class="mem-tooltip-row" data-tier="4MB"><span class="tier-arrow"></span><span>4MB</span><span>2048+</span></div>
        </div>
      </span>
      <span class="status-item">
        TIME: <span class="status-value" id="clock">00:00:00</span>
      </span>
      <span class="status-item">
        <label for="mode-select" style="margin-right: 5px;">MODE:</label>
        <select id="mode-select" class="status-mode-select" aria-label="Select Audience Mode">
          <option value="player">Player</option>
          <option value="developer">Developer</option>
          <option value="both">Both</option>
        </select>
      </span>
    </div>
  </div>

  <footer class="terminal-footer">
    <p>&copy; 2025 <a href="https://github.com/CloudStrife7" class="link">CloudStrife7</a> | Lower Level 2.0</p>
  </footer>
</div>

<ModeSelection />

<!-- Lightbox for devlog images -->
<div class="lightbox" id="lightbox">
  <button class="lightbox-close" id="lightbox-close">CLOSE</button>
  <button class="lightbox-nav lightbox-prev" id="lightbox-prev">&lt;</button>
  <div class="lightbox-content">
    <img class="lightbox-image" id="lightbox-image" src="" alt="">
  </div>
  <button class="lightbox-nav lightbox-next" id="lightbox-next">&gt;</button>
  <div class="lightbox-counter" id="lightbox-counter">1 / 1</div>
</div>

<!-- Scroll to Top Button -->
<button id="scroll-to-top" class="scroll-top-btn" aria-label="Scroll to top">
  <span class="scroll-arrow">^</span>
</button>

<style>
  /* Scroll to Top Button */
  .scroll-top-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 44px;
    height: 44px;
    background: var(--accent-primary);
    border: none;
    color: #000;
    font-size: 1.2em;
    cursor: pointer;
    border-radius: 50%;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.2s ease;
    z-index: 1000;
    font-family: var(--font-mono);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .scroll-top-btn .scroll-arrow {
    display: block;
    margin-bottom: 4px; /* Shift arrow up */
  }

  .scroll-top-btn.visible {
    opacity: 0.25;
    visibility: visible;
  }

  .scroll-top-btn.visible:hover {
    opacity: 1;
    transform: scale(1.1);
  }

  .scroll-top-btn:active {
    transform: scale(0.95);
  }

  /* Memory Tooltip */
  .mem-tooltip-container {
    position: relative;
  }

  .mem-tooltip {
    position: absolute;
    bottom: calc(100% + 10px);
    left: 0;
    background: rgba(0, 0, 0, 0.98);
    border: 1px solid var(--accent-primary);
    padding: 10px 12px;
    font-family: var(--font-mono);
    font-size: 0.7rem;
    white-space: nowrap;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
    box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
  }

  .mem-tooltip-container:hover .mem-tooltip {
    opacity: 1;
    visibility: visible;
  }

  .mem-tooltip-title {
    color: var(--accent-primary);
    font-weight: bold;
    margin-bottom: 8px;
    text-align: center;
  }

  .mem-tooltip-row {
    display: grid;
    grid-template-columns: 15px 50px 70px;
    gap: 5px;
    color: var(--text-secondary);
    padding: 2px 0;
  }

  .mem-tooltip-row.current {
    color: var(--accent-primary);
    font-weight: bold;
  }

  .mem-tooltip-divider {
    height: 1px;
    background: var(--border-color);
    margin: 6px 0;
  }

  /* System Selectors in Header */
  .system-selectors {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  /* Footer Mode Selector - Matches Header Theme Selector style */
  .status-mode-select {
    background: var(--bg-primary);
    color: var(--accent-primary);
    border: 1px solid var(--border-color);
    padding: 2px 5px; /* Slightly smaller padding for footer */
    font-family: var(--font-mono);
    font-size: 11px; /* Slightly smaller font for footer */
    border-radius: 2px;
    cursor: pointer;
    font-weight: bold;
    text-transform: uppercase;
    height: 24px; /* Fix height for alignment */
  }

  .status-mode-select:focus {
    outline: 1px solid var(--accent-primary);
    text-decoration: none;
  }

  .status-mode-select option {
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  /* CRT Mode Switcher */
  .crt-mode-switcher {
    position: absolute;
    top: 6px;
    right: 8px;
    z-index: 20;
    display: flex;
    gap: 2px;
    opacity: 0.5;
    transition: opacity 0.2s ease;
  }

  .crt-mode-switcher:hover {
    opacity: 1;
  }

  .crt-mode-btn {
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    font-family: var(--font-mono);
    font-size: 9px;
    padding: 2px 5px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.15s ease;
  }

  .crt-mode-btn:hover {
    color: var(--accent-primary);
    border-color: var(--accent-primary);
  }

  .crt-mode-btn.active {
    background: var(--accent-primary);
    color: #000;
    border-color: var(--accent-primary);
    font-weight: bold;
  }
</style>

<script>
  import { getSavedMode, setAudienceMode, updateDynamicLinks } from '../scripts/modeStore';

  // Boot Sequence Configuration
  const BOOT_SEQUENCE = [
    { text: '================================================================================', delay: 0 },
    { text: '', delay: 50 },
    { text: 'BASEMENT OS (Web Terminal)', delay: 100, class: 'text-secondary' },
    { text: '(C) 20XX GameFuel', delay: 150, class: 'text-dim' },
    { text: '', delay: 200 },
    { text: '================================================================================', delay: 250 },
    { text: '', delay: 300 },
    { text: 'POST: Power-On Self Test...', delay: 400 },
    { text: '  Checking BIOS.................... OK', delay: 600, class: 'boot-ok' },
    { text: '  Memory Test: 640K................ OK', delay: 800, class: 'boot-ok' },
    { text: '  Display Adapter.................. OK', delay: 1000, class: 'boot-ok' },
    { text: '', delay: 1100 },
    { text: 'Loading Devlog...', delay: 1300 },
    { text: '  Connecting to GitHub............. OK', delay: 1500, class: 'boot-ok' },
    { text: '  Loading blog entries............. OK', delay: 1700, class: 'boot-ok' },
    { text: '  Initializing search.............. OK', delay: 1900, class: 'boot-ok' },
    { text: '', delay: 2000 },
    { text: '================================================================================', delay: 2100 },
    { text: 'Boot complete. Welcome to Basement OS.', delay: 2300, class: 'boot-info' },
    { text: '================================================================================', delay: 2500 },
  ];

  document.addEventListener('astro:page-load', () => {
      // DOM References
      const bootScreen = document.getElementById('boot-screen');
      const mainContent = document.getElementById('main-content');
      const navMenu = document.getElementById('nav-menu');
      const aiDisclosure = document.getElementById('ai-disclosure');

      let bootIndex = 0;

      // =========================================================================
      // BOOT SEQUENCE FUNCTIONS (properly scoped at astro:page-load level)
      // =========================================================================

      /**
       * Completes the boot process by hiding boot screen and showing main content
       */
      function finishBoot() {
          setTimeout(() => {
              if (bootScreen) bootScreen.style.display = 'none';
              if (mainContent) mainContent.classList.add('active');
              if (navMenu) navMenu.classList.add('active');
              if (aiDisclosure) aiDisclosure.style.display = 'block';
          }, 800);
      }

      /**
       * Runs the login sequence after mode selection
       * Displays username based on selected mode, simulates password entry, and shows access granted
       * @param mode - The selected mode ('player', 'developer', or 'both')
       */
      function runLoginSequence(mode: string) {
          if (!bootScreen) {
              finishBoot();
              return;
          }

          // Determine username based on mode
          let username = 'guest';
          if (mode === 'player') username = 'player';
          else if (mode === 'developer') username = 'developer';
          else if (mode === 'both') username = 'admin';

          // Login sequence steps with timing
          const loginSteps = [
              { text: '', delay: 200 },
              { text: `[login: ${username}]`, delay: 600 },
              { text: 'password: *******', delay: 1800 },
              { text: 'Access Granted.', delay: 2600, class: 'boot-ok' },
              { text: '', delay: 3000 }
          ];

          let stepIndex = 0;

          function nextLoginStep() {
              if (stepIndex >= loginSteps.length) {
                  finishBoot();
                  return;
              }

              const step = loginSteps[stepIndex];
              const line = document.createElement('div');
              line.className = 'boot-line';
              if (step.class) line.classList.add(step.class);
              line.textContent = step.text;
              bootScreen?.appendChild(line);

              stepIndex++;

              const nextDelay = (stepIndex < loginSteps.length)
                  ? loginSteps[stepIndex].delay - step.delay
                  : 500;

              setTimeout(nextLoginStep, nextDelay);
          }

          nextLoginStep();
      }

      /**
       * Runs the main boot sequence, displaying POST messages and system checks
       * After boot sequence completes, triggers mode selection (if needed) then login sequence
       */
      function runBootSequence() {
          if (!bootScreen) return;

          if (bootIndex < BOOT_SEQUENCE.length) {
              const item = BOOT_SEQUENCE[bootIndex];
              const line = document.createElement('div');
              line.className = 'boot-line';
              if (item.class) line.classList.add(item.class);
              line.textContent = item.text;
              line.style.animationDelay = '0s';
              bootScreen.appendChild(line);
              bootIndex++;

              const nextDelay = bootIndex < BOOT_SEQUENCE.length
                  ? BOOT_SEQUENCE[bootIndex].delay - item.delay
                  : 500;
              setTimeout(runBootSequence, nextDelay);
          } else {
              // Boot sequence complete - check if mode selection is needed
              const hasSelectedMode = sessionStorage.getItem('basement-os-mode-selected');

              if (!hasSelectedMode) {
                  // Request mode selection overlay
                  window.dispatchEvent(new Event('basement-os-request-mode-selection'));

                  // Wait for mode selection to complete, then run login sequence
                  window.addEventListener('basement-os-mode-ready', (e: Event) => {
                      const customEvent = e as CustomEvent;
                      const mode = customEvent.detail?.mode || getSavedMode();
                      runLoginSequence(mode);
                  }, { once: true });
              } else {
                  // Mode already selected - skip to finish
                  finishBoot();
              }
          }
      }

      // =========================================================================
      // BOOT INITIALIZATION
      // =========================================================================

      const hasBooted = sessionStorage.getItem('basement-os-booted');
      const urlParams = new URLSearchParams(window.location.search);
      const forceBoot = urlParams.get('boot') === 'true';

      if (!hasBooted || forceBoot) {
          // Start Boot
          if (bootScreen) {
              bootScreen.style.display = 'block';
              if (mainContent) mainContent.classList.remove('active');
              if (navMenu) navMenu.classList.remove('active');
              if (aiDisclosure) aiDisclosure.style.display = 'none';

              bootIndex = 0;
              bootScreen.innerHTML = '';
              runBootSequence();
              sessionStorage.setItem('basement-os-booted', 'true');
          }
      } else {
          // Already booted - show content immediately
          if (bootScreen) bootScreen.style.display = 'none';
          if (mainContent) mainContent.classList.add('active');
          if (navMenu) navMenu.classList.add('active');
          if (aiDisclosure) aiDisclosure.style.display = 'block';
      }

      // =========================================================================
      // THEME LOGIC
      // =========================================================================

      const THEMES = [
        'high-contrast', 'synthwave', 'framer-dark', 'framer-light',
        'solarized-dark', 'solarized-light', 'catppuccin',
        'monokai', 'gruvbox-dark', 'gruvbox-light',
        'rose-pine', 'rose-pine-dawn', 'rose-pine-moon', 'cappuccino',
        'basementos'
      ];

      /** @type {HTMLSelectElement} */
      const themeSelect = /** @type {HTMLSelectElement} */ (document.getElementById('theme-select')) as HTMLSelectElement;

      function setTheme(theme: string) {
        if (!THEMES.includes(theme)) theme = 'synthwave';
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('basement-os-theme', theme);
        if (themeSelect) themeSelect.value = theme;
      }

      const savedTheme = localStorage.getItem('basement-os-theme') || 'synthwave';
      setTheme(savedTheme);

      if (themeSelect) {
        themeSelect.addEventListener('change', (e) => {
          setTheme((e.target as HTMLSelectElement).value);
        });
      }

      // =========================================================================
      // MODE LOGIC
      // =========================================================================

      const modeSelect = document.getElementById('mode-select') as HTMLSelectElement;

      /**
       * Updates the AI disclosure text based on the current audience mode.
       * Player mode shows a welcome message; developer/both shows the AI devlog notice.
       * Only updates when the terminal is NOT active (terminal has its own disclosure).
       */
      function updateDisclosureForMode(mode: string) {
        // Don't override disclosure when terminal is active (it has its own)
        const terminalDemoEl = document.getElementById('terminal-demo');
        if (terminalDemoEl && terminalDemoEl.style.display !== 'none') return;

        const disclosureHeader = document.querySelector('.ai-disclosure-header');
        const disclosureContent = document.querySelector('.ai-disclosure-content');
        if (!disclosureHeader || !disclosureContent) return;

        if (mode === 'player') {
          disclosureHeader.textContent = '[ WELCOME TO THE BASEMENT ]';
          disclosureContent.textContent = 'A 2000s basement VRChat world built to explore, chill, and unlock secrets.';
        } else {
          disclosureHeader.textContent = '[ NEXT-GEN AI DEVLOG ]';
          disclosureContent.textContent = 'Content Generated by Developer-Led AI Workflows. Reviewed by a Human-In-the-Loop.';
        }
      }

      // Sync header mode selector with saved mode
      if (modeSelect) {
        modeSelect.value = getSavedMode();
        modeSelect.addEventListener('change', (e) => {
          setAudienceMode((e.target as HTMLSelectElement).value as 'player' | 'developer' | 'both');
        });
      }

      // Update footer mode display and dynamic links on page load
      const currentMode = getSavedMode();
      updateDynamicLinks(currentMode);
      updateDisclosureForMode(currentMode);

      const statusMode = document.getElementById('status-mode');
      if (statusMode) {
          statusMode.textContent = currentMode.toUpperCase();
      }

      // Sync when mode changes from other places (like ModeSelection)
      window.addEventListener('basement-os-mode-change', (e: Event) => {
        const customEvent = e as CustomEvent;
        const mode = customEvent.detail.mode;
        if (modeSelect) modeSelect.value = mode;
        updateDisclosureForMode(mode);

        const statusModeEl = document.getElementById('status-mode');
        if (statusModeEl) {
            statusModeEl.textContent = mode.toUpperCase();
        }
      });

      // =========================================================================
      // CLOCK
      // =========================================================================

      function updateClock() {
        const now = new Date();
        const time = now.toLocaleTimeString('en-US', { hour12: true });
        const clock = document.getElementById('clock');
        if (clock) clock.textContent = time;
      }

      // @ts-ignore - Global window property for cleanup
      if (window.clockInterval) clearInterval(window.clockInterval);
      // @ts-ignore - Global window property for cleanup
      window.clockInterval = setInterval(updateClock, 1000);
      updateClock();

      // =========================================================================
      // REBOOT LOGIC
      // =========================================================================

      const rebootBtn = document.getElementById('btn-reboot');
      const shutdownScreen = document.getElementById('shutdown-screen');

      if (rebootBtn && shutdownScreen) {
          rebootBtn.addEventListener('click', () => {
              shutdownScreen.style.display = 'flex';
              document.body.style.cursor = 'wait';

              setTimeout(() => {
                  const msg1 = shutdownScreen.querySelector('.shutdown-msg-1') as HTMLElement;
                  const msg2 = shutdownScreen.querySelector('.shutdown-msg-2') as HTMLElement;

                  if (msg1) msg1.style.display = 'none';
                  if (msg2) msg2.style.display = 'block';

                  setTimeout(() => {
                      const animations = ['anim-crt', 'anim-vhs', 'anim-phosphor'];
                      const randomAnim = animations[Math.floor(Math.random() * animations.length)];

                      if (randomAnim === 'anim-crt') {
                          const scrollY = window.scrollY;
                          const viewportHeight = window.innerHeight;
                          const centerY = scrollY + (viewportHeight / 2);
                          document.body.style.transformOrigin = `50% ${centerY}px`;
                      }

                      document.body.classList.add(randomAnim);

                      setTimeout(() => {
                          sessionStorage.removeItem('basement-os-booted');
                          sessionStorage.removeItem('basement-os-mode-selected');
                          window.location.reload();
                      }, 2500);
                  }, 2000);
              }, 2000);
          });
      }

      // =========================================================================
      // TERMINAL DEMO LOGIC
      // =========================================================================

      const terminalToggle = document.getElementById('terminal-toggle');
      const terminalDemo = document.getElementById('terminal-demo');
      const terminalRoot = document.getElementById('terminal-demo-root');
      const terminalDisconnect = document.getElementById('terminal-disconnect');
      const disconnectDots = document.getElementById('disconnect-dots');

      let terminalInstance: any = null;
      let originalTheme: string | null = null;
      let originalActiveBtn: Element | null = null;
      let isTerminalActive = false;

      function loadTerminalScript(): Promise<void> {
        return new Promise((resolve, reject) => {
          // @ts-ignore - Global window property
          if (window.BasementOSDemo) {
            resolve();
            return;
          }
          const script = document.createElement('script');
          script.src = '/js/basement-os-demo.js';
          script.onload = () => resolve();
          script.onerror = () => reject(new Error('Failed to load terminal script'));
          document.head.appendChild(script);
        });
      }

      async function openTerminal() {
        if (isTerminalActive) return;
        isTerminalActive = true;

        originalTheme = localStorage.getItem('basement-os-theme') || 'synthwave';
        document.documentElement.style.transition = 'all 0.3s ease';
        document.documentElement.setAttribute('data-theme', 'basementos');

        const disclosureHeader = document.querySelector('.ai-disclosure-header');
        const disclosureContent = document.querySelector('.ai-disclosure-content');
        if (disclosureHeader) disclosureHeader.textContent = '[ BASEMENT OS SIMULATION ACTIVE ]';
        if (disclosureContent) disclosureContent.textContent = 'Terminal code simulates VRChat environment. Navigate with arrow keys, Enter to select, Esc to go back.';

        if (mainContent) mainContent.style.display = 'none';
        if (terminalDemo) terminalDemo.style.display = 'block';

        try {
          await loadTerminalScript();
          // @ts-ignore - Global window property
          if (terminalRoot && window.BasementOSDemo) {
            // @ts-ignore - Global window property
            terminalInstance = new window.BasementOSDemo('terminal-demo-root');
            // @ts-ignore - Global window property
            window.basementOSInstance = terminalInstance;
            terminalInstance.init();
          }
        } catch (e) {
          console.error('Terminal init error:', e);
        }

        // Notify CRT effects that terminal is ready
        window.dispatchEvent(new Event('basement-os-terminal-opened'));

        originalActiveBtn = document.querySelector('.nav-btn.active');
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        if (terminalToggle) terminalToggle.classList.add('active');
      }

      function closeTerminal() {
        if (!isTerminalActive) return;

        if (terminalDisconnect && disconnectDots && terminalRoot) {
          terminalRoot.style.opacity = '0.3';
          terminalDisconnect.style.display = 'flex';

          let dotCount = 0;
          const dotInterval = setInterval(() => {
            dotCount++;
            if (disconnectDots) disconnectDots.textContent = '.'.repeat(dotCount);
            if (dotCount >= 3) {
              clearInterval(dotInterval);
              setTimeout(() => {
                finishCloseTerminal();
              }, 300);
            }
          }, 400);
        } else {
          finishCloseTerminal();
        }
      }

      function finishCloseTerminal() {
        // Notify CRT effects to clean up before terminal teardown
        window.dispatchEvent(new Event('basement-os-terminal-closing'));

        if (terminalInstance && terminalInstance.destroy) {
          terminalInstance.destroy();
        }
        terminalInstance = null;
        // @ts-ignore - Global window property
        window.basementOSInstance = null;
        isTerminalActive = false;

        if (terminalRoot) {
          terminalRoot.innerHTML = '';
          terminalRoot.style.opacity = '1';
        }
        if (terminalDisconnect) terminalDisconnect.style.display = 'none';
        if (disconnectDots) disconnectDots.textContent = '';

        if (originalTheme) {
          document.documentElement.setAttribute('data-theme', originalTheme);
        }

        // Restore disclosure based on current audience mode
        const restoredMode = getSavedMode();
        const disclosureHeader = document.querySelector('.ai-disclosure-header');
        const disclosureContent = document.querySelector('.ai-disclosure-content');
        if (disclosureHeader && disclosureContent) {
          if (restoredMode === 'player') {
            disclosureHeader.textContent = '[ WELCOME TO THE BASEMENT ]';
            disclosureContent.textContent = 'A 2000s basement VRChat world built to explore, chill, and unlock secrets.';
          } else {
            disclosureHeader.textContent = '[ NEXT-GEN AI DEVLOG ]';
            disclosureContent.textContent = 'Content Generated by Developer-Led AI Workflows. Reviewed by a Human-In-the-Loop.';
          }
        }

        if (terminalDemo) terminalDemo.style.display = 'none';
        if (mainContent) mainContent.style.display = 'block';

        if (terminalToggle) terminalToggle.classList.remove('active');
        if (originalActiveBtn) originalActiveBtn.classList.add('active');
      }

      if (terminalToggle) {
        terminalToggle.addEventListener('click', () => {
          if (isTerminalActive) {
            closeTerminal();
          } else {
            openTerminal();
          }
        });
      }

      document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.id !== 'terminal-toggle') {
          btn.addEventListener('click', () => {
            if (isTerminalActive) {
              closeTerminal();
            }
          });
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isTerminalActive && terminalInstance?.currentApp === 'SHELL') {
          closeTerminal();
          e.preventDefault();
        }
      });

      // =========================================================================
      // CRT EFFECTS MODE LOGIC
      // =========================================================================

      const crtSwitcher = document.getElementById('crt-mode-switcher');
      const crtButtons = crtSwitcher?.querySelectorAll('.crt-mode-btn');

      function getSavedCRTMode(): string {
        return localStorage.getItem('basement-os-crt') || 'css';
      }

      function saveCRTMode(mode: string) {
        localStorage.setItem('basement-os-crt', mode);
      }

      function updateCRTButtonState(mode: string) {
        crtButtons?.forEach(btn => {
          const btnEl = btn as HTMLElement;
          if (btnEl.dataset.crtMode === mode) {
            btnEl.classList.add('active');
          } else {
            btnEl.classList.remove('active');
          }
        });
      }

      function setCRTMode(mode: string) {
        const demoContainer = document.getElementById('terminal-demo');
        if (!demoContainer) return;

        demoContainer.classList.remove('crt-active');
        if (mode === 'css') {
          demoContainer.classList.add('crt-active');
        }

        saveCRTMode(mode);
        updateCRTButtonState(mode);
      }

      // Set up CRT mode button listeners
      crtButtons?.forEach(btn => {
        btn.addEventListener('click', (e) => {
          const mode = (e.currentTarget as HTMLElement).dataset.crtMode || 'off';
          setCRTMode(mode);
        });
      });

      // Initialize CRT mode state on button display (applied when terminal opens)
      updateCRTButtonState(getSavedCRTMode());

      // Apply saved CRT mode when terminal opens
      window.addEventListener('basement-os-terminal-opened', () => {
        const savedCRT = getSavedCRTMode();
        if (savedCRT !== 'off') {
          setCRTMode(savedCRT);
        }
      });

      // Clean up CRT effects when terminal closes
      window.addEventListener('basement-os-terminal-closing', () => {
        const demoContainer = document.getElementById('terminal-demo');
        if (demoContainer) demoContainer.classList.remove('crt-active');
      });

      // =========================================================================
      // TYPEWRITER EFFECT
      // =========================================================================

      const headers = document.querySelectorAll('.section-header');
      headers.forEach(header => {
          if (header.classList.contains('typewriter-text')) return;

          const text = header.textContent || '';
          header.innerHTML = '<span class="typewriter-cursor"></span>';
          header.classList.add('typewriter-text');

          let index = 0;
          function typeChar() {
              if (index < text.length) {
                  header.innerHTML = text.substring(0, index + 1) + '<span class="typewriter-cursor"></span>';
                  index++;
                  setTimeout(typeChar, 50);
              }
          }

          setTimeout(typeChar, 200);
      });

      // =========================================================================
      // LIGHTBOX LOGIC
      // =========================================================================

      const lightbox = document.getElementById('lightbox');
      const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
      const lightboxClose = document.getElementById('lightbox-close');
      const lightboxPrev = document.getElementById('lightbox-prev');
      const lightboxNext = document.getElementById('lightbox-next');
      const lightboxCounter = document.getElementById('lightbox-counter');

      let currentImageIndex = 0;
      let devlogImages: HTMLImageElement[] = [];

      function openLightbox(index: number) {
          if (!lightbox || !lightboxImage || devlogImages.length === 0) return;

          currentImageIndex = index;
          lightboxImage.src = devlogImages[index].src;
          lightboxImage.alt = devlogImages[index].alt || 'Devlog image';
          lightbox.classList.add('active');
          document.body.style.overflow = 'hidden';
          updateLightboxCounter();
      }

      function closeLightbox() {
          if (!lightbox) return;
          lightbox.classList.remove('active');
          document.body.style.overflow = '';
      }

      function showPrevImage() {
          if (devlogImages.length === 0) return;
          currentImageIndex = (currentImageIndex - 1 + devlogImages.length) % devlogImages.length;
          if (lightboxImage) {
              lightboxImage.src = devlogImages[currentImageIndex].src;
              lightboxImage.alt = devlogImages[currentImageIndex].alt || 'Devlog image';
          }
          updateLightboxCounter();
      }

      function showNextImage() {
          if (devlogImages.length === 0) return;
          currentImageIndex = (currentImageIndex + 1) % devlogImages.length;
          if (lightboxImage) {
              lightboxImage.src = devlogImages[currentImageIndex].src;
              lightboxImage.alt = devlogImages[currentImageIndex].alt || 'Devlog image';
          }
          updateLightboxCounter();
      }

      function updateLightboxCounter() {
          if (lightboxCounter) {
              lightboxCounter.textContent = `${currentImageIndex + 1} / ${devlogImages.length}`;
          }
      }

      devlogImages = Array.from(document.querySelectorAll('.devlog-content img, .crt-screen img')) as HTMLImageElement[];
      devlogImages.forEach((img, index) => {
          img.style.cursor = 'pointer';
          img.addEventListener('click', (e) => {
              e.preventDefault();
              openLightbox(index);
          });
      });

      if (lightboxClose) lightboxClose.addEventListener('click', closeLightbox);
      if (lightboxPrev) lightboxPrev.addEventListener('click', showPrevImage);
      if (lightboxNext) lightboxNext.addEventListener('click', showNextImage);

      if (lightbox) {
          lightbox.addEventListener('click', (e) => {
              if (e.target === lightbox) closeLightbox();
          });
      }

      document.addEventListener('keydown', (e) => {
          if (!lightbox?.classList.contains('active')) return;

          if (e.key === 'Escape') closeLightbox();
          if (e.key === 'ArrowLeft') showPrevImage();
          if (e.key === 'ArrowRight') showNextImage();
      });
  });

  // =========================================================================
  // SCROLL TO TOP BUTTON (separate listener)
  // =========================================================================

  document.addEventListener("astro:page-load", function() {
      const scrollBtn = document.getElementById('scroll-to-top');
      if (!scrollBtn) return;

      const SCROLL_THRESHOLD = 200;

      window.addEventListener('scroll', function() {
          if (window.scrollY > SCROLL_THRESHOLD) {
              scrollBtn.classList.add('visible');
          } else {
              scrollBtn.classList.remove('visible');
          }
      });

      scrollBtn.addEventListener('click', function() {
          window.scrollTo({
              top: 0,
              behavior: 'smooth'
          });
      });
  });

  // =========================================================================
  // PAGE VISIT COUNTER (separate listener)
  // =========================================================================

  document.addEventListener("astro:page-load", function() {
      const visitCounter = document.getElementById('visit-counter');
      if (!visitCounter) return;

      function getMemoryTier(visits: number): string {
          const tiers = [
              { threshold: 0, memory: '64K' },
              { threshold: 64, memory: '128K' },
              { threshold: 128, memory: '256K' },
              { threshold: 256, memory: '512K' },
              { threshold: 512, memory: '640K' },
              { threshold: 640, memory: '1MB' },
              { threshold: 1024, memory: '2MB' },
              { threshold: 2048, memory: '4MB' },
              { threshold: 4096, memory: '8MB' },
              { threshold: 8192, memory: '16MB' },
              { threshold: 16384, memory: '32MB' },
              { threshold: 32768, memory: '64MB' },
              { threshold: 65536, memory: '128MB' },
              { threshold: 131072, memory: '256MB' },
              { threshold: 262144, memory: '512MB' },
              { threshold: 524288, memory: '1GB' },
              { threshold: 1048576, memory: '2GB' },
              { threshold: 2097152, memory: '4GB' },
              { threshold: 4194304, memory: '8GB' },
              { threshold: 8388608, memory: '16GB' },
              { threshold: 16777216, memory: '32GB' },
          ];

          for (let i = tiers.length - 1; i >= 0; i--) {
              if (visits >= tiers[i].threshold) {
                  return tiers[i].memory;
              }
          }
          return '64K';
      }

      const namespace = 'basementos';
      const key = 'views';
      const cacheKey = 'basement-os-pageviews';
      const isProduction = window.location.hostname === 'basementos.com';

      function updateDisplay(count: number) {
          const memoryDisplay = getMemoryTier(count);
          visitCounter.textContent = `${memoryDisplay} OK`;

          const tooltipCurrent = document.getElementById('tooltip-current');
          const tooltipVisits = document.getElementById('tooltip-visits');
          if (tooltipCurrent) tooltipCurrent.textContent = memoryDisplay;
          if (tooltipVisits) tooltipVisits.textContent = count.toLocaleString() + ' views';

          const allTierRows = document.querySelectorAll('.mem-tooltip-row[data-tier]');
          allTierRows.forEach(row => {
              const tierArrow = row.querySelector('.tier-arrow');
              const rowEl = row as HTMLElement;
              if (rowEl.dataset.tier === memoryDisplay) {
                  row.classList.add('active-tier');
                  if (tierArrow) tierArrow.textContent = '>';
              } else {
                  row.classList.remove('active-tier');
                  if (tierArrow) tierArrow.textContent = '';
              }
          });
      }

      if (!isProduction) {
          const cached = localStorage.getItem(cacheKey);
          if (cached) updateDisplay(parseInt(cached, 10));
          return;
      }

      fetch(`https://api.counterapi.dev/v1/${namespace}/${key}/up`)
          .then(response => {
              if (!response.ok) throw new Error(`HTTP ${response.status}`);
              return response.json();
          })
          .then(data => {
              const count = data.count || 0;
              localStorage.setItem(cacheKey, String(count));
              updateDisplay(count);
          })
          .catch(() => {
              const cached = localStorage.getItem(cacheKey);
              if (cached) {
                  updateDisplay(parseInt(cached, 10));
              }
          });
  });
</script>
