---
interface Props {
  activeSection?: 'home' | 'story' | 'devlog' | 'skills' | 'support' | 'achievements' | 'roadmap';
}

import ModeSelection from './ModeSelection.astro';

const { activeSection = 'home' } = Astro.props;
---

<div class="terminal-wrapper">
  <div class="terminal">
    <!-- Header -->
    <header class="terminal-header">
      <div class="window-controls">
        <button class="window-btn btn-close" id="btn-reboot" title="Reboot Me!" aria-label="Reboot System"></button>
        <a href="/businesscards.html" class="window-btn btn-minimize" title="Back to Business Cards" aria-label="Minimize Window" style="display:block"></a>
        <a href="/egg-hunt" class="window-btn btn-maximize" title="???" aria-label="Maximize Window" style="display:block"></a>
      </div>
      <div class="terminal-title">BASEMENT OS</div>
      <div class="system-selectors">
        <div class="mode-selector-header">
          <label for="mode-select">MODE:</label>
          <select id="mode-select" aria-label="Select Audience Mode">
            <option value="player">Player</option>
            <option value="developer">Developer</option>
            <option value="both">Both</option>
          </select>
        </div>
        <div class="theme-selector">
          <label for="theme-select">THEME:</label>
          <select id="theme-select" aria-label="Select Color Theme">
            <option value="high-contrast">High Contrast</option>
            <option value="synthwave">Synthwave</option>
            <option value="framer-dark">Framer Dark</option>
            <option value="framer-light">Framer Light</option>
            <option value="solarized-dark">Solarized Dark</option>
            <option value="solarized-light">Solarized Light</option>
            <option value="catppuccin">Catppuccin</option>
            <option value="monokai">Monokai</option>
            <option value="gruvbox-dark">Gruvbox Dark</option>
            <option value="gruvbox-light">Gruvbox Light</option>
            <option value="rose-pine">Rose Pine</option>
            <option value="rose-pine-dawn">Rose Pine Dawn</option>
            <option value="rose-pine-moon">Rose Pine Moon</option>
            <option value="cappuccino">Cappuccino</option>
            <option value="basementos">BasementOS</option>
          </select>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="nav-menu active" id="nav-menu" aria-label="Main Navigation">
      <a href="/" class={`nav-btn ${activeSection === 'home' ? 'active' : ''}`}>
        <span class="type">&lt;BOOT&gt;</span> HOME
      </a>
      <a href="/story" class={`nav-btn ${activeSection === 'story' ? 'active' : ''}`}>
        <span class="type">&lt;OSx&gt;</span> MY STORY
      </a>
      <a href="/devlog" class={`nav-btn developer-only ${activeSection === 'devlog' ? 'active' : ''}`}>
        <span class="type">&lt;LOG&gt;</span> DEVLOG
      </a>
      <a href="/skills" class={`nav-btn developer-only ${activeSection === 'skills' ? 'active' : ''}`}>
        <span class="type">&lt;AI&gt;</span> SKILLS
      </a>
      <a href="/support" class={`nav-btn ${activeSection === 'support' ? 'active' : ''}`}>
        <span class="type">&lt;NET&gt;</span> SUPPORT
      </a>
      <a href="/achievements" class={`nav-btn ${activeSection === 'achievements' ? 'active' : ''}`}>
        <span class="type">&lt;360&gt;</span> ACHIEVEMENTS
      </a>
      <a href="/roadmap" id="roadmap-link" class={`nav-btn ${activeSection === 'roadmap' ? 'active' : ''}`}>
        <span class="type">&lt;MAP&gt;</span> ROADMAP
      </a>
      <button class="nav-btn" id="terminal-toggle" aria-label="Toggle Terminal Simulation">
        <span class="type">&lt;SSH&gt;</span> TERMINAL
      </button>
      <a href="https://vrchat.com/home/launch?worldId=wrld_7302897c-be0f-4037-ac67-76f0ea065c2b" class="nav-btn" target="_blank">
        <span class="type">&lt;VRC&gt;</span> VISIT
      </a>
    </nav>

    <!-- Terminal Demo Container (inline, replaces main-content when active) -->
    <div class="terminal-demo-container" id="terminal-demo" style="display:none" role="application" aria-label="Terminal Simulation">
      <div class="terminal-demo-screen" id="terminal-demo-root"></div>
      <div class="terminal-disconnect" id="terminal-disconnect" style="display:none">
        <span class="disconnect-text">Disconnecting</span><span class="disconnect-dots" id="disconnect-dots"></span>
      </div>
    </div>

    <!-- AI Disclosure -->
    <div class="ai-disclosure" id="ai-disclosure" role="status">
      <div class="ai-disclosure-header">[ NEXT-GEN AI DEVLOG ]</div>
      <div class="ai-disclosure-content">
        Content Generated by Developer-Led AI Workflows. Reviewed by a Human-In-the-Loop.
      </div>
    </div>

    <!-- Boot Screen -->
    <div class="boot-screen" id="boot-screen" style="display:none" role="status" aria-live="polite"></div>

    <!-- Shutdown Screen -->
    <div id="shutdown-screen" role="alert" aria-live="assertive">
        <div class="shutdown-msg-1">Please wait while your computer shuts down...</div>
        <div class="shutdown-msg-2" style="color: #ff3e8a;">IT'S NOW SAFE TO TURN OFF YOUR COMPUTER</div>
    </div>

    <!-- Main Content Slot -->
    <main class="terminal-content active" id="main-content" transition:animate="fade">
      <slot />
    </main>

    <!-- Prompt & Status Bar -->
    <div class="prompt-line" aria-hidden="true">
      <span class="prompt">C:\BASEMENT&gt;</span>
      <span class="cursor"></span>
    </div>

    <div class="status-bar" role="complementary" aria-label="System Status">
      <span class="status-item mem-tooltip-container">
        MEM: <span class="status-value" id="visit-counter">64K OK</span>
        <div class="mem-tooltip" id="mem-tooltip">
          <div class="mem-tooltip-title">üñ•Ô∏è Memory = Page Views</div>
          <div class="mem-tooltip-row current"><span>‚Üí</span><span id="tooltip-current">64K</span><span id="tooltip-visits">0</span></div>
          <div class="mem-tooltip-divider"></div>
          <div class="mem-tooltip-row active-tier" data-tier="64K"><span class="tier-arrow">‚Üí</span><span>64K</span><span>0-63</span></div>
          <div class="mem-tooltip-row" data-tier="128K"><span class="tier-arrow"></span><span>128K</span><span>64-127</span></div>
          <div class="mem-tooltip-row" data-tier="256K"><span class="tier-arrow"></span><span>256K</span><span>128-255</span></div>
          <div class="mem-tooltip-row" data-tier="512K"><span class="tier-arrow"></span><span>512K</span><span>256-511</span></div>
          <div class="mem-tooltip-row" data-tier="640K"><span class="tier-arrow"></span><span>640K</span><span>512-639</span></div>
          <div class="mem-tooltip-row" data-tier="1MB"><span class="tier-arrow"></span><span>1MB</span><span>640-1023</span></div>
          <div class="mem-tooltip-row" data-tier="2MB"><span class="tier-arrow"></span><span>2MB</span><span>1024-2047</span></div>
          <div class="mem-tooltip-row" data-tier="4MB"><span class="tier-arrow"></span><span>4MB</span><span>2048+</span></div>
        </div>
      </span>
      <span class="status-item">
        TIME: <span class="status-value" id="clock">00:00:00</span>
      </span>
      <span class="status-item">
        MODE: <span class="status-value" id="status-mode">...</span>
      </span>
    </div>
  </div>

  <footer class="terminal-footer">
    <p>&copy; 2025 <a href="https://github.com/CloudStrife7" class="link">CloudStrife7</a> | Lower Level 2.0</p>
  </footer>
</div>

<ModeSelection />

<!-- Lightbox for devlog images -->
<div class="lightbox" id="lightbox">
  <button class="lightbox-close" id="lightbox-close">‚úï CLOSE</button>
  <button class="lightbox-nav lightbox-prev" id="lightbox-prev">‚Äπ</button>
  <div class="lightbox-content">
    <img class="lightbox-image" id="lightbox-image" src="" alt="">
  </div>
  <button class="lightbox-nav lightbox-next" id="lightbox-next">‚Ä∫</button>
  <div class="lightbox-counter" id="lightbox-counter">1 / 1</div>
</div>

<!-- Scroll to Top Button -->
<button id="scroll-to-top" class="scroll-top-btn" aria-label="Scroll to top">
  <span class="scroll-arrow">‚ñ≤</span>
</button>

<style>
  /* Scroll to Top Button */
  .scroll-top-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 44px;
    height: 44px;
    background: var(--accent-primary);
    border: none;
    color: #000;
    font-size: 1.2em;
    cursor: pointer;
    border-radius: 50%;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.2s ease;
    z-index: 1000;
    font-family: var(--font-mono);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .scroll-top-btn .scroll-arrow {
    display: block;
    margin-bottom: 4px; /* Shift arrow up */
  }

  .scroll-top-btn.visible {
    opacity: 0.25;
    visibility: visible;
  }

  .scroll-top-btn.visible:hover {
    opacity: 1;
    transform: scale(1.1);
  }

  .scroll-top-btn:active {
    transform: scale(0.95);
  }

  /* Memory Tooltip */
  .mem-tooltip-container {
    position: relative;
  }

  .mem-tooltip {
    position: absolute;
    bottom: calc(100% + 10px);
    left: 0;
    background: rgba(0, 0, 0, 0.98);
    border: 1px solid var(--accent-primary);
    padding: 10px 12px;
    font-family: var(--font-mono);
    font-size: 0.7rem;
    white-space: nowrap;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
    box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
  }

  .mem-tooltip-container:hover .mem-tooltip {
    opacity: 1;
    visibility: visible;
  }

  .mem-tooltip-title {
    color: var(--accent-primary);
    font-weight: bold;
    margin-bottom: 8px;
    text-align: center;
  }

  .mem-tooltip-row {
    display: grid;
    grid-template-columns: 15px 50px 70px;
    gap: 5px;
    color: var(--text-secondary);
    padding: 2px 0;
  }

  .mem-tooltip-row.current {
    color: var(--accent-primary);
    font-weight: bold;
  }

  .system-selectors {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .mode-selector-header {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .mode-selector-header label {
    color: var(--text-dim);
    font-size: 12px;
  }

  .mode-selector-header select {
    background: var(--bg-primary);
    color: var(--accent-primary);
    border: 1px solid var(--border-color);
    padding: 5px 10px;
    font-family: var(--font-mono);
    font-size: 12px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
  }

  .mode-selector-header select:focus {
    outline: 1px solid var(--accent-primary);
  }

  .mem-tooltip-divider {
    height: 1px;
    background: var(--border-color);
    margin: 6px 0;
  }
</style>

<script>
  import { getSavedMode, setAudienceMode, updateDynamicLinks } from '../scripts/modeStore';

  // Boot Sequence Configuration
  const BOOT_SEQUENCE = [
    { text: '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', delay: 0 },
    { text: '', delay: 50 },
    { text: 'BASEMENT OS (Web Terminal)', delay: 100, class: 'text-secondary' },
    { text: '(C) 2025 CloudStrife7', delay: 150, class: 'text-dim' },
    { text: '', delay: 200 },
    { text: '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', delay: 250 },
    { text: '', delay: 300 },
    { text: 'POST: Power-On Self Test...', delay: 400 },
    { text: '  Checking BIOS.................... OK', delay: 600, class: 'boot-ok' },
    { text: '  Memory Test: 640K................ OK', delay: 800, class: 'boot-ok' },
    { text: '  Display Adapter.................. OK', delay: 1000, class: 'boot-ok' },
    { text: '', delay: 1100 },
    { text: 'Loading Devlog...', delay: 1300 },
    { text: '  Connecting to GitHub............. OK', delay: 1500, class: 'boot-ok' },
    { text: '  Loading blog entries............. OK', delay: 1700, class: 'boot-ok' },
    { text: '  Initializing search.............. OK', delay: 1900, class: 'boot-ok' },
    { text: '', delay: 2000 },
    { text: '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', delay: 2100 },
    { text: 'Boot complete. Welcome to Basement OS.', delay: 2300, class: 'boot-info' },
    { text: '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', delay: 2500 },
  ];

  document.addEventListener('astro:page-load', () => {
      // Boot Logic
      const bootScreen = document.getElementById('boot-screen');
      const mainContent = document.getElementById('main-content');
      const navMenu = document.getElementById('nav-menu');
      const aiDisclosure = document.getElementById('ai-disclosure');
      
      let bootIndex = 0;

      function runBootSequence() {
          if (!bootScreen) return;
          
          if (bootIndex < BOOT_SEQUENCE.length) {
              const item = BOOT_SEQUENCE[bootIndex];
              const line = document.createElement('div');
              line.className = 'boot-line';
              if (item.class) line.classList.add(item.class);
              line.textContent = item.text;
              line.style.animationDelay = '0s';
              bootScreen.appendChild(line);
              bootIndex++;

              const nextDelay = bootIndex < BOOT_SEQUENCE.length
                  ? BOOT_SEQUENCE[bootIndex].delay - item.delay
                  : 500;
              setTimeout(runBootSequence, nextDelay);
          } else {
              // Wait for mode selection if not already done
              const hasSelectedMode = sessionStorage.getItem('basement-os-mode-selected');
              if (!hasSelectedMode) {
                  window.dispatchEvent(new Event('basement-os-request-mode-selection'));
                  
                  // Wait for selection to complete
                  window.addEventListener('basement-os-mode-ready', () => {
                      finishBoot();
                  }, { once: true });
              } else {
                  finishBoot();
              }
          }
      }

      function finishBoot() {
          setTimeout(() => {
              if (bootScreen) bootScreen.style.display = 'none';
              if (mainContent) mainContent.classList.add('active');
              if (navMenu) navMenu.classList.add('active');
              if (aiDisclosure) aiDisclosure.style.display = 'block';
          }, 800);
      }

      // Check if already booted
      const hasBooted = sessionStorage.getItem('basement-os-booted');
      
      // Override for forced reboot (optional, for debugging)
      const urlParams = new URLSearchParams(window.location.search);
      const forceBoot = urlParams.get('boot') === 'true';

      if (!hasBooted || forceBoot) {
          // Start Boot
          if (bootScreen) {
              bootScreen.style.display = 'block';
              if (mainContent) mainContent.classList.remove('active');
              if (navMenu) navMenu.classList.remove('active');
              if (aiDisclosure) aiDisclosure.style.display = 'none';
              
              bootIndex = 0;
              bootScreen.innerHTML = ''; // clear previous if any
              runBootSequence();
              sessionStorage.setItem('basement-os-booted', 'true');
          }
      } else {
          // Ensure immediate display if already booted
           if (bootScreen) bootScreen.style.display = 'none';
           if (mainContent) mainContent.classList.add('active');
           if (navMenu) navMenu.classList.add('active');
           if (aiDisclosure) aiDisclosure.style.display = 'block';
      }

      // Theme Logic
      const THEMES = [
        'high-contrast', 'synthwave', 'framer-dark', 'framer-light',
        'solarized-dark', 'solarized-light', 'catppuccin',
        'monokai', 'gruvbox-dark', 'gruvbox-light',
        'rose-pine', 'rose-pine-dawn', 'rose-pine-moon', 'cappuccino',
        'basementos'
      ];

      /** @type {HTMLSelectElement} */
      const themeSelect = /** @type {HTMLSelectElement} */ (document.getElementById('theme-select'));

      /** @param {string} theme */
      function setTheme(theme) {
        if (!THEMES.includes(theme)) theme = 'synthwave';
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('basement-os-theme', theme);
        if (themeSelect) themeSelect.value = theme;
      }

      // Apply saved theme immediately on page load
      const savedTheme = localStorage.getItem('basement-os-theme') || 'synthwave';
      setTheme(savedTheme);

      if (themeSelect) {
        themeSelect.addEventListener('change', (e) => {
          setTheme(/** @type {HTMLSelectElement} */ (e.target).value);
        });
      }

      // Mode Logic

      /** @type {HTMLSelectElement} */
      const modeSelect = /** @type {HTMLSelectElement} */ (document.getElementById('mode-select'));

      // Initial Sync
      if (modeSelect) {
        modeSelect.value = getSavedMode();
        modeSelect.addEventListener('change', (e) => {
          setAudienceMode(/** @type {HTMLSelectElement} */ (e.target).value);
        });
      }

      // Ensure dynamic links are correct on first load
      document.addEventListener("astro:page-load", () => {
        const currentMode = getSavedMode();
        updateDynamicLinks(currentMode);
        
        // Update Footer Mode
        const statusMode = document.getElementById('status-mode');
        if (statusMode) {
            statusMode.textContent = currentMode.toUpperCase();
        }
      });

      // Sync header mode selector and footer when mode changes from other places
      window.addEventListener('basement-os-mode-change', (e) => {
        // @ts-ignore
        const mode = e.detail.mode;
        if (modeSelect) modeSelect.value = mode;
        
        // Update Footer Mode
        const statusMode = document.getElementById('status-mode');
        if (statusMode) {
            statusMode.textContent = mode.toUpperCase();
        }
      });

      // Clock
      function updateClock() {
        const now = new Date();
        const time = now.toLocaleTimeString('en-US', { hour12: true });
        const clock = document.getElementById('clock');
        if (clock) clock.textContent = time;
      }
      
      // Clear existing interval to prevent duplicates on nav
      // @ts-ignore - Global window property for cleanup
      if (window.clockInterval) clearInterval(window.clockInterval);
      // @ts-ignore - Global window property for cleanup
      window.clockInterval = setInterval(updateClock, 1000);
      updateClock();

      // Reboot Logic
      const rebootBtn = document.getElementById('btn-reboot');
      const shutdownScreen = document.getElementById('shutdown-screen');
      
      if (rebootBtn && shutdownScreen) {
          rebootBtn.addEventListener('click', () => {
              // 1. Show waiting screen
              shutdownScreen.style.display = 'flex';
              document.body.style.cursor = 'wait';
              
              setTimeout(() => {
                  // 2. Show "Safe to turn off"
                  const msg1 = shutdownScreen.querySelector('.shutdown-msg-1') as HTMLElement;
                  const msg2 = shutdownScreen.querySelector('.shutdown-msg-2') as HTMLElement;
                  
                  if (msg1) msg1.style.display = 'none';
                  if (msg2) msg2.style.display = 'block';
                  
                  setTimeout(() => {
                      // 3. Random Turn Off Animation
                      const animations = ['anim-crt', 'anim-vhs', 'anim-phosphor'];
                      const randomAnim = animations[Math.floor(Math.random() * animations.length)];
                      
                      // For CRT effect, we need to center the transform origin to the viewport
                      if (randomAnim === 'anim-crt') {
                          const scrollY = window.scrollY;
                          const viewportHeight = window.innerHeight;
                          const docHeight = document.body.scrollHeight;
                          const centerY = scrollY + (viewportHeight / 2);
                          
                          // Set origin to center of current viewport
                          document.body.style.transformOrigin = `50% ${centerY}px`;
                      }

                      document.body.classList.add(randomAnim);
                      
                      setTimeout(() => {
                          // 4. Reset and Reboot
                          sessionStorage.removeItem('basement-os-booted');
                          window.location.reload();
                      }, 2500); // Increased wait for slower animations (phosphor is 2.5s)
                  }, 2000); // Read text duration
              }, 2000); // Shutdown wait duration
          });
      }


      // Terminal Demo Logic
      const terminalToggle = document.getElementById('terminal-toggle');
      const terminalDemo = document.getElementById('terminal-demo');
      const terminalRoot = document.getElementById('terminal-demo-root');
      const terminalDisconnect = document.getElementById('terminal-disconnect');
      const disconnectDots = document.getElementById('disconnect-dots');
      
      let terminalInstance = null;
      /** @type {string|null} */
      let originalTheme = null;
      /** @type {Element|null} */
      let originalActiveBtn = null;
      let isTerminalActive = false;

      // Load terminal script dynamically
      /** @returns {Promise<void>} */
      function loadTerminalScript() {
        return new Promise((resolve, reject) => {
          // @ts-ignore - Global window property
          if (window.BasementOSDemo) {
            resolve();
            return;
          }
          const script = document.createElement('script');
          script.src = '/js/basement-os-demo.js';
          script.onload = () => resolve();
          script.onerror = () => reject(new Error('Failed to load terminal script'));
          document.head.appendChild(script);
        });
      }

      async function openTerminal() {
        if (isTerminalActive) return;
        isTerminalActive = true;

        // Save current theme and fade to basementos
        originalTheme = localStorage.getItem('basement-os-theme') || 'synthwave';
        document.documentElement.style.transition = 'all 0.3s ease';
        document.documentElement.setAttribute('data-theme', 'basementos');

        // Update disclosure text for terminal mode
        const disclosureHeader = document.querySelector('.ai-disclosure-header');
        const disclosureContent = document.querySelector('.ai-disclosure-content');
        if (disclosureHeader) disclosureHeader.textContent = '[ BASEMENT OS SIMULATION ACTIVE ]';
        if (disclosureContent) disclosureContent.textContent = 'Terminal code simulates VRChat environment and is direct copy of C# Code modified for Web View. Navigate with ‚Üë ‚Üì ‚Üê ‚Üí , Enter to select, Esc to go back.';

        // Hide main content, show terminal
        if (mainContent) mainContent.style.display = 'none';
        if (terminalDemo) terminalDemo.style.display = 'block';

        // Load and init terminal
        try {
          await loadTerminalScript();
          // @ts-ignore - Global window property
          if (terminalRoot && window.BasementOSDemo) {
            // @ts-ignore - Global window property
            terminalInstance = new window.BasementOSDemo('terminal-demo-root');
            // @ts-ignore - Global window property
            window.basementOSInstance = terminalInstance;
            terminalInstance.init();
          }
        } catch (e) {
          console.error('Terminal init error:', e);
        }

        // Mark terminal button as active - save and remove active from others first
        originalActiveBtn = document.querySelector('.nav-btn.active');
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        if (terminalToggle) terminalToggle.classList.add('active');
      }

      function closeTerminal() {
        if (!isTerminalActive) return;

        // Show disconnect animation
        if (terminalDisconnect && disconnectDots && terminalRoot) {
          terminalRoot.style.opacity = '0.3';
          terminalDisconnect.style.display = 'flex';
          
          // Animate dots: . -> .. -> ...
          let dotCount = 0;
          const dotInterval = setInterval(() => {
            dotCount++;
            if (disconnectDots) disconnectDots.textContent = '.'.repeat(dotCount);
            if (dotCount >= 3) {
              clearInterval(dotInterval);
              
              // After animation, clean up and show content
              setTimeout(() => {
                finishClose();
              }, 300);
            }
          }, 400);
        } else {
          finishClose();
        }
      }

      function finishClose() {
        // Destroy terminal instance
        if (terminalInstance && terminalInstance.destroy) {
          terminalInstance.destroy();
        }
        terminalInstance = null;
        // @ts-ignore - Global window property
        window.basementOSInstance = null;
        isTerminalActive = false;

        // Clear terminal container
        if (terminalRoot) {
          terminalRoot.innerHTML = '';
          terminalRoot.style.opacity = '1';
        }
        if (terminalDisconnect) terminalDisconnect.style.display = 'none';
        if (disconnectDots) disconnectDots.textContent = '';

        // Fade back to original theme
        if (originalTheme) {
          document.documentElement.setAttribute('data-theme', originalTheme);
        }

        // Restore disclosure text
        const disclosureHeader = document.querySelector('.ai-disclosure-header');
        const disclosureContent = document.querySelector('.ai-disclosure-content');
        if (disclosureHeader) disclosureHeader.textContent = '[ NEXT-GEN AI DEVLOG ]';
        if (disclosureContent) disclosureContent.textContent = 'Content Generated by Developer-Led AI Workflows. Reviewed by a Human-In-the-Loop.';

        // Show main content, hide terminal
        if (terminalDemo) terminalDemo.style.display = 'none';
        if (mainContent) mainContent.style.display = 'block';

        // Remove active state from terminal button and restore original
        if (terminalToggle) terminalToggle.classList.remove('active');
        if (originalActiveBtn) originalActiveBtn.classList.add('active');
      }

      // Terminal toggle click
      if (terminalToggle) {
        terminalToggle.addEventListener('click', () => {
          if (isTerminalActive) {
            closeTerminal();
          } else {
            openTerminal();
          }
        });
      }

      // Close terminal when clicking other nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.id !== 'terminal-toggle') {
          btn.addEventListener('click', () => {
            if (isTerminalActive) {
              closeTerminal();
            }
          });
        }
      });

      // ESC to close terminal (but not to interfere with terminal's internal ESC handling)
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isTerminalActive && terminalInstance?.currentApp === 'SHELL') {
          closeTerminal();
          e.preventDefault();
        }
      });

      // Typewriter Effect for Section Headers
      const headers = document.querySelectorAll('.section-header');
      headers.forEach(header => {
          // Prevent re-running on same element if already processed (though page-load usually resets DOM)
          if (header.classList.contains('typewriter-text')) return;

          const text = header.textContent || '';
          header.innerHTML = '<span class="typewriter-cursor"></span>';
          header.classList.add('typewriter-text');
          
          let index = 0;
          function typeChar() {
              if (index < text.length) {
                  header.innerHTML = text.substring(0, index + 1) + '<span class="typewriter-cursor"></span>';
                  index++;
                  setTimeout(typeChar, 50); // Speed for headers
              }
          }
          
          // Slight delay before starting to simulate "loading"
          setTimeout(typeChar, 200);
      });

      // Lightbox Logic for devlog images
      const lightbox = document.getElementById('lightbox');
      /** @type {HTMLImageElement} */
      const lightboxImage = /** @type {HTMLImageElement} */ (document.getElementById('lightbox-image'));
      const lightboxClose = document.getElementById('lightbox-close');
      const lightboxPrev = document.getElementById('lightbox-prev');
      const lightboxNext = document.getElementById('lightbox-next');
      const lightboxCounter = document.getElementById('lightbox-counter');
      
      let currentImageIndex = 0;
      /** @type {HTMLImageElement[]} */
      let devlogImages = [];

      /** @param {number} index */
      function openLightbox(index) {
          if (!lightbox || !lightboxImage || devlogImages.length === 0) return;
          
          currentImageIndex = index;
          lightboxImage.src = devlogImages[index].src;
          lightboxImage.alt = devlogImages[index].alt || 'Devlog image';
          lightbox.classList.add('active');
          document.body.style.overflow = 'hidden'; // Prevent scroll
          updateCounter();
      }

      function closeLightbox() {
          if (!lightbox) return;
          lightbox.classList.remove('active');
          document.body.style.overflow = '';
      }

      function showPrevImage() {
          if (devlogImages.length === 0) return;
          currentImageIndex = (currentImageIndex - 1 + devlogImages.length) % devlogImages.length;
          if (lightboxImage) {
              lightboxImage.src = devlogImages[currentImageIndex].src;
              lightboxImage.alt = devlogImages[currentImageIndex].alt || 'Devlog image';
          }
          updateCounter();
      }

      function showNextImage() {
          if (devlogImages.length === 0) return;
          currentImageIndex = (currentImageIndex + 1) % devlogImages.length;
          if (lightboxImage) {
              lightboxImage.src = devlogImages[currentImageIndex].src;
              lightboxImage.alt = devlogImages[currentImageIndex].alt || 'Devlog image';
          }
          updateCounter();
      }

      function updateCounter() {
          if (lightboxCounter) {
              lightboxCounter.textContent = `${currentImageIndex + 1} / ${devlogImages.length}`;
          }
      }

      // Collect images from devlog content AND main landing page (crt-screen)
      devlogImages = /** @type {HTMLImageElement[]} */ (Array.from(document.querySelectorAll('.devlog-content img, .crt-screen img')));
      devlogImages.forEach((img, index) => {
          img.style.cursor = 'pointer'; // Ensure pointer cursor
          img.addEventListener('click', (e) => {
              e.preventDefault(); // Prevent anchor links from opening
              openLightbox(index);
          });
      });

      // Event listeners
      if (lightboxClose) lightboxClose.addEventListener('click', closeLightbox);
      if (lightboxPrev) lightboxPrev.addEventListener('click', showPrevImage);
      if (lightboxNext) lightboxNext.addEventListener('click', showNextImage);
      
      // Close on background click
      if (lightbox) {
          lightbox.addEventListener('click', (e) => {
              if (e.target === lightbox) closeLightbox();
          });
      }

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
          if (!lightbox?.classList.contains('active')) return;
          
          if (e.key === 'Escape') closeLightbox();
          if (e.key === 'ArrowLeft') showPrevImage();
          if (e.key === 'ArrowRight') showNextImage();
      });
  });

  // Scroll to Top Button
  document.addEventListener("astro:page-load", function() {
      const scrollBtn = document.getElementById('scroll-to-top');
      if (!scrollBtn) return;

      const SCROLL_THRESHOLD = 200;

      window.addEventListener('scroll', function() {
          if (window.scrollY > SCROLL_THRESHOLD) {
              scrollBtn.classList.add('visible');
          } else {
              scrollBtn.classList.remove('visible');
          }
      });

      scrollBtn.addEventListener('click', function() {
          window.scrollTo({
              top: 0,
              behavior: 'smooth'
          });
      });
  });

  // Page Visit Counter (hidden as memory display)
  document.addEventListener("astro:page-load", function() {
      const visitCounter = document.getElementById('visit-counter');
      if (!visitCounter) return;

      // Map visit count to realistic historic RAM sizes
      function getMemoryTier(visits) {
          // Memory tiers based on historic RAM sizes
          const tiers = [
              { threshold: 0, memory: '64K' },
              { threshold: 64, memory: '128K' },
              { threshold: 128, memory: '256K' },
              { threshold: 256, memory: '512K' },
              { threshold: 512, memory: '640K' },
              { threshold: 640, memory: '1MB' },
              { threshold: 1024, memory: '2MB' },
              { threshold: 2048, memory: '4MB' },
              { threshold: 4096, memory: '8MB' },
              { threshold: 8192, memory: '16MB' },
              { threshold: 16384, memory: '32MB' },
              { threshold: 32768, memory: '64MB' },
              { threshold: 65536, memory: '128MB' },
              { threshold: 131072, memory: '256MB' },
              { threshold: 262144, memory: '512MB' },
              { threshold: 524288, memory: '1GB' },
              { threshold: 1048576, memory: '2GB' },
              { threshold: 2097152, memory: '4GB' },
              { threshold: 4194304, memory: '8GB' },
              { threshold: 8388608, memory: '16GB' },
              { threshold: 16777216, memory: '32GB' },
          ];
          
          for (let i = tiers.length - 1; i >= 0; i--) {
              if (visits >= tiers[i].threshold) {
                  return tiers[i].memory;
              }
          }
          return '64K';
      }

      // Use CounterAPI.dev for simple page view counting
      const namespace = 'basementos';
      const key = 'pageviews';
      
      fetch(`https://api.counterapi.dev/v1/${namespace}/${key}/up`)
          .then(response => response.json())
          .then(data => {
              const count = data.count || 0;
              const memoryDisplay = getMemoryTier(count);
              visitCounter.textContent = `${memoryDisplay} OK`;
              
              // Update tooltip with current values
              const tooltipCurrent = document.getElementById('tooltip-current');
              const tooltipVisits = document.getElementById('tooltip-visits');
              if (tooltipCurrent) tooltipCurrent.textContent = memoryDisplay;
              if (tooltipVisits) tooltipVisits.textContent = count.toLocaleString() + ' views';
              
              // Highlight matching tier in the list
              const allTierRows = document.querySelectorAll('.mem-tooltip-row[data-tier]');
              allTierRows.forEach(row => {
                  const tierArrow = row.querySelector('.tier-arrow');
                  if (row.dataset.tier === memoryDisplay) {
                      row.classList.add('active-tier');
                      if (tierArrow) tierArrow.textContent = '‚Üí';
                  } else {
                      row.classList.remove('active-tier');
                      if (tierArrow) tierArrow.textContent = '';
                  }
              });
          })
          .catch(() => {
              // Fallback to static value if API fails
              visitCounter.textContent = '64K OK';
          });
  });
</script>
