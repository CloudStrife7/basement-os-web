Previous summary:
üìã **SESSION SUMMARY EXPORT**

## üéØ Session Goal Achieved:

**Fixed chat system PERMISSION_DENIED error** - Provided Firebase rules fix + enhanced fallback system ensuring chat works regardless of Firebase configuration

## üöß Current Status:

‚úÖ **Working:**

- BasementSocialNotifier.cs (VRChat integration)
- External webhook notifications
- Friend vs visitor detection
- Basement OS Mobile terminal interface
- Firebase database rules (user implemented)

üîß **In Progress:**

- Enhanced index.html with smart Firebase fallback (ready for deployment)
- Local chat system as backup mode

üêõ **Issues:**

- Original Firebase PERMISSION_DENIED resolved via rules fix
- Enhanced fallback system eliminates future chat failures

## üß† New Knowledge Gained:

**Firebase Integration Patterns:**

- Firebase Realtime Database requires public read/write rules for basement chat
- Smart fallback pattern: Firebase ‚Üí Local Chat ‚Üí Graceful degradation
- Enhanced error handling prevents total chat system failure

**UdonSharp Compatibility:**

- Previous session fixes still valid (no foreach loops, explicit null checks)
- Firebase v9 compat library works best with current setup

**PWA Architecture:**

- Enhanced diagnostics via `/chat` command for troubleshooting
- Local storage fallback maintains functionality offline
- Terminal command system expanded with chat diagnostics

## üìù Files Modified:

**index.html:**

- Added smart Firebase connection testing with `.info/connected` check
- Implemented `initializeLocalChat()` fallback system
- Enhanced `sendMessage()` with Firebase‚ÜíLocal fallback logic
- Added `/chat` terminal command for diagnostics
- Improved error handling and user messaging

**firebase-rules.json (artifact):**

- Created public read/write rules for basement-chat namespace
- Added message validation (500 char limit, required fields)
- Enabled typing indicator support

## üéØ Next Session Focus:

**Auto-generated prompt for tomorrow‚Äôs session:**

```
ü§ñ STREAMLINED SESSION START
TOMORROW'S GOAL: Test deployed enhanced chat system and verify cross-device functionality

WORKING ON: Chat system validation and potential Nokia Snake game integration

SCRIPTS TO UPLOAD: None needed - testing deployment results

CURRENT ISSUE: Verify Firebase vs Local chat modes working correctly after deployment
```

-----

## üöÄ **END-OF-SESSION REMINDERS**

### Archive New Knowledge

‚úÖ **Firebase fallback patterns** - Smart degradation from Firebase ‚Üí Local Chat  
‚úÖ **Enhanced terminal diagnostics** - `/chat` command for troubleshooting  
‚úÖ **PWA chat architecture** - Bulletproof messaging regardless of backend status

### Backup Modified Scripts

‚úÖ **Enhanced index.html** - Complete file ready for GitHub Pages deployment  
‚úÖ **Firebase rules** - JSON configuration for public basement chat access

**Current backup mode:** Manual (artifacts provided in conversation)

-----

## üìä **KEY ACHIEVEMENTS**

1. **Diagnosed root cause:** Firebase PERMISSION_DENIED due to restrictive database rules
1. **Provided dual solution:** Rules fix + enhanced fallback system
1. **Enhanced user experience:** Smart chat degradation with clear status messages
1. **Added debugging tools:** `/chat` command and comprehensive diagnostics
1. **Future-proofed system:** Chat works regardless of Firebase configuration

**Total time investment:** ~45 minutes troubleshooting ‚Üí **Bulletproof chat system** üéÆ‚ú®

**Deploy the enhanced index.html and your basement monitoring empire has unbreakable chat!** üè†üëë‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã

Focus for this session:
chat is working! I did not enable backup method.  push notifications are working on desktop but not ios or android.  For future - if there is a github method to do something, let me know that, let me know the advantages and disadvantages before using outside service.  I am very happy with firebase.  I thought you mentioned typing indicators is that really possible?

Push notification resources:

https://www.reddit.com/r/PWA/comments/1bzqq68/need_help_push_notifications_for_ios/

https://git.new/splitpro-push

This docs by web.dev is my reference: https://web.dev/articles/sending-messages-with-web-push-libraries|

Troubleshoot:
When I create a shortcut to basement os on my iPhone Home Screen it takes me to an error - 404 There isn‚Äôt a GitHub Pages site here.
If you‚Äôre trying to publish one, read the full documentation to learn how to set up GitHub Pages for your repository, organization, or user account.‚Äù

Change:
Replace the existing ‚Äújoin vr chat‚Äù add manual button for ‚ÄúLogin to Basement‚Äù toggle: add text in chat
[Alex has joined the basement] (Time stamp)

Button changes to ‚ÄúLogoff basement‚Äù
[Alex has left the basement] (Time stamp)

This is a manual work around.

Add:
future setting would be to be able to send a message to be basement though this app to the terminal inside, if you can‚Äôt join the party you can still send messages (need to limit some way to prevent spam - 1 per 30 min?)
Terminal beeps with external message tone and appears after the screen changes
‚ÄúINCOMING MESSAGE‚Ä¶
Paul :  Be there in 30 min!‚Äù

This way, it actually motivates people to stay in the basement if they can see people are joining soon without accessing their phone.  This actually gives people motivation to use the basement mobile app over sms.
Need to do a research session if this is actually possible to send to VR chat using current udon implementation.

Add admin to clear logs.
What is just that someone else finding the page putting in their name and chatting with us?  The importance of keeping it easy for my friends to use so I‚Äôm not wanting to add a complicated log in system you know?
Maybe,  maybe, one word they type in to access the chat.  But they are using it less chance they use it.
For login they click in the enter access code box.  It pour pops up their bumper pad on Android/ios (not full keyboard)
As they type the numbers, they are obscured with in with **** .   They do not need to hit login, as soon as they enter them it removes the Lock Screen

Code: <!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basement OS Mobile - Terminal Interface</title>
    <meta name="description" content="Terminal interface for VRChat basement monitoring with real-time chat">
    <meta name="theme-color" content="#1a1a2e">

```
<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">

<!-- Icons -->
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<style>
    @font-face {
        font-family: 'Monocraft';
        src: url('https://github.com/IdreesInc/Monocraft/releases/download/v4.0/Monocraft.ttc') format('truetype-collection');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Monocraft', 'Courier New', monospace;
        background: #000000;
        color: #00ff00;
        min-height: 100vh;
        overflow-x: hidden;
        font-size: 14px;
        line-height: 1.4;
        position: relative;
    }

    /* CRT Monitor Effects */
    body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(transparent 2px, rgba(0, 255, 0, 0.03) 2px, rgba(0, 255, 0, 0.03) 4px, transparent 4px);
        background-size: 100% 4px;
        pointer-events: none;
        z-index: 1000;
    }

    .container {
        max-width: 400px;
        margin: 0 auto;
        padding: 15px;
        min-height: 100vh;
        animation: powerOn 2s ease-in-out;
    }

    @keyframes powerOn {
        0% {
            transform: scaleY(0.001) scaleX(1);
            opacity: 0;
        }
        50% {
            transform: scaleY(0.1) scaleX(1);
            opacity: 0.5;
        }
        100% {
            transform: scaleY(1) scaleX(1);
            opacity: 1;
        }
    }

    .header {
        text-align: center;
        margin-bottom: 20px;
        padding: 15px;
        background: rgba(0, 255, 0, 0.1);
        border: 1px solid #00ff00;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        position: relative;
    }

    .ascii-logo {
        font-family: 'Courier New', monospace;
        font-size: 10px;
        line-height: 1.1;
        color: #00ff00;
        text-shadow: 0 0 5px #00ff00;
        margin-bottom: 5px;
        white-space: pre;
    }

    .title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 8px;
        text-shadow: 0 0 10px #00ff00;
    }

    .subtitle {
        font-size: 12px;
        opacity: 0.8;
        color: #66ff66;
    }

    .status-line {
        font-size: 11px;
        color: #ff9500;
        margin-top: 8px;
        text-align: center;
        font-weight: bold;
    }

    .boot-sequence {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #000000;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    .boot-text {
        font-family: 'Courier New', monospace;
        color: #00ff00;
        font-size: 12px;
        margin: 2px 0;
        opacity: 0;
        animation: typeIn 0.1s ease-in-out forwards;
    }

    @keyframes typeIn {
        to { opacity: 1; }
    }

    .cursor {
        display: inline-block;
        background: #00ff00;
        width: 8px;
        height: 14px;
        animation: blink 1s step-end infinite;
    }

    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
    }

    .debug-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 5000;
        padding: 20px;
        display: none;
        overflow-y: auto;
    }

    .debug-content {
        max-width: 600px;
        margin: 0 auto;
        color: #00ff00;
        font-family: 'Courier New', monospace;
        font-size: 12px;
    }

    .debug-header {
        text-align: center;
        margin-bottom: 20px;
        padding: 10px;
        border: 1px solid #00ff00;
        background: rgba(0, 255, 0, 0.1);
    }

    .debug-section {
        margin-bottom: 20px;
        padding: 10px;
        border: 1px solid rgba(0, 255, 0, 0.3);
        background: rgba(0, 255, 0, 0.05);
    }

    .debug-close {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(255, 0, 0, 0.2);
        border: 1px solid #ff0000;
        color: #ff0000;
        padding: 10px;
        cursor: pointer;
        border-radius: 4px;
    }

    .status-card {
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid #00ff00;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 4px 15px rgba(0, 255, 0, 0.2);
        position: relative;
    }

    .status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .status-text {
        font-size: 16px;
        font-weight: bold;
    }

    .last-update {
        font-size: 10px;
        color: #66ff66;
        opacity: 0.7;
    }

    .chat-messages {
        height: 300px;
        overflow-y: auto;
        padding: 10px;
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(0, 255, 0, 0.3);
        margin-bottom: 10px;
    }

    .message {
        margin-bottom: 10px;
        padding: 8px;
        border-radius: 6px;
        font-size: 12px;
    }

    .message-own {
        background: rgba(0, 255, 0, 0.1);
        margin-left: 20px;
        text-align: right;
    }

    .message-other {
        background: rgba(0, 150, 255, 0.1);
        margin-right: 20px;
    }

    .message-system {
        background: rgba(255, 165, 0, 0.1);
        text-align: left;
        font-style: normal;
        color: #ffa500;
        border-left: 3px solid #ffa500;
        padding-left: 10px;
    }

    .message-alert {
        background: rgba(255, 165, 0, 0.2);
        color: #ff9500;
        text-align: left;
        font-weight: bold;
        border: 1px solid rgba(255, 165, 0, 0.3);
        border-left: 3px solid #ff9500;
        padding-left: 10px;
    }

    .message-error {
        background: rgba(255, 0, 0, 0.1);
        color: #ff6666;
        text-align: left;
        border-left: 3px solid #ff6666;
        padding-left: 10px;
    }

    .message-debug {
        background: rgba(0, 255, 255, 0.1);
        color: #00ffff;
        text-align: left;
        font-family: 'Courier New', monospace;
        font-size: 11px;
        border-left: 3px solid #00ffff;
        padding-left: 10px;
    }

    .message-command {
        background: rgba(0, 255, 0, 0.2);
        color: #00ff00;
        text-align: left;
        font-weight: bold;
        border-left: 3px solid #00ff00;
        padding-left: 10px;
    }

    .message-author {
        font-weight: bold;
        margin-bottom: 3px;
        font-size: 10px;
        opacity: 0.8;
    }

    .message-time {
        font-size: 9px;
        opacity: 0.6;
        margin-top: 3px;
    }

    .typing-indicator {
        padding: 5px 10px;
        font-size: 10px;
        opacity: 0.7;
        color: #66ff66;
        font-style: italic;
    }

    .chat-input {
        display: flex;
        padding: 10px;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(0, 255, 0, 0.3);
        border-radius: 4px;
    }

    .message-input {
        flex: 1;
        background: rgba(0, 0, 0, 0.8);
        border: 1px solid #00ff00;
        border-radius: 4px;
        padding: 8px;
        color: #00ff00;
        font-family: inherit;
        font-size: 12px;
    }

    .message-input:focus {
        outline: none;
        box-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
    }

    .send-btn {
        margin-left: 8px;
        padding: 8px 12px;
        background: rgba(0, 255, 0, 0.2);
        border: 1px solid #00ff00;
        border-radius: 4px;
        color: #00ff00;
        cursor: pointer;
        font-size: 12px;
    }

    .send-btn:hover {
        background: rgba(0, 255, 0, 0.3);
    }

    .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .btn {
        flex: 1;
        padding: 12px;
        background: rgba(0, 255, 0, 0.1);
        border: 1px solid #00ff00;
        border-radius: 6px;
        color: #00ff00;
        font-family: inherit;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn:hover {
        background: rgba(0, 255, 0, 0.2);
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
    }

    .btn:active {
        transform: scale(0.95);
    }

    .notification-setup {
        background: rgba(255, 165, 0, 0.1);
        border: 1px solid #ffa500;
        color: #ffa500;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 12px;
    }

    .offline {
        background: rgba(255, 0, 0, 0.1);
        border-color: #ff0000;
        color: #ff0000;
    }

    .retry-btn {
        background: rgba(255, 165, 0, 0.2);
        border: 1px solid #ffa500;
        color: #ffa500;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
        font-size: 12px;
    }

    .retry-btn:hover {
        background: rgba(255, 165, 0, 0.3);
    }

    .command-help {
        background: rgba(0, 255, 0, 0.05);
        border: 1px solid rgba(0, 255, 0, 0.3);
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-size: 11px;
    }

    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #00ff00;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .pulse {
        animation: pulse 2s ease-in-out infinite alternate;
    }

    @keyframes pulse {
        from { opacity: 0.6; }
        to { opacity: 1; }
    }
</style>
```

</head>
<body>
    <!-- Boot Sequence Overlay -->
    <div id="boot-sequence" class="boot-sequence">
        <div id="boot-content"></div>
    </div>

```
<!-- Debug Panel -->
<div id="debug-panel" class="debug-panel">
    <div class="debug-close" onclick="closeDebugPanel()">[CLOSE]</div>
    <div class="debug-content">
        <div class="debug-header">
            <h2>[BASEMENT OS DEBUG CONSOLE]</h2>
            <p>System Diagnostics & Monitoring</p>
        </div>
        <div id="debug-content-body"></div>
    </div>
</div>

<div class="container">
    <div class="header">
        <div class="ascii-logo">
```

‚ñë‚ñí‚ñì‚ñà BASEMENT OS MOBILE v25 ‚ñà‚ñì‚ñí‚ñë
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
<span id="terminal-status">‚ñì INITIALIZING SYSTEM‚Ä¶ ‚ñì</span>
</div>
</div>

```
    <div id="notification-prompt" class="notification-setup" style="display: none;">
        > Enable push notifications for system alerts
        <button class="btn" onclick="enableNotifications()" style="margin-top: 10px; width: 100%;">
            ENABLE NOTIFICATIONS
        </button>
    </div>

    <div id="terminal-window" class="status-card">
        <div class="status-header">
            <div class="status-text">[BASEMENT OS TERMINAL]</div>
            <div class="last-update" id="last-update">INITIALIZING...</div>
        </div>
        
        <div id="terminal-content" class="chat-messages">
            <!-- Boot messages will be added here -->
        </div>
        
        <div class="typing-indicator" id="typing-indicator" style="display: none;">
            > Someone is typing...
        </div>
        
        <div class="chat-input">
            <input type="text" id="message-input" class="message-input" placeholder="> Enter command or message..." maxlength="200">
            <button onclick="sendMessage()" class="send-btn" id="send-btn" disabled>SEND</button>
        </div>
    </div>

    <div class="buttons">
        <button class="btn" onclick="refreshStatus()">[REFRESH]</button>
        <button class="btn" onclick="openDebugPanel()">[DEBUG]</button>
        <button class="btn" onclick="openVRChat()">[JOIN VRCHAT]</button>
        <button class="btn" id="status-btn">[CONNECTING...]</button>
    </div>
</div>

<script>
    // Configuration - ENHANCED VERSION
    const CONFIG = {
        // GitHub Pages URLs
        githubDataUrl: 'https://cloudstrife7.github.io/basement-os-mobile/current_activity.json',
        githubHistoryUrl: 'https://cloudstrife7.github.io/basement-os-mobile/activity_log.json',
        
        updateInterval: 10000, // 10 seconds
        
        // FIXED FRIENDS LIST - Your actual VRChat display names
        friendsList: ['GameFuel', '‚àóLexx‚àó', 'Onawarren', 'p_dreikosen 437e', 'Joe‚Ä§xino b349', 'M0J170'],
        
        // Firebase Chat Configuration - KEEPING CURRENT SETUP
        firebase: {
            apiKey: "AIzaSyCmp0gJNFkRqUMpmeV_yk9batETciCiON8",
            authDomain: "basement-chat.firebaseapp.com",
            databaseURL: "https://basement-chat-default-rtdb.firebaseio.com",
            projectId: "basement-chat",
            storageBucket: "basement-chat.firebasestorage.app",
            messagingSenderId: "113802900843",
            appId: "1:113802900843:web:659af7a3f62446ac96882e"
        }
    };

    // Enhanced State Management
    let chatEnabled = false;
    let firebaseApp = null;
    let database = null;
    let currentUser = null;
    let messagesRef = null;
    let unreadCount = 0;
    let lastMessageTime = 0;
    let typingTimeout = null;
    let currentActivity = null;
    let activityHistory = [];
    let lastUpdateTime = 0;
    let updateTimer = null;
    let isOnline = navigator.onLine;
    let connectionAttempts = 0;
    let maxRetries = 3;
    let isInDemoMode = false;
    let systemLogs = [];
    let debugMode = false;

    // Terminal Commands System
    const TERMINAL_COMMANDS = {
        '/help': showHelp,
        '/debug': openDebugPanel,
        '/status': showSystemStatus,
        '/logs': showSystemLogs,
        '/clear': clearTerminal,
        '/refresh': refreshStatus,
        '/friends': showFriendsList,
        '/diagnostics': runDiagnostics,
        '/version': showVersion,
        '/uptime': showUptime
    };

    // Demo data for testing
    let demoActivityIndex = 0;
    const demoActivities = [
        { total_count: 0, friend_count: 0, visitor_count: 0, event: 'empty' },
        { total_count: 1, friend_count: 1, visitor_count: 0, event: 'friend_joined' },
        { total_count: 2, friend_count: 1, visitor_count: 1, event: 'visitor_joined' },
        { total_count: 3, friend_count: 2, visitor_count: 1, event: 'friend_joined' },
        { total_count: 2, friend_count: 2, visitor_count: 0, event: 'visitor_left' },
        { total_count: 1, friend_count: 1, visitor_count: 0, event: 'friend_left' },
        { total_count: 0, friend_count: 0, visitor_count: 0, event: 'friend_left' }
    ];

    // Boot sequence data - STREAMLINED to actual systems
    const bootMessages = [
        'VRCHAT BASEMENT MONITORING SYSTEM ONLINE',
        'FIREBASE REALTIME CHAT DATABASE CONNECTED', 
        'GITHUB PAGES DATA PIPELINE ESTABLISHED'
    ];

    let bootIndex = 0;
    let startTime = Date.now();

    // Initialize app with boot sequence
    document.addEventListener('DOMContentLoaded', function() {
        startBootSequence();
    });

    function startBootSequence() {
        const bootElement = document.getElementById('boot-sequence');
        const bootContent = document.getElementById('boot-content');
        
        function showNextBootMessage() {
            if (bootIndex < bootMessages.length) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'boot-text';
                messageDiv.textContent = `> ${bootMessages[bootIndex]}`;
                messageDiv.style.animationDelay = '0s';
                bootContent.appendChild(messageDiv);
                
                bootIndex++;
                setTimeout(showNextBootMessage, 1200); // Slower for readability with only 3 lines
            } else {
                // Add cursor
                const cursorDiv = document.createElement('div');
                cursorDiv.className = 'boot-text';
                cursorDiv.innerHTML = '> <span class="cursor"></span>';
                bootContent.appendChild(cursorDiv);
                
                // Boot complete - start main app
                setTimeout(() => {
                    bootElement.style.display = 'none';
                    initializeApp();
                }, 1500); // Shorter since we have fewer lines
            }
        }
        
        showNextBootMessage();
    }

    function logSystem(message, type = 'info') {
        const timestamp = new Date().toISOString();
        const logEntry = {
            timestamp,
            message,
            type,
            time: Date.now()
        };
        
        systemLogs.push(logEntry);
        
        // Keep only last 100 logs
        if (systemLogs.length > 100) {
            systemLogs.shift();
        }
        
        if (debugMode) {
            console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
        }
    }

    function updateStatusLine(message) {
        const statusElement = document.getElementById('terminal-status');
        if (statusElement) {
            statusElement.textContent = `‚ñì ${message.toUpperCase()} ‚ñì`;
        }
        logSystem(`Status: ${message}`);
    }

    async function initializeApp() {
        console.log('üè† Initializing Lower Level 2.0 Monitor v25...');
        logSystem('Basement OS Mobile v25 initialization started');
        
        updateStatusLine('STARTING UP...');
        addTerminalMessage('>> BASEMENT OS MOBILE v25 STARTING UP...', 'system');
        addTerminalMessage('>> Terminal interface ready - Type /help for commands', 'command');
        
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            try {
                await navigator.serviceWorker.register('sw.js');
                console.log('‚úÖ Service Worker registered');
                logSystem('Service Worker registered successfully');
                addTerminalMessage('>> PWA SERVICE WORKER ACTIVE', 'system');
            } catch (error) {
                console.warn('‚ö†Ô∏è Service Worker registration failed (expected if sw.js missing):', error.message);
                logSystem(`Service Worker registration failed: ${error.message}`, 'warning');
                addTerminalMessage('>> PWA SERVICE WORKER DISABLED (sw.js missing)', 'system');
            }
        }

        // Initialize Firebase Chat
        updateStatusLine('INITIALIZING CHAT SYSTEM...');
        await initializeChat();

        // Check notification permission
        checkNotificationPermission();

        // Try to connect to real data first
        updateStatusLine('CONNECTING TO BASEMENT...');
        addTerminalMessage('>> ATTEMPTING CONNECTION TO BASEMENT MONITORING SYSTEM...', 'system');
        await refreshStatus();

        // Handle online/offline status
        window.addEventListener('online', handleOnlineStatus);
        window.addEventListener('offline', handleOnlineStatus);

        // Setup chat input handlers
        setupChatHandlers();
        
        updateStatusLine('TERMINAL INTERFACE READY');
        addTerminalMessage('>> BASEMENT OS MOBILE READY FOR OPERATION', 'system');
        addTerminalMessage(`>> Monitoring ${CONFIG.friendsList.length} friends for basement activity`, 'system');
        
        logSystem('Initialization completed successfully');
    }

    function startDemoMode() {
        isInDemoMode = true;
        logSystem('Demo mode activated - simulating basement activity');
        updateStatusLine('DEMO MODE ACTIVE');
        addTerminalMessage('>> DEMO MODE ACTIVATED - Simulating basement activity', 'system');
        addTerminalMessage('>> NOTIFICATIONS DISABLED in demo mode', 'system');
        addTerminalMessage('>> Type /diagnostics to check connection issues', 'command');
        
        // Start with empty basement
        updateUI(demoActivities[0]);
        
        // Cycle through demo activities every 15 seconds
        setInterval(() => {
            demoActivityIndex = (demoActivityIndex + 1) % demoActivities.length;
            const activity = demoActivities[demoActivityIndex];
            
            // Only show demo update if something interesting happens
            if (activity.total_count !== currentActivity?.total_count) {
                addTerminalMessage(`>> DEMO: Simulating ${activity.total_count} people in basement`, 'system');
            }
            
            updateUI(activity);
            checkForNotifications(activity);
            currentActivity = activity;
        }, 15000);
        
        setOnlineStatus(true);
    }

    async function initializeChat() {
        try {
            logSystem('Initializing Firebase chat system');
            // Load Firebase SDK
            await loadFirebaseSDK();
            
            // Initialize Firebase
            if (CONFIG.firebase.apiKey && CONFIG.firebase.apiKey !== "YOUR_FIREBASE_API_KEY") {
                firebaseApp = firebase.initializeApp(CONFIG.firebase);
                database = firebase.database();
                
                // Set up user
                currentUser = await setupChatUser();
                
                // Initialize chat listeners
                setupChatListeners();
                
                chatEnabled = true;
                updateChatStatus('Connected');
                addTerminalMessage('>> CHAT SYSTEM ONLINE', 'system');
                logSystem('Firebase chat system initialized successfully');
                console.log('‚úÖ Chat initialized successfully');
            } else {
                console.log('‚ÑπÔ∏è Firebase not configured - chat disabled');
                updateChatStatus('Chat disabled');
                addTerminalMessage('>> CHAT SYSTEM DISABLED (Firebase not configured)', 'system');
                logSystem('Firebase not configured - chat disabled', 'warning');
            }
        } catch (error) {
            console.error('‚ùå Chat initialization failed:', error);
            updateChatStatus('Connection failed');
            addTerminalMessage('>> CHAT SYSTEM ERROR: Connection failed', 'error');
            logSystem(`Chat initialization failed: ${error.message}`, 'error');
        }
    }

    async function loadFirebaseSDK() {
        // Load Firebase SDK dynamically
        if (typeof firebase === 'undefined') {
            const script1 = document.createElement('script');
            script1.src = 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js';
            document.head.appendChild(script1);
            
            const script2 = document.createElement('script');
            script2.src = 'https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js';
            document.head.appendChild(script2);
            
            // Wait for scripts to load
            await new Promise((resolve) => {
                script2.onload = resolve;
            });
        }
    }

    async function setupChatUser() {
        // Get or create user identity
        let userId = localStorage.getItem('basement-chat-user-id');
        let username = localStorage.getItem('basement-chat-username');
        
        if (!userId || !username) {
            // First time setup
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            username = prompt('Enter your name for basement chat:') || 'Anonymous';
            
            localStorage.setItem('basement-chat-user-id', userId);
            localStorage.setItem('basement-chat-username', username);
        }
        
        logSystem(`Chat user setup: ${username} (${userId})`);
        return { id: userId, name: username };
    }

    function setupChatListeners() {
        if (!database || !currentUser) return;
        
        messagesRef = database.ref('basement-chat/messages');
        
        // Listen for new messages
        messagesRef.limitToLast(50).on('child_added', (snapshot) => {
            const message = snapshot.val();
            displayMessage(message);
            
            // Show notification if chat is closed and message is from someone else
            if (message.userId !== currentUser.id) {
                unreadCount++;
                updateUnreadBadge();
                
                if (Notification.permission === 'granted') {
                    showNotification(
                        `üí¨ ${message.username}`,
                        message.text,
                        'chat'
                    );
                }
            }
        });
        
        // Listen for typing indicators
        const typingRef = database.ref('basement-chat/typing');
        typingRef.on('value', (snapshot) => {
            const typingUsers = snapshot.val() || {};
            updateTypingIndicator(typingUsers);
        });
    }

    function setupChatHandlers() {
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendBtn.disabled) {
                sendMessage();
            }
            
            // Show typing indicator
            if (chatEnabled && currentUser) {
                clearTimeout(typingTimeout);
                
                const typingRef = database.ref(`basement-chat/typing/${currentUser.id}`);
                typingRef.set({
                    username: currentUser.name,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                typingTimeout = setTimeout(() => {
                    typingRef.remove();
                }, 3000);
            }
        });
        
        messageInput.addEventListener('input', () => {
            const hasText = messageInput.value.trim() !== '';
            sendBtn.disabled = !hasText || !chatEnabled;
        });
    }

    // Terminal Command System
    function processCommand(input) {
        const command = input.toLowerCase().trim();
        
        if (TERMINAL_COMMANDS[command]) {
            addTerminalMessage(`>> Executing: ${command}`, 'command');
            TERMINAL_COMMANDS[command]();
            return true;
        }
        return false;
    }

    function showHelp() {
        addTerminalMessage('>> BASEMENT OS TERMINAL COMMANDS:', 'command');
        addTerminalMessage('   /help - Show this help message', 'system');
        addTerminalMessage('   /debug - Open debug console', 'system');
        addTerminalMessage('   /status - Show system status', 'system');
        addTerminalMessage('   /logs - Show system logs', 'system');
        addTerminalMessage('   /clear - Clear terminal', 'system');
        addTerminalMessage('   /refresh - Refresh basement data', 'system');
        addTerminalMessage('   /friends - Show friends list', 'system');
        addTerminalMessage('   /diagnostics - Run connection diagnostics', 'system');
        addTerminalMessage('   /version - Show version info', 'system');
        addTerminalMessage('   /uptime - Show system uptime', 'system');
    }

    function showSystemStatus() {
        const uptime = Math.floor((Date.now() - startTime) / 1000);
        addTerminalMessage('>> SYSTEM STATUS REPORT:', 'debug');
        addTerminalMessage(`   Online: ${isOnline ? 'YES' : 'NO'}`, 'debug');
        addTerminalMessage(`   Demo Mode: ${isInDemoMode ? 'YES' : 'NO'}`, 'debug');
        addTerminalMessage(`   Chat Enabled: ${chatEnabled ? 'YES' : 'NO'}`, 'debug');
        addTerminalMessage(`   Connection Attempts: ${connectionAttempts}`, 'debug');
        addTerminalMessage(`   Friends Monitored: ${CONFIG.friendsList.length}`, 'debug');
        addTerminalMessage(`   System Uptime: ${uptime}s`, 'debug');
        addTerminalMessage(`   Last Update: ${lastUpdateTime ? new Date(lastUpdateTime).toLocaleTimeString() : 'Never'}`, 'debug');
    }

    function showSystemLogs() {
        addTerminalMessage('>> RECENT SYSTEM LOGS:', 'debug');
        const recentLogs = systemLogs.slice(-10);
        recentLogs.forEach(log => {
            const timeStr = new Date(log.timestamp).toLocaleTimeString();
            addTerminalMessage(`   [${timeStr}] ${log.type.toUpperCase()}: ${log.message}`, 'debug');
        });
    }

    function clearTerminal() {
        const terminalContent = document.getElementById('terminal-content');
        terminalContent.innerHTML = '';
        addTerminalMessage('>> TERMINAL CLEARED', 'system');
        addTerminalMessage('>> Type /help for available commands', 'command');
    }

    function showFriendsList() {
        addTerminalMessage('>> MONITORED FRIENDS LIST:', 'debug');
        CONFIG.friendsList.forEach((friend, index) => {
            addTerminalMessage(`   ${index + 1}. ${friend}`, 'debug');
        });
    }

    function showVersion() {
        addTerminalMessage('>> BASEMENT OS MOBILE VERSION INFO:', 'debug');
        addTerminalMessage('   Version: v25 Enhanced', 'debug');
        addTerminalMessage('   Build: Terminal Interface', 'debug');
        addTerminalMessage('   Platform: Progressive Web App', 'debug');
        addTerminalMessage('   VRChat Integration: BasementSocialNotifier.cs', 'debug');
        addTerminalMessage('   Firebase: Realtime Database v9 Compat', 'debug');
    }

    function showUptime() {
        const uptime = Date.now() - startTime;
        const hours = Math.floor(uptime / (1000 * 60 * 60));
        const minutes = Math.floor((uptime % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((uptime % (1000 * 60)) / 1000);
        addTerminalMessage(`>> SYSTEM UPTIME: ${hours}h ${minutes}m ${seconds}s`, 'debug');
    }

    async function runDiagnostics() {
        addTerminalMessage('>> RUNNING CONNECTION DIAGNOSTICS...', 'debug');
        
        // Test GitHub Pages URLs
        for (const url of [CONFIG.githubDataUrl, CONFIG.githubHistoryUrl]) {
            try {
                addTerminalMessage(`   Testing: ${url}`, 'debug');
                const response = await fetch(url + '?t=' + Date.now());
                if (response.ok) {
                    addTerminalMessage(`   ‚úÖ Response: ${response.status} OK`, 'debug');
                    const text = await response.text();
                    try {
                        JSON.parse(text);
                        addTerminalMessage(`   ‚úÖ Valid JSON detected`, 'debug');
                    } catch (e) {
                        addTerminalMessage(`   ‚ùå Invalid JSON format`, 'error');
                    }
                } else {
                    addTerminalMessage(`   ‚ùå HTTP ${response.status}: ${response.statusText}`, 'error');
                }
            } catch (error) {
                addTerminalMessage(`   ‚ùå Connection failed: ${error.message}`, 'error');
            }
        }
        
        // Test Firebase connection
        if (database) {
            addTerminalMessage(`   ‚úÖ Firebase database connected`, 'debug');
        } else {
            addTerminalMessage(`   ‚ùå Firebase database not connected`, 'error');
        }
        
        addTerminalMessage('>> DIAGNOSTICS COMPLETE', 'debug');
    }

    function openDebugPanel() {
        const debugPanel = document.getElementById('debug-panel');
        const debugBody = document.getElementById('debug-content-body');
        
        // Build debug content
        const uptime = Math.floor((Date.now() - startTime) / 1000);
        const debugHTML = `
            <div class="debug-section">
                <h3>SYSTEM STATUS</h3>
                <p>Online: ${isOnline ? 'YES' : 'NO'}</p>
                <p>Demo Mode: ${isInDemoMode ? 'YES' : 'NO'}</p>
                <p>Chat Enabled: ${chatEnabled ? 'YES' : 'NO'}</p>
                <p>Connection Attempts: ${connectionAttempts}</p>
                <p>System Uptime: ${uptime}s</p>
                <p>Last Update: ${lastUpdateTime ? new Date(lastUpdateTime).toLocaleString() : 'Never'}</p>
            </div>
            
            <div class="debug-section">
                <h3>CONFIGURATION</h3>
                <p>GitHub Data URL: ${CONFIG.githubDataUrl}</p>
                <p>GitHub History URL: ${CONFIG.githubHistoryUrl}</p>
                <p>Update Interval: ${CONFIG.updateInterval}ms</p>
                <p>Max Retries: ${maxRetries}</p>
                <p>Friends Monitored: ${CONFIG.friendsList.length}</p>
            </div>
            
            <div class="debug-section">
                <h3>FRIENDS LIST</h3>
                ${CONFIG.friendsList.map((friend, i) => `<p>${i + 1}. ${friend}</p>`).join('')}
            </div>
            
            <div class="debug-section">
                <h3>RECENT LOGS (Last 20)</h3>
                ${systemLogs.slice(-20).map(log => {
                    const time = new Date(log.timestamp).toLocaleTimeString();
                    return `<p>[${time}] ${log.type.toUpperCase()}: ${log.message}</p>`;
                }).join('')}
            </div>
            
            <div class="debug-section">
                <h3>CURRENT ACTIVITY</h3>
                <pre>${JSON.stringify(currentActivity, null, 2)}</pre>
            </div>
        `;
        
        debugBody.innerHTML = debugHTML;
        debugPanel.style.display = 'block';
        debugMode = true;
    }

    function closeDebugPanel() {
        document.getElementById('debug-panel').style.display = 'none';
        debugMode = false;
    }

    function checkNotificationPermission() {
        if ('Notification' in window) {
            if (Notification.permission === 'default') {
                document.getElementById('notification-prompt').style.display = 'block';
            }
        }
    }

    async function enableNotifications() {
        if ('Notification' in window) {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                document.getElementById('notification-prompt').style.display = 'none';
                showNotification('NOTIFICATIONS ENABLED', 'You will now get alerts when friends join the basement');
                addTerminalMessage('>> NOTIFICATIONS ENABLED', 'system');
                logSystem('Push notifications enabled');
            }
        }
    }

    async function refreshStatus() {
        try {
            console.log('üîÑ Fetching basement status...');
            logSystem('Attempting to fetch basement status');
            
            // Only show this on first connection, not every refresh
            if (connectionAttempts === 0 && !currentActivity) {
                addTerminalMessage('>> ATTEMPTING CONNECTION TO BASEMENT MONITORING SYSTEM...', 'system');
            }
            
            const response = await fetch(CONFIG.githubDataUrl + '?t=' + Date.now());
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('üìä Activity data:', data);
            logSystem(`Activity data received: ${data.total_count} total, ${data.friend_count} friends`);
            
            updateUI(data);
            checkForNotifications(data);
            
            currentActivity = data;
            lastUpdateTime = Date.now();
            connectionAttempts = 0; // Reset retry counter on success
            
            // Update online status
            setOnlineStatus(true);
            
            // Only show connection message on first successful connection
            if (!updateTimer) {
                updateStatusLine('DATA STREAM ACTIVE');
                addTerminalMessage('>> CONNECTION ESTABLISHED - Data stream active', 'system');
                startAutoRefresh();
            }
            
        } catch (error) {
            console.error('‚ùå Failed to fetch status:', error);
            logSystem(`Failed to fetch status: ${error.message}`, 'error');
            connectionAttempts++;
            
            if (connectionAttempts <= maxRetries) {
                updateStatusLine(`CONNECTION RETRY ${connectionAttempts}/${maxRetries}`);
                addTerminalMessage(`>> CONNECTION FAILED - Retry ${connectionAttempts}/${maxRetries}`, 'error');
                setTimeout(() => refreshStatus(), 5000); // Retry after 5 seconds
            } else {
                // If we've exhausted retries and not in demo mode, start demo mode
                if (!isInDemoMode) {
                    updateStatusLine('SWITCHING TO DEMO MODE...');
                    addTerminalMessage('>> SWITCHING TO DEMO MODE - GitHub Pages not accessible yet', 'system');
                    addTerminalMessage('>> This will show simulated basement activity until real data is available', 'system');
                    addTerminalMessage('>> Type /diagnostics to check connection issues', 'command');
                    setTimeout(() => {
                        startDemoMode();
                    }, 2000);
                } else {
                    updateStatusLine('CONNECTION FAILED');
                    setOnlineStatus(false);
                    showOfflineUI();
                    addTerminalMessage('>> CONNECTION FAILED - Maximum retries exceeded', 'error');
                    addTerminalMessage('>> Check your GitHub Pages URL configuration', 'error');
                    addTerminalMessage('>> Type /diagnostics for detailed connection analysis', 'command');
                }
            }
        }
    }

    function updateUI(activity) {
        const lastUpdate = document.getElementById('last-update');
        const statusBtn = document.getElementById('status-btn');
        
        const totalCount = activity.total_count || 0;
        const friendCount = activity.friend_count || 0;
        const visitorCount = activity.visitor_count || 0;
        
        // Update last update time
        lastUpdate.textContent = `LAST UPDATE: ${new Date().toLocaleTimeString()}`;
        
        // Update status button
        if (totalCount === 0) {
            statusBtn.textContent = '[BASEMENT EMPTY]';
            statusBtn.style.color = '#ff6666';
        } else {
            statusBtn.textContent = `[${totalCount} ACTIVE]`;
            statusBtn.style.color = '#00ff00';
        }
        
        // Only show detailed status on first load or when there are people
        if (!currentActivity || totalCount > 0) {
            addTerminalMessage(`>> BASEMENT STATUS: ${totalCount} people active`, 'system');
            
            if (totalCount > 0) {
                let details = '';
                if (friendCount > 0 && visitorCount > 0) {
                    details = `${friendCount} friends, ${visitorCount} visitors`;
                } else if (friendCount > 0) {
                    details = `${friendCount} friends`;
                } else {
                    details = `${visitorCount} visitors`;
                }
                addTerminalMessage(`   >>> ${details} currently in basement`, 'system');
            }
        }
    }

    function addTerminalMessage(text, type = 'system', username = '') {
        const terminalContent = document.getElementById('terminal-content');
        const messageDiv = document.createElement('div');
        
        const isOwn = currentUser && username === currentUser.name;
        const isSystem = type === 'system';
        const isError = type === 'error';
        const isAlert = type === 'alert';
        const isDebug = type === 'debug';
        const isCommand = type === 'command';
        
        let className = 'message ';
        if (isAlert) {
            className += 'message-alert';
        } else if (isError) {
            className += 'message-error';
        } else if (isDebug) {
            className += 'message-debug';
        } else if (isCommand) {
            className += 'message-command';
        } else if (isOwn) {
            className += 'message-own';
        } else if (isSystem) {
            className += 'message-system';
        } else {
            className += 'message-other';
        }
        
        messageDiv.className = className;
        
        const time = new Date().toLocaleTimeString();
        
        if (isSystem || isError || isAlert || isDebug || isCommand) {
            messageDiv.innerHTML = `
                <div>${text}</div>
                <div class="message-time">${time}</div>
            `;
        } else {
            messageDiv.innerHTML = `
                ${!isOwn ? `<div class="message-author">[${username}]</div>` : ''}
                <div>${text}</div>
                <div class="message-time">${time}</div>
            `;
        }
        
        terminalContent.appendChild(messageDiv);
        terminalContent.scrollTop = terminalContent.scrollHeight;
        
        // Keep only last 100 messages for performance
        while (terminalContent.children.length > 100) {
            terminalContent.removeChild(terminalContent.firstChild);
        }
    }

    function checkForNotifications(newActivity) {
        if (!currentActivity) return;
        
        const oldTotal = currentActivity.total_count || 0;
        const newTotal = newActivity.total_count || 0;
        const oldFriends = currentActivity.friend_count || 0;
        const newFriends = newActivity.friend_count || 0;
        const oldVisitors = currentActivity.visitor_count || 0;
        const newVisitors = newActivity.visitor_count || 0;
        
        // Only show IMPORTANT events in bold orange
        if (newFriends > oldFriends) {
            // Friend joined
            const friendName = getFriendNameByIndex(newFriends - 1) || 'UNKNOWN_FRIEND';
            addTerminalMessage(`üéÆ FRIEND JOINED: ${friendName} entered the basement`, 'alert');
            logSystem(`Friend joined: ${friendName}`);
            
            // Only show notifications if NOT in demo mode
            if (!isInDemoMode && Notification.permission === 'granted') {
                showNotification('FRIEND JOINED BASEMENT', `${friendName} entered the basement`, 'basement');
            }
        }
        
        if (newFriends < oldFriends) {
            // Friend left
            addTerminalMessage(`üì§ FRIEND LEFT: A friend has left the basement`, 'alert');
            logSystem('Friend left the basement');
        }
        
        if (newVisitors > oldVisitors) {
            // Visitor joined
            addTerminalMessage(`üë§ VISITOR JOINED: Unknown user entered the basement`, 'alert');
            logSystem('Visitor joined the basement');
            
            // Only show notifications if NOT in demo mode
            if (!isInDemoMode && Notification.permission === 'granted') {
                showNotification('VISITOR JOINED BASEMENT', 'Unknown user entered the basement', 'basement');
            }
        }
        
        if (newVisitors < oldVisitors) {
            // Visitor left
            addTerminalMessage(`üì§ VISITOR LEFT: Unknown user has left the basement`, 'alert');
            logSystem('Visitor left the basement');
        }
        
        // Special milestone messages
        if (oldTotal === 0 && newTotal > 0) {
            addTerminalMessage(`üéâ BASEMENT ACTIVE: First person entered - basement is now live!`, 'alert');
            logSystem('Basement became active');
        }
        
        if (oldTotal > 0 && newTotal === 0) {
            addTerminalMessage(`üò¥ BASEMENT EMPTY: Last person left - basement is now quiet`, 'alert');
            logSystem('Basement became empty');
        }
        
        if (newTotal >= 4 && oldTotal < 4) {
            addTerminalMessage(`üî• BIG HANGOUT: ${newTotal} people in basement - party time!`, 'alert');
            logSystem(`Big hangout detected: ${newTotal} people`);
        }
    }

    function getFriendNameByIndex(index) {
        return CONFIG.friendsList[index] || null;
    }

    function showNotification(title, body, type = 'basement') {
        if ('Notification' in window && Notification.permission === 'granted') {
            const notification = new Notification(title, {
                body: body,
                icon: 'icon-192.png',
                tag: type === 'chat' ? 'basement-chat' : 'basement-activity',
                badge: 'icon-192.png',
                data: { type: type }
            });
            
            notification.onclick = function() {
                window.focus();
                notification.close();
            };
            
            // Auto close after 5 seconds
            setTimeout(() => notification.close(), 5000);
            
            logSystem(`Notification sent: ${title}`);
        }
    }

    function startAutoRefresh() {
        if (updateTimer) return; // Already running
        
        updateTimer = setInterval(() => {
            if (!isInDemoMode) {
                refreshStatus();
            }
        }, CONFIG.updateInterval);
        
        logSystem('Auto-refresh timer started');
    }

    function setOnlineStatus(online) {
        isOnline = online;
        const terminalWindow = document.getElementById('terminal-window');
        
        if (online) {
            terminalWindow.classList.remove('offline');
            document.querySelector('.status-text').textContent = '[BASEMENT OS TERMINAL]';
        } else {
            terminalWindow.classList.add('offline');
            document.querySelector('.status-text').textContent = '[CONNECTION LOST]';
        }
    }

    function showOfflineUI() {
        addTerminalMessage('>> CONNECTION ERROR: Unable to reach basement monitoring system', 'error');
        addTerminalMessage('>> Please check your configuration and network connection', 'error');
        addTerminalMessage('>> Type /diagnostics for detailed connection analysis', 'command');
        
        // Add retry button to terminal
        const terminalContent = document.getElementById('terminal-content');
        const retryDiv = document.createElement('div');
        retryDiv.className = 'message message-system';
        retryDiv.innerHTML = `
            <div>
                <button class="retry-btn" onclick="retryConnection()">
                    [RETRY CONNECTION]
                </button>
            </div>
            <div class="message-time">${new Date().toLocaleTimeString()}</div>
        `;
        terminalContent.appendChild(retryDiv);
        terminalContent.scrollTop = terminalContent.scrollHeight;
    }

    function retryConnection() {
        connectionAttempts = 0;
        addTerminalMessage('>> RETRYING CONNECTION...', 'system');
        logSystem('Manual connection retry initiated');
        refreshStatus();
    }

    function handleOnlineStatus() {
        if (navigator.onLine && !isOnline) {
            // Just came back online
            updateStatusLine('NETWORK RESTORED');
            addTerminalMessage('>> NETWORK CONNECTION RESTORED', 'system');
            logSystem('Network connection restored');
            refreshStatus();
        } else if (!navigator.onLine) {
            updateStatusLine('NETWORK LOST');
            addTerminalMessage('>> NETWORK CONNECTION LOST', 'error');
            logSystem('Network connection lost', 'error');
            setOnlineStatus(false);
        }
    }

    function sendMessage() {
        const messageInput = document.getElementById('message-input');
        const text = messageInput.value.trim();
        
        if (!text) return;
        
        // Check if it's a command
        if (text.startsWith('/')) {
            const wasCommand = processCommand(text);
            if (wasCommand) {
                messageInput.value = '';
                document.getElementById('send-btn').disabled = true;
                return;
            }
        }
        
        // If not a command and chat is disabled, show error
        if (!chatEnabled || !currentUser || !database) {
            addTerminalMessage('>> CHAT ERROR: Chat system not available', 'error');
            addTerminalMessage('>> Commands: Type /help for available terminal commands', 'command');
            messageInput.value = '';
            document.getElementById('send-btn').disabled = true;
            return;
        }
        
        const message = {
            text: text,
            username: currentUser.name,
            userId: currentUser.id,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            type: 'user'
        };
        
        // Send message to Firebase
        messagesRef.push(message).then(() => {
            messageInput.value = '';
            document.getElementById('send-btn').disabled = true;
            logSystem(`Chat message sent: ${text.substring(0, 50)}...`);
            
            // Remove typing indicator
            if (typingTimeout) {
                clearTimeout(typingTimeout);
                database.ref(`basement-chat/typing/${currentUser.id}`).remove();
            }
        }).catch((error) => {
            console.error('Failed to send message:', error);
            addTerminalMessage('>> CHAT ERROR: Failed to send message', 'error');
            logSystem(`Chat error: ${error.message}`, 'error');
        });
    }

    function displayMessage(message) {
        const isOwn = currentUser && message.userId === currentUser.id;
        addTerminalMessage(message.text, 'user', message.username);
    }

    function updateUnreadBadge() {
        const badge = document.getElementById('unread-count');
        if (badge && unreadCount > 0) {
            badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            badge.style.display = 'inline';
        } else if (badge) {
            badge.style.display = 'none';
        }
    }

    function updateChatStatus(status) {
        // Only log chat status to console, don't spam terminal
        console.log(`Chat status: ${status}`);
        logSystem(`Chat status: ${status}`);
    }

    function updateTypingIndicator(typingUsers) {
        const indicator = document.getElementById('typing-indicator');
        if (!indicator || !currentUser) return;
        
        // Filter out current user and expired typing indicators
        const activeTypers = Object.entries(typingUsers)
            .filter(([userId, data]) => {
                if (userId === currentUser.id) return false;
                const age = Date.now() - (data.timestamp || 0);
                return age < 5000; // 5 seconds
            })
            .map(([userId, data]) => data.username);
        
        if (activeTypers.length > 0) {
            const typingText = activeTypers.length === 1 
                ? `> ${activeTypers[0]} is typing...`
                : `> ${activeTypers.slice(0, 2).join(', ')}${activeTypers.length > 2 ? ' and others' : ''} are typing...`;
            
            indicator.textContent = typingText;
            indicator.style.display = 'block';
        } else {
            indicator.style.display = 'none';
        }
    }

    function openVRChat() {
        // Try to open VRChat if installed, otherwise show instructions
        const vrchatUrl = 'vrchat://launch';
        
        // Create a temporary link and click it
        const link = document.createElement('a');
        link.href = vrchatUrl;
        link.click();
        
        addTerminalMessage('>> Attempting to launch VRChat...', 'system');
        logSystem('VRChat launch attempted');
        
        // Show fallback message after a delay
        setTimeout(() => {
            if (confirm('VRChat not detected. Would you like to visit the VRChat website?')) {
                window.open('https://vrchat.com', '_blank');
                logSystem('VRChat website opened');
            }
        }, 1000);
    }

    // PWA Install Prompt
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Show install button or banner
        console.log('üíæ PWA install prompt available');
        logSystem('PWA install prompt available');
    });

    // Handle app installation
    window.addEventListener('appinstalled', () => {
        console.log('üéâ PWA was installed');
        addTerminalMessage('>> BASEMENT OS MOBILE INSTALLED TO DEVICE', 'system');
        logSystem('PWA was installed to device');
        deferredPrompt = null;
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'd') {
            e.preventDefault();
            openDebugPanel();
        }
        
        if (e.key === 'Escape') {
            closeDebugPanel();
        }
    });
</script>
```

</body>
</html>