## üìã Table of Contents

1. [System Overview](https://www.notion.so/System-Architecture-247eda6cbcd281179a90d0c7fd984a84?pvs=21)
2. [Complete Method Signatures & Parameters](https://www.notion.so/System-Architecture-247eda6cbcd281179a90d0c7fd984a84?pvs=21)
3. [Variable & Property Specifications](https://www.notion.so/System-Architecture-247eda6cbcd281179a90d0c7fd984a84?pvs=21)
4. [Event Flow & Timing](https://www.notion.so/System-Architecture-247eda6cbcd281179a90d0c7fd984a84?pvs=21)
5. [UdonSharp Implementation Patterns](https://www.notion.so/System-Architecture-247eda6cbcd281179a90d0c7fd984a84?pvs=21)
6. [Inspector Configuration Requirements](https://www.notion.so/System-Architecture-247eda6cbcd281179a90d0c7fd984a84?pvs=21)
7. [Achievement Data Structures](https://www.notion.so/System-Architecture-247eda6cbcd281179a90d0c7fd984a84?pvs=21)
8. [Cross-Component Dependencies](https://www.notion.so/System-Architecture-247eda6cbcd281179a90d0c7fd984a84?pvs=21)
9. [Notification System Specifications](https://www.notion.so/System-Architecture-247eda6cbcd281179a90d0c7fd984a84?pvs=21)
10. [Testing & Debugging Patterns](https://www.notion.so/System-Architecture-247eda6cbcd281179a90d0c7fd984a84?pvs=21)
11. [Integration Guidelines](https://www.notion.so/System-Architecture-247eda6cbcd281179a90d0c7fd984a84?pvs=21)

---

## üéØ System Overview

The Lower Level 2.0 achievement system is a production-ready implementation featuring 19 achievements (420G total) with plans for expansion to 48 achievements (1000G). Built for VRChat SDK 3.8.2 with full UdonSharp compliance and Quest optimization.

### Core Components:

- **AchievementTracker.cs** - Event detection and notification triggering
- **AchievementDataManager.cs** - Data persistence and state management
- **NotificationEventHub.cs** - Message routing and distribution
- **XboxNotificationUI.cs** - Visual notification display
- **DOSTerminalAchievementModule.cs** - Terminal integration
- **NotificationRolesModule.cs** - User role detection
- **TerminalRemoteContentLoader.cs** - Remote content updates

---

## üìã 1. Complete Method Signatures & Parameters

### AchievementTracker.cs

### Public Methods:

```csharp
// VRChat Event Overrides
public override void OnPlayerJoined(VRCPlayerApi player)
public override void OnPlayerLeft(VRCPlayerApi player)

// Time Achievement Checking (Called by dataManager)
public void CheckForTimeBasedAchievementNotifications(string playerName)
// Parameters: playerName - Display name of player to check
// Called by: AchievementDataManager.UpdateSessionTime() every second

// Weather Achievement Checking
public void CheckForWeatherAchievementNotification(string playerName)
// Parameters: playerName - Display name of player to check
// Called by: DOSTerminalController when weather is "Heavy Rain"

```

### Private Methods Used Cross-Component:

```csharp
private void CheckForNewAchievements(string playerName, int currentVisits)
// Parameters:
//   playerName - Player display name
//   currentVisits - Visit count from dataManager
// Purpose: Central achievement checking logic

private void HandleNewAchievement(string playerName, int achievementLevel, string achievementType)
// Parameters:
//   playerName - Player display name
//   achievementLevel - Index of achievement (0-7 visit, 0-4 time, 0-5 activity)
//   achievementType - "visit", "time", or "activity"
// Purpose: Sends notification to NotificationEventHub

private void CheckForSpecificActivityAchievement(string playerName, int activityIndex)
// Parameters:
//   playerName - Player display name
//   activityIndex - Which activity achievement (0-5)
// Purpose: Checks single activity achievement without spam

private void CheckForSpecificTimeAchievement(string playerName, int timeIndex)
// Parameters:
//   playerName - Player display name
//   timeIndex - Which time achievement (0-4)
// Purpose: Checks single time achievement with spam prevention

```

### Testing Methods:

```csharp
[ContextMenu("üèÜ COMPREHENSIVE: All 19 Achievements + Persistence Test")]
public void ComprehensiveAllAchievementsTest()

[ContextMenu("üß™ BULLETPROOF: All 19 Achievements Test (Testing Overrides)")]
public void BulletproofComprehensiveAllAchievementsTest()

[ContextMenu("üíæ Test Persistence: Clear All Data")]
public void TestPersistence()

[ContextMenu("üìä Show Achievement Status")]
public void ShowAchievementStatus()

[ContextMenu("üß™ Test Time Achievements")]
public void TestTimeAchievements()

[ContextMenu("üß™ Quick Test All Activity Notifications")]
public void QuickTestAllActivityNotifications()

```

### AchievementDataManager.cs

### Public Methods:

```csharp
// Visit Management
public int AddPlayerVisit(string playerName)
// Returns: New visit count
// Sets PlayerData: "basement_total_visits", "basement_last_visit_date"
// Starts session tracking automatically

public int GetPlayerVisits(string playerName)
// Returns: Total visit count for player

// Achievement Checking
public bool HasPlayerEarnedAchievement(string playerName, int achievementLevel)
// Parameters: achievementLevel 0-7 for visit achievements
// Returns: true if earned
// Auto-saves to PlayerData when first earned

public bool HasPlayerEarnedTimeAchievement(string playerName, int timeAchievementLevel)
// Parameters: timeAchievementLevel 0-4 for time achievements
// Returns: true if earned
// Auto-saves to PlayerData when first earned

public bool HasPlayerEarnedActivityAchievement(string playerName, int activityIndex)
// Parameters: activityIndex 0-5 for activity achievements
// Returns: true if earned based on PlayerData flags

// Achievement Information
public string GetAchievementTitle(int achievementLevel)
public int GetAchievementPoints(int achievementLevel)
public string GetTimeAchievementTitle(int timeAchievementLevel)
public int GetTimeAchievementPoints(int timeAchievementLevel)
public string GetActivityAchievementTitle(int activityIndex)
public int GetActivityAchievementPoints(int activityIndex)

// Player Statistics
public int GetPlayerTotalPoints(string playerName)
// Returns: Sum of all earned achievement points

public int GetTotalAchievementCount()
// Returns: 19 (total achievements in system)

// Time Tracking
public void StartPlayerSession(string playerName)
// Called automatically by AddPlayerVisit()
// Sets "basement_session_start_time" in PlayerData

public void EndPlayerSession(string playerName)
// Called on OnPlayerLeft
// Updates total time and longest session

public float GetCurrentSessionTime(string playerName)
// Returns: Current session length in seconds

public float GetTotalPlayTime(string playerName)
// Returns: Total time across all sessions

public string FormatTimeDisplay(float totalSeconds)
// Returns: Human-readable format (e.g., "2h 34m")

// Activity Checking
public void CheckActivityAchievements(string activityType, string currentCondition)
// Parameters:
//   activityType: "weather", "time", "players", "date", "streak"
//   currentCondition: Context-specific value
// Called by: Various systems when conditions change

// Recent Achievement Tracking
public string GetMostRecentAchievementId(string playerName)
// Returns: Format "type_level" (e.g., "visit_0", "time_2")
// Uses "basement_most_recent_achievement" PlayerData key

```

### Testing Methods:

```csharp
[ContextMenu("Debug - Clear My PlayerData")]
public void DebugClearMyPlayerData()

[ContextMenu("üß™ Test Auto-Saving for All Achievement Types")]
public void TestAutoSavingForAllAchievements()

[ContextMenu("‚è±Ô∏è Test Session Time Tracking")]
public void TestSessionTimeTracking()

[ContextMenu("üÜï AUTO VISIT SYSTEM DIAGNOSTIC")]
public void AutoVisitSystemDiagnostic()

```

### NotificationEventHub.cs (v3.0 - Network Broadcasting Update)

### Public Event Handlers:

```
public void OnAchievementEarned()
// Called by: AchievementTracker.HandleNewAchievement()
// Now includes network broadcasting to all players
// Uses synced variables for achievement data distribution
// Expects variables set: eventPlayerName, eventAchievementLevel, eventAchievementType

public void OnPlayerJoinedWorld()  
// Called by: Login system
// Now includes network broadcasting for join notifications
// Uses synced variables for login data distribution
// Expects variables set: eventPlayerName, eventIsFirstTime

public override void OnDeserialization()
// VRChat callback for synced variable updates
// Processes remote achievement/login notifications
// Follows VRChat best practice for persistent state

public void PauseNotifications()
// Called by: External systems during ceremonies
// Sets: notificationsPaused = true

public void ResumeNotifications()
```

### XboxNotificationUI.cs

### Public Queue Methods:

```csharp
public void QueueAchievementNotification(string playerName, string achievementTitle, int points)
// Called by: NotificationEventHub
// Adds to notification queue

public void QueueOnlineNotification(string playerName, bool isFirstTime)
// Called by: NotificationEventHub
// Shows "Online" or "First Time" popup

public void ClearQueue()
// Emergency queue clear

```

### DOSTerminalAchievementModule.cs

### Public Refresh Methods:

```csharp
public void RefreshAchievementData()
// Called by: NotificationEventHub when achievements change
// Clears cache and regenerates pages

public void UpdateAchievementData()
// Regular update cycle
// Scheduled every 30 seconds

```

---

## üìã 2. Variable & Property Specifications

### AchievementTracker.cs Variables

### SerializeField References:

```csharp
[SerializeField] private AchievementDataManager dataManager;
// Required: Reference to data persistence component

[SerializeField] private UdonBehaviour notificationEventHub;
// Required: Reference to notification router

[SerializeField] private bool enableDebugLogging = true;
// Optional: Toggle debug output

[SerializeField] private UdonLogger productionLogger;
// Optional: In-world console output

```

### Private State Variables:

```csharp
private int[] activityAchievementPriority = { 0, 1, 2, 3, 4, 5 };
// Achievement check order

private bool[] timeAchievementNotificationSent = new bool[5];
// Spam prevention flags for session

private string localPlayerName = "";
// Cached local player name

```

### AchievementDataManager.cs Variables

### Achievement Data Arrays:

```csharp
// Visit Achievement Data
private int[] achievementMilestones = { 1, 5, 10, 25, 50, 75, 100, 250 };
private string[] achievementTitles = {
    "First Time Visitor",
    "Regular Visitor",
    "Shag Squad",
    "Basement Dweller",
    "Retro Regular",
    "Hot Tub Hero",
    "Century Club",
    "Lower Legend"
};
private int[] achievementPoints = { 0, 5, 10, 15, 20, 25, 30, 50 };

// Time Achievement Data
private float[] timeAchievementMilestones = { 300f, 1800f, 3600f, 7200f, 18000f };
private string[] timeAchievementTitles = {
    "Quick Visit",
    "Hangout Session",
    "Party Time",
    "2 Legit 2 Quit",
    "Marathon Gamer"
};
private int[] timeAchievementPoints = { 5, 10, 15, 20, 30 };

// Activity Achievement Data
private string[] activityAchievementTitles = {
    "Heavy Rain",
    "Night Owl",
    "Early Bird",
    "Weekend Warrior",
    "Streak Master",
    "Party Animal"
};
private int[] activityAchievementPoints = { 10, 10, 10, 15, 20, 25 };

```

### PlayerData Keys (Exact String Literals):

```csharp
// Visit Keys
private const string VISITS_KEY = "basement_total_visits";
private const string FIRST_VISIT_KEY = "basement_first_visit_date";
private const string LAST_VISIT_DATE_KEY = "basement_last_visit_date";

// Time Tracking Keys
private const string TOTAL_TIME_KEY = "basement_total_time_seconds";
private const string SESSION_START_KEY = "basement_session_start_time";
private const string LONGEST_SESSION_KEY = "basement_longest_session_seconds";
private const string SESSION_COUNT_KEY = "basement_total_sessions";
private const string LAST_SESSION_LENGTH_KEY = "basement_last_session_length";

// Activity Achievement Keys
private const string LAST_VISIT_HOUR_KEY = "basement_last_visit_hour";
private const string HEAVY_RAIN_EARNED_KEY = "basement_heavy_rain_earned";
private const string NIGHT_OWL_EARNED_KEY = "basement_night_owl_earned";
private const string EARLY_BIRD_EARNED_KEY = "basement_early_bird_earned";
private const string WEEKEND_WARRIOR_EARNED_KEY = "basement_weekend_warrior_earned";
private const string STREAK_MASTER_EARNED_KEY = "basement_streak_master_earned";
private const string PARTY_ANIMAL_EARNED_KEY = "basement_party_animal_earned";

// Visit Achievement Keys (Auto-generated in code)
string[] visitAchievementKeys = {
    "basement_first_visit_achievement",
    "basement_regular_visitor_achievement",
    "basement_shag_squad_achievement",
    "basement_basement_dweller_achievement",
    "basement_retro_regular_achievement",
    "basement_hottub_hero_achievement",
    "basement_century_club_achievement",
    "basement_lower_legend_achievement"
};

// Time Achievement Keys (Auto-generated in code)
string[] timeAchievementKeys = {
    "basement_quick_visit_earned",
    "basement_hangout_earned",
    "basement_party_time_earned",
    "basement_2_legit_2_quit_earned",
    "basement_marathon_earned"
};

// Recent Achievement Tracking
"basement_most_recent_achievement" // Format: "type_level"

```

### NotificationEventHub.cs Variables (v3.0 - Network Update)

### Network Synced Variables (NEW):

```
// Achievement notification data - synced to all players
[UdonSynced] private string syncedAchievementPlayerName = "";
[UdonSynced] private int syncedAchievementLevel = -1;
[UdonSynced] private string syncedAchievementType = "";
[UdonSynced] private int syncedAchievementCounter = 0; // Increment triggers sync

// Login notification data - synced to all players  
[UdonSynced] private string syncedLoginPlayerName = "";
[UdonSynced] private bool syncedLoginIsFirstTime = false;
[UdonSynced] private int syncedLoginCounter = 0; // Increment triggers sync

// Sync Mode Setting (follows VRChat best practice)
[UdonBehaviourSyncMode(BehaviourSyncMode.Manual)]
```

### Event Variables (Set via SetProgramVariable):

```
[HideInInspector] public string eventPlayerName = "";
[HideInInspector] public int eventAchievementLevel = -1;
[HideInInspector] public string eventAchievementType = "";
[HideInInspector] public bool eventIsFirstTime = false;
```

### Queue Management:

```
private string[] queuedPlayerNames;
private int[] queuedAchievementLevels;
private string[] queuedAchievementTypes;
private bool[] queuedIsFirstTime;
private int[] queuedNotificationTypes; // 0=achievement, 1=login
private int currentQueueSize = 0;
private int maxQueueSize = 20; // SerializeField configurable
```

---

## üìã 3. Event Flow with Exact Timings

### Visit Achievement Flow:

```
1. OnPlayerJoined(player) ‚Üí immediate
2. dataManager.AddPlayerVisit(playerName) ‚Üí returns new count
3. CheckForNewAchievements(playerName, newVisits) ‚Üí immediate
4. Loop through 8 visit levels checking IsNewlyEarnedVisitAchievement()
5. If newly earned: HandleNewAchievement() ‚Üí immediate
6. SetProgramVariable on notificationEventHub (3 values)
7. SendCustomEvent("OnAchievementEarned") ‚Üí immediate
8. NotificationEventHub processes and forwards to XboxNotificationUI
9. XboxNotificationUI queues and displays with 3-second duration

```

### Time Achievement Flow:

```
1. dataManager.StartPlayerSession() ‚Üí on join
2. SendCustomEventDelayedSeconds("UpdateSessionTime", 1.0f) ‚Üí every second
3. UpdateSessionTime() checks time milestones
4. If milestone reached: achievementTracker.CheckForTimeBasedAchievementNotifications()
5. CheckForSpecificTimeAchievement() with spam prevention
6. If not already notified: HandleNewAchievement()
7. Same notification flow as visit achievements

```

### Activity Achievement Flow:

```
1. External trigger (weather change, player count, etc.)
2. dataManager.CheckActivityAchievements(type, condition)
3. Specific condition checking based on type
4. If earned: PlayerData.SetBool() for persistence
5. achievementTracker.CheckForWeatherAchievementNotification() or similar
6. CheckForSpecificActivityAchievement() with index
7. If newly earned: HandleNewAchievement()
8. Same notification flow as other types

```

### Timing Constants:

```csharp
// Time achievement check interval
SendCustomEventDelayedSeconds("UpdateSessionTime", 1.0f);

// Terminal update interval
SendCustomEventDelayedSeconds("UpdateAchievementData", 30f);

// Notification display timings (in XboxNotificationUI)
fadeInDuration = 0.3f
displayDuration = 3.0f
fadeOutDuration = 0.5f
queueDelay = 0.2f
blinkRate = 2.0f
blinkCount = 3

```

---

## üìã 4. UdonSharp Implementation Patterns

### Error Handling (No try/catch):

```csharp
// PATTERN: Defensive null checking
if (player == null) return;
if (!Utilities.IsValid(player)) return;

// PATTERN: Safe VRCPlayerApi lookup
private VRCPlayerApi GetPlayerByName(string playerName)
{
    VRCPlayerApi[] players = new VRCPlayerApi[90];
    VRCPlayerApi.GetPlayers(players);

    for (int i = 0; i < players.Length; i++)
    {
        if (players[i] != null && Utilities.IsValid(players[i]))
        {
            if (players[i].displayName == playerName)
                return players[i];
        }
    }
    return null;
}

```

### Loop Structures (No foreach):

```csharp
// PATTERN: Traditional for loops only
for (int i = 0; i < array.Length; i++)
{
    if (array[i] != null)
    {
        // Process array[i]
    }
}

// PATTERN: Early exit with return
for (int i = 0; i < timeAchievementMilestones.Length; i++)
{
    if (currentTime >= timeAchievementMilestones[i])
    {
        // Process and return early
        return true;
    }
}

```

### String Manipulation (No interpolation):

```csharp
// WRONG: $"Player {name} earned {points}G"
// RIGHT:
string message = "Player " + name + " earned " + points.ToString() + "G";

// PATTERN: StringBuilder-style concatenation
string output = "";
output = output + "Line 1\\n";
output = output + "Line 2\\n";

```

### Timing Patterns:

```csharp
// PATTERN: Frame-based timing with Time.time
private float sessionStartTime;

void Start()
{
    sessionStartTime = Time.time;
}

void Update()
{
    float elapsed = Time.time - sessionStartTime;
    if (elapsed >= checkInterval)
    {
        // Do check
        sessionStartTime = Time.time; // Reset
    }
}

// PATTERN: SendCustomEventDelayedSeconds for repeating
public void UpdateSessionTime()
{
    // Do work
    SendCustomEventDelayedSeconds(nameof(UpdateSessionTime), 1.0f);
}

```

### Array Handling:

```csharp
// PATTERN: Fixed-size arrays with bounds checking
private string[] queuePlayerNames = new string[20];
private int queueCount = 0;

public void AddToQueue(string playerName)
{
    if (queueCount >= queuePlayerNames.Length) return;

    queuePlayerNames[queueCount] = playerName;
    queueCount++;
}

// PATTERN: Array initialization in Start()
void Start()
{
    timeAchievementNotificationSent = new bool[5];
    for (int i = 0; i < timeAchievementNotificationSent.Length; i++)
    {
        timeAchievementNotificationSent[i] = false;
    }
}

```

### Boolean Logic Patterns:

```csharp
// PATTERN: Explicit boolean checks
if (hasEarned == true) { }
if (isValid == false) { }

// PATTERN: Complex conditions broken down
bool isWeekend = dayOfWeek == 0 || dayOfWeek == 6;
bool hasWeekendKey = PlayerData.HasKey(player, WEEKEND_WARRIOR_EARNED_KEY);
bool alreadyEarned = hasWeekendKey && PlayerData.GetBool(player, WEEKEND_WARRIOR_EARNED_KEY);

if (isWeekend && !alreadyEarned)
{
    // Award achievement
}

```

---

## üìã 5. Inspector Configuration Requirements

### GameObject Hierarchy:

```
World Root
‚îú‚îÄ‚îÄ Achievement System
‚îÇ   ‚îú‚îÄ‚îÄ AchievementTracker (Script: AchievementTracker.cs)
‚îÇ   ‚îî‚îÄ‚îÄ AchievementDataManager (Script: AchievementDataManager.cs)
‚îú‚îÄ‚îÄ Notification System
‚îÇ   ‚îú‚îÄ‚îÄ NotificationEventHub (Script: NotificationEventHub.cs)
‚îÇ   ‚îú‚îÄ‚îÄ NotificationRolesModule (Script: NotificationRolesModule.cs)
‚îÇ   ‚îî‚îÄ‚îÄ Xbox Notifications
‚îÇ       ‚îî‚îÄ‚îÄ H3Title (Script: XboxNotificationUI.cs)
‚îî‚îÄ‚îÄ Terminal System
    ‚îú‚îÄ‚îÄ DOS Terminal Controller (Scripts: DOSTerminalController.cs, DOSTerminalAchievementModule.cs)
    ‚îî‚îÄ‚îÄ Terminal Remote Loader (Script: TerminalRemoteContentLoader.cs)

```

### Component Assignment Requirements:

### AchievementTracker Inspector:

- **Data Manager**: Drag AchievementDataManager GameObject
- **Notification Event Hub**: Drag NotificationEventHub GameObject
- **Enable Debug Logging**: ‚úì (for development)
- **Production Logger**: Optional UdonLogger reference

### AchievementDataManager Inspector:

- **Achievement Tracker**: Drag AchievementTracker GameObject
- **Enable Debug Logging**: ‚úì (for development)
- **Enable Time Tracking**: ‚úì
- **Time Update Interval**: 1.0
- **Lower Level Launch Date**: ‚Äú2025-07-19‚Äù

### NotificationEventHub Inspector:

- **Achievement Tracker**: Drag AchievementTracker GameObject
- **Data Manager**: Drag AchievementDataManager GameObject
- **Primary Notification Display**: Drag H3Title (XboxNotificationUI)
- **DOS Terminal Controller**: Drag DOS Terminal Controller
- **DOS Terminal Achievement Module**: Drag DOS Terminal Controller
- **Enable Pause System**: ‚úì
- **Max Queue Size**: 20

### XboxNotificationUI Inspector:

- **Notification Background**: UI Image component
- **Canvas Group**: Canvas Group component
- **Main Text**: ‚ÄúGAMERTAG - Achievement Unlocked‚Äù
- **Sub Text**: ‚ÄúPlayerName - Achievement Title - Points‚Äù
- **Xbox Logo**: Xbox logo GameObject
- **Trophy Icon**: Trophy icon GameObject
- **Roles Module**: Drag NotificationRolesModule
- **Audio Source**: Audio Source component
- **Sounds**: Assign audio clips for each notification type

---

## üìã 6. Achievement Data Structures

### Achievement Categories:

### Visit Achievements (8 total - 145G):

| Level | Title | Milestone | Points | PlayerData Key |
| --- | --- | --- | --- | --- |
| 0 | First Time Visitor | 1 visit | 0G | basement_first_visit_achievement |
| 1 | Regular Visitor | 5 visits | 5G | basement_regular_visitor_achievement |
| 2 | Shag Squad | 10 visits | 10G | basement_shag_squad_achievement |
| 3 | Basement Dweller | 25 visits | 15G | basement_basement_dweller_achievement |
| 4 | Retro Regular | 50 visits | 20G | basement_retro_regular_achievement |
| 5 | Hot Tub Hero | 75 visits | 25G | basement_hottub_hero_achievement |
| 6 | Century Club | 100 visits | 30G | basement_century_club_achievement |
| 7 | Lower Legend | 250 visits | 50G | basement_lower_legend_achievement |

### Time Achievements (5 total - 80G):

| Level | Title | Milestone | Points | PlayerData Key |
| --- | --- | --- | --- | --- |
| 0 | Quick Visit | 5 minutes | 5G | basement_quick_visit_earned |
| 1 | Hangout Session | 30 minutes | 10G | basement_hangout_earned |
| 2 | Party Time | 1 hour | 15G | basement_party_time_earned |
| 3 | 2 Legit 2 Quit | 2 hours | 20G | basement_2_legit_2_quit_earned |
| 4 | Marathon Gamer | 5 hours | 30G | basement_marathon_earned |

### Activity Achievements (6 total - 90G):

| Level | Title | Condition | Points | PlayerData Key |
| --- | --- | --- | --- | --- |
| 0 | Heavy Rain | Visit during heavy rain | 10G | basement_heavy_rain_earned |
| 1 | Night Owl | Visit between 12 AM - 5 AM | 10G | basement_night_owl_earned |
| 2 | Early Bird | Visit between 5 AM - 8 AM | 10G | basement_early_bird_earned |
| 3 | Weekend Warrior | Visit on weekend | 15G | basement_weekend_warrior_earned |
| 4 | Streak Master | 7-day visit streak | 20G | basement_streak_master_earned |
| 5 | Party Animal | Visit with 10+ players | 25G | basement_party_animal_earned |

### Achievement State Management:

```csharp
// PATTERN: Check earned status
bool isEarned = PlayerData.HasKey(player, key) && PlayerData.GetBool(player, key);

// PATTERN: Award achievement
if (!isEarned)
{
    PlayerData.SetBool(key, true);
    PlayerData.SetString("basement_most_recent_achievement", "type_level");
}

// PATTERN: Recent achievement format
// "visit_0" = First visit achievement
// "time_3" = 2 Legit 2 Quit achievement
// "activity_5" = Party Animal achievement

```

---

## üìã 7. Cross-Component Dependencies

### Required References:

### AchievementTracker ‚Üí AchievementDataManager:

- `dataManager.AddPlayerVisit()`
- `dataManager.HasPlayerEarnedAchievement()`
- `dataManager.GetAchievementTitle()`
- `dataManager.GetAchievementPoints()`

### AchievementTracker ‚Üí NotificationEventHub:

- `notificationEventHub.SetProgramVariable("eventPlayerName", name)`
- `notificationEventHub.SetProgramVariable("eventAchievementLevel", level)`
- `notificationEventHub.SetProgramVariable("eventAchievementType", type)`
- `notificationEventHub.SendCustomEvent("OnAchievementEarned")`

### AchievementDataManager ‚Üí AchievementTracker:

- `achievementTracker.CheckForTimeBasedAchievementNotifications(playerName)`

### NotificationEventHub ‚Üí AchievementDataManager:

- `dataManager.GetAchievementTitle(level)`
- `dataManager.GetTimeAchievementTitle(level)`
- `dataManager.GetActivityAchievementTitle(level)`

### NotificationEventHub ‚Üí XboxNotificationUI:

- `display.QueueAchievementNotification(name, title, points)`
- `display.QueueOnlineNotification(name, isFirstTime)`

### NotificationEventHub ‚Üí DOSTerminalAchievementModule:

- `dosTerminalAchievementModule.SendCustomEvent("RefreshAchievementData")`

### Execution Order:

1. AchievementDataManager initializes first (data layer)
2. AchievementTracker initializes (event detection)
3. NotificationEventHub initializes (routing)
4. XboxNotificationUI initializes (display)
5. Terminal components initialize last

### Failure Handling:

```csharp
// PATTERN: Null reference protection
if (dataManager == null)
{
    LogDebug("ERROR: AchievementDataManager not assigned!");
    return;
}

// PATTERN: Graceful degradation
if (notificationEventHub != null)
{
    // Send notification
}
else
{
    LogDebug("Achievement earned but no notification system");
}

```

---

## üìã 8. Notification System Specifications

### Queue Management:

### Queue Structure:

```csharp
// Parallel arrays for queue data
private NotificationType[] queueTypes;      // Achievement, Online, FirstTime
private string[] queuePlayerNames;          // Player display names
private string[] queueAchievementTitles;    // Achievement titles
private int[] queuePoints;                  // Gamerscore values
private int[] queuePriorities;              // Sorting priority
private float[] queueTimestamps;            // Queue time
private int queueCount = 0;                 // Current queue size

```

### Priority System:

```csharp
// Priority calculation (higher = shown first)
int priority = 0;
if (role == UserRole.Pwnerer) priority += 100;
if (role == UserRole.Supporter) priority += 50;
if (type == NotificationType.Achievement) priority += points;
priority -= (Time.time - queueTime);  // Older = higher priority

```

### Anti-Spam Protection:

### Session-based Prevention (AchievementTracker):

```csharp
private bool[] timeAchievementNotificationSent = new bool[5];

// Check before sending
if (timeAchievementNotificationSent[timeIndex])
{
    LogDebug("Already notified this session, skipping");
    return;
}

// Mark as sent
timeAchievementNotificationSent[timeIndex] = true;

```

### PlayerData-based Prevention:

```csharp
// Check if already earned in previous session
if (PlayerData.HasKey(player, achievementKey) &&
    PlayerData.GetBool(player, achievementKey))
{
    LogDebug("Already earned in PlayerData, skipping notification");
    return;
}

```

### Message Templates:

### Achievement Notifications:

- Main: ‚ÄúAchievement Unlocked‚Äù
- Sub: ‚Äú{PlayerName} - {AchievementTitle} - {Points}G‚Äù
- Supporter Main: ‚ÄúSupporter Achievement Unlocked‚Äù
- Pwnerer Main: ‚ÄúPwnerer Achievement Unlocked‚Äù

### Online Notifications:

- Main: ‚ÄúOnline‚Äù
- Sub: ‚Äú{PlayerName} is now online - Welcome back to the basement!‚Äù
- First Time Main: ‚ÄúWelcome to Lower Level 2.0‚Äù
- First Time Sub: ‚Äú{PlayerName} joined the party for the first time!‚Äù

### UI State Management:

```csharp
// Notification states
public enum NotificationState
{
    Inactive,
    FadingIn,
    Blinking,
    FadingOut,
    QueueDelay
}

// State transitions
Inactive ‚Üí FadingIn (0.3s) ‚Üí Blinking (3 blinks) ‚Üí FadingOut (0.5s) ‚Üí QueueDelay (0.2s) ‚Üí Inactive

```

---

## üìã 9. Testing & Debugging Patterns

### Debug Logging Pattern:

```csharp
private void LogDebug(string message)
{
    if (enableDebugLogging)
    {
        string coloredMessage = "<color=#FFD700>üèÜ [AchievementTracker] " + message + "</color>";
        Debug.Log(coloredMessage);

        if (productionLogger != null)
        {
            productionLogger.Log(message, "AchievementTracker");
        }
    }
}

```

### Component-Specific Debug Colors:

- AchievementTracker: Gold (#FFD700) üèÜ
- AchievementDataManager: Orange (#FFA500) üíæ
- NotificationEventHub: Light Blue (#87CEEB) üîî
- XboxNotificationUI: Xbox Green (#107C10) üì±
- DOSTerminalController: Cyan (#00FFFF) üñ•Ô∏è
- NotificationRolesModule: Royal Purple (#9932CC) üëë

### Testing Method Patterns:

### Comprehensive Real Testing:

```csharp
[ContextMenu("üèÜ COMPREHENSIVE: All 19 Achievements + Persistence Test")]
public void ComprehensiveAllAchievementsTest()
{
    // 1. Clear all data for clean test
    dataManager.DebugClearMyPlayerData();

    // 2. Earn achievements using real methods
    ForceEarnAllVisitAchievements();      // Uses AddPlayerVisit()
    ForceEarnAllTimeAchievements();       // Uses session time
    ForceEarnAllActivityAchievements();   // Uses CheckActivityAchievements()

    // 3. Verify persistence
    ShowAchievementStatus();
}

```

### Override Testing (Bypasses Conditions):

```csharp
[ContextMenu("üß™ BULLETPROOF: All 19 Achievements Test (Testing Overrides)")]
public void BulletproofComprehensiveAllAchievementsTest()
{
    // Directly sets PlayerData flags without meeting conditions
    string[] keys = { /* all achievement keys */ };
    foreach (string key in keys)
    {
        PlayerData.SetBool(key, true);
    }
}

```

### Before/After Testing Pattern:

```csharp
public void TestWeatherAchievement()
{
    bool hadBefore = dataManager.HasPlayerEarnedActivityAchievement(playerName, 0);
    dataManager.CheckActivityAchievements("weather", "Heavy Rain");
    bool hasAfter = dataManager.HasPlayerEarnedActivityAchievement(playerName, 0);

    if (!hadBefore && hasAfter)
    {
        // Only send notification if newly earned
        CheckForWeatherAchievementNotification(playerName);
    }
}

```

### PlayerData Manipulation:

### Clear All Data:

```csharp
public void DebugClearMyPlayerData()
{
    VRCPlayerApi localPlayer = Networking.LocalPlayer;

    // Clear all visit data
    PlayerData.SetInt(VISITS_KEY, 0);
    PlayerData.SetString(FIRST_VISIT_KEY, "");

    // Clear all achievement flags
    string[] allKeys = { /* comprehensive list */ };
    foreach (string key in allKeys)
    {
        if (PlayerData.HasKey(localPlayer, key))
        {
            PlayerData.SetBool(key, false);
        }
    }
}

```

### Validation Methods:

```csharp
public void ValidateAchievementSystem()
{
    // Check component connections
    bool hasDataManager = dataManager != null;
    bool hasEventHub = notificationEventHub != null;

    // Check PlayerData integrity
    int visits = PlayerData.GetInt(localPlayer, VISITS_KEY);
    bool validVisits = visits >= 0 && visits <= 9999;

    // Check achievement consistency
    for (int i = 0; i < achievementMilestones.Length; i++)
    {
        bool earned = HasPlayerEarnedAchievement(playerName, i);
        bool meetsRequirement = visits >= achievementMilestones[i];
        if (earned && !meetsRequirement)
        {
            LogDebug("WARNING: Achievement " + i + " earned without meeting requirement!");
        }
    }
}

```

---

## üìã 10. Integration Guidelines

### Adding New Achievement Types:

---

## üìã 11. Network Broadcasting System (v3.0)

### Overview:

The NotificationEventHub now implements proper network broadcasting using VRChat's synced variables and OnDeserialization callback pattern, following official VRChat documentation and best practices for persistent state and late-joiner support.

### Network Architecture:

```
// PATTERN: Ownership-based broadcasting
// Only the player who earned the achievement broadcasts it
if (isLocalPlayerAchievement)
{
    // Take ownership for broadcasting
    if (!Networking.IsOwner(gameObject))
    {
        Networking.SetOwner(localPlayer, gameObject);
    }
    
    // Update synced variables
    syncedAchievementPlayerName = eventPlayerName;
    syncedAchievementLevel = eventAchievementLevel;
    syncedAchievementType = eventAchievementType;
    syncedAchievementCounter++; // Increment to trigger sync
    
    // Request network sync to all players
    RequestSerialization();
}
```

### Key Improvements:

### Before (v2.0):

- Achievements only showed locally
- No network synchronization
- Other players couldn't see achievement notifications
- Login notifications were local-only

### After (v3.0):

- All players see achievement notifications
- Proper network synchronization using synced variables
- Follows VRChat's recommended persistent state pattern
- Login notifications broadcast to all players
- Late-joiners won't see old notifications (as intended)

### Network Flow:

```
1. Local player earns achievement
2. Takes ownership of NotificationEventHub GameObject
3. Updates synced variables with achievement data
4. Increments counter to force sync detection
5. Calls RequestSerialization() to broadcast
6. Remote clients receive update via OnDeserialization()
7. Remote clients process and display notification
8. All players see "GameFuel earned Hangout (10G)"
```

### Synced Variable Specifications:

| Variable | Type | Purpose | Update Trigger |
| --- | --- | --- | --- |
| syncedAchievementPlayerName | string | Player who earned achievement | On achievement earn |
| syncedAchievementLevel | int | Achievement index (0-7, 0-4, 0-5) | On achievement earn |
| syncedAchievementType | string | "visit", "time", or "activity" | On achievement earn |
| syncedAchievementCounter | int | Change detection counter | Incremented each broadcast |
| syncedLoginPlayerName | string | Player who joined | On player join |
| syncedLoginIsFirstTime | bool | First time visitor flag | On player join |
| syncedLoginCounter | int | Login change detection | Incremented each join |

### Best Practices Followed:

1. **Manual Sync Mode**: Uses `BehaviourSyncMode.Manual` for precise control
2. **Ownership Transfer**: Only the earning player can broadcast their achievement
3. **Counter Pattern**: Uses incrementing counters to ensure change detection
4. **OnDeserialization**: Proper callback implementation for remote processing
5. **Local Processing**: Processes locally regardless of broadcast status
6. **Null Checks**: Validates player and component references
7. **Terminal Integration**: Maintains compatibility with terminal refresh (null-safe for remote clients)

### Performance Considerations:

- Minimal network traffic (only sends when achievements earned)
- Synced strings kept short (player names typically <20 chars)
- Integer counters for efficient change detection
- No continuous sync overhead
- Queue system prevents notification spam

### Testing Validation:

```
[ContextMenu("Test Network Broadcasting")]
public void TestNetworkBroadcasting()
{
    // Simulate local achievement
    eventPlayerName = Networking.LocalPlayer.displayName;
    eventAchievementLevel = 1;
    eventAchievementType = "visit";
    OnAchievementEarned();
    
    // Check: All players should see notification
    // Check: Console shows "üì° Broadcasting achievement to all players"
    // Check: Remote clients show "üåê NETWORK: Received achievement notification"
}
```

### Compatibility Notes:

- Compatible with all existing achievement types
- Preserves pause/queue system functionality
- Terminal components null-safe for remote clients
- No breaking changes to existing interfaces
- Backwards compatible with v2.0 data structures

---

## üìã 10. Integration Guidelines

### Step 1: Define Achievement Data

```csharp
// In AchievementDataManager.cs
private string[] newAchievementTitles = { "Title1", "Title2" };
private int[] newAchievementPoints = { 10, 20 };
private float[] newAchievementRequirements = { 100f, 200f };

// Add PlayerData key constants
private const string NEW_ACHIEVEMENT_1_KEY = "basement_new_achievement_1";

```

### Step 2: Add Check Method

```csharp
public bool HasPlayerEarnedNewAchievement(string playerName, int level)
{
    VRCPlayerApi player = GetPlayerByName(playerName);
    if (player == null) return false;

    // Check PlayerData flag first
    string key = GetNewAchievementKey(level);
    if (PlayerData.HasKey(player, key) && PlayerData.GetBool(player, key))
        return true;

    // Check actual requirement
    float currentValue = GetPlayerNewValue(playerName);
    bool hasEarned = currentValue >= newAchievementRequirements[level];

    // Auto-save if newly earned
    if (hasEarned && !PlayerData.GetBool(player, key))
    {
        PlayerData.SetBool(key, true);
        PlayerData.SetString("basement_most_recent_achievement", "new_" + level);
    }

    return hasEarned;
}

```

### Step 3: Add Tracker Integration

```csharp
// In AchievementTracker.cs
public void CheckForNewAchievementNotifications(string playerName)
{
    for (int i = 0; i < dataManager.GetNewAchievementCount(); i++)
    {
        if (dataManager.HasPlayerEarnedNewAchievement(playerName, i))
        {
            HandleNewAchievement(playerName, i, "new");
        }
    }
}

```

### Step 4: Update NotificationEventHub

```csharp
// In OnAchievementEarned()
else if (eventAchievementType == "new")
{
    achievementTitle = dataManager.GetNewAchievementTitle(eventAchievementLevel);
    achievementPoints = dataManager.GetNewAchievementPoints(eventAchievementLevel);
}

```

### Common Integration Patterns:

### External Trigger Integration:

```csharp
// Example: Weather system integration
public void OnWeatherChanged(string newWeather)
{
    if (newWeather == "Heavy Rain")
    {
        VRCPlayerApi[] players = GetAllPlayers();
        for (int i = 0; i < players.Length; i++)
        {
            if (players[i] != null && Utilities.IsValid(players[i]))
            {
                string playerName = players[i].displayName;
                dataManager.CheckActivityAchievements("weather", "Heavy Rain");
                achievementTracker.CheckForWeatherAchievementNotification(playerName);
            }
        }
    }
}

```

### Time-Based Integration:

```csharp
// Pattern for periodic checks
private float lastCheck = 0f;
private float checkInterval = 60f; // Check every minute

void Update()
{
    if (Time.time - lastCheck >= checkInterval)
    {
        lastCheck = Time.time;
        PerformTimeBasedCheck();
    }
}

```

### Validation Checklist:

### Before Integration:

- [ ]  Define achievement data arrays
- [ ]  Add PlayerData key constants
- [ ]  Create HasPlayerEarned method
- [ ]  Add GetTitle/GetPoints methods
- [ ]  Update GetTotalAchievementCount()

### During Integration:

- [ ]  Add check method to tracker
- [ ]  Update HandleNewAchievement logic
- [ ]  Add case to NotificationEventHub
- [ ]  Test with context menu method
- [ ]  Verify PlayerData persistence

### After Integration:

- [ ]  Test earn ‚Üí leave ‚Üí rejoin flow
- [ ]  Verify Xbox notification display
- [ ]  Check terminal integration
- [ ]  Confirm no spam on rejoin
- [ ]  Document in changelog

### Common Pitfalls:

### Pitfall 1: Forgetting Auto-Save

```csharp
// WRONG: Only checking, not saving
if (playerVisits >= milestone)
    return true;

// RIGHT: Check AND auto-save
if (playerVisits >= milestone)
{
    if (!PlayerData.GetBool(player, key))
    {
        PlayerData.SetBool(key, true);
        PlayerData.SetString("basement_most_recent_achievement", id);
    }
    return true;
}

```

### Pitfall 2: Not Preventing Spam

```csharp
// WRONG: Always sends notification
if (hasEarned)
    SendNotification();

// RIGHT: Check if already notified
if (hasEarned && !alreadyNotifiedThisSession[index])
{
    SendNotification();
    alreadyNotifiedThisSession[index] = true;
}

```

### Pitfall 3: String Interpolation

```csharp
// WRONG: Using C# interpolation
string message = $"{player} earned {points}G";

// RIGHT: String concatenation
string message = player + " earned " + points.ToString() + "G";

```

### Testing Procedures:

### New Achievement Test Template:

```csharp
[ContextMenu("Test New Achievement Type")]
public void TestNewAchievementType()
{
    string playerName = Networking.LocalPlayer.displayName;

    // 1. Clear relevant data
    PlayerData.SetBool("basement_new_achievement_0", false);

    // 2. Simulate earning condition
    dataManager.SimulateNewAchievementCondition(playerName);

    // 3. Check for achievement
    achievementTracker.CheckForNewAchievementNotifications(playerName);

    // 4. Verify notification sent
    LogDebug("Test complete - check for Xbox notification");
}

```

---

## üìö Additional Resources

### Performance Considerations:

- PlayerData operations are Quest-optimized
- Limit checks to significant events (join, milestone, condition change)
- Cache player lookups when checking multiple achievements
- Use frame-based delays for non-critical updates

### Quest Compatibility:

- All PlayerData methods work on Quest
- String operations are performant
- No reflection or dynamic code generation
- Fixed-size arrays for predictable memory usage

### Future Expansion Ready:

- 29 achievement slots available (580G)
- Milestone achievements infrastructure ready
- Secret achievements framework in place
- Anniversary system designed but not implemented

---

## üéØ Quick Reference

### Most Used Methods:

```csharp
// Check if earned
dataManager.HasPlayerEarnedAchievement(playerName, level)

// Get achievement info
dataManager.GetAchievementTitle(level)
dataManager.GetAchievementPoints(level)

// Send notification
achievementTracker.HandleNewAchievement(playerName, level, type)

// Refresh terminal
notificationEventHub.RefreshTerminalDisplay()

```

### Critical PlayerData Keys:

- `basement_total_visits` - Visit counter
- `basement_session_start_time` - Current session start
- `basement_most_recent_achievement` - Format: ‚Äútype_level‚Äù
- `basement_[achievement]_earned` - Achievement flags

### Debug Commands:

- Clear all data: `DebugClearMyPlayerData()`
- Test all achievements: `BulletproofComprehensiveAllAchievementsTest()`
- Show status: `ShowAchievementStatus()`
- Force refresh: `RefreshAchievementData()`

---

**This documentation represents the complete technical specification of the Lower Level 2.0 achievement system. Every method, variable, and pattern has been verified against the actual implementation. Use this as the authoritative reference for any achievement system integration.**