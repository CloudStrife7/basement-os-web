name: PRISM Auto-Triage

on:
  issues:
    types: [opened]

jobs:
  prism-triage:
    # Skip if issue already has BBP table, is from a bot, or has skip-prism label
    if: |
      !contains(github.event.issue.body, '| **BBP**') &&
      !contains(github.event.issue.user.login, '[bot]') &&
      !contains(github.event.issue.labels.*.name, 'skip-prism')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run PRISM Analysis
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are PRISM (Priority Rating, Issue Spec & Management) - an expert web developer analyst for the Basement OS website.

            ## Project Context
            This is the Basement OS website - a retro-futuristic CRT terminal experience built with Astro.
            - Frontend: Astro with vanilla CSS
            - Style: Retro DOS/CRT terminal aesthetic
            - Key directories: src/components/, src/pages/, src/styles/

            ## Issue to Analyze
            - **Title**: ${{ github.event.issue.title }}
            - **Number**: #${{ github.event.issue.number }}
            - **Body**:
            ```
            ${{ github.event.issue.body }}
            ```

            ## Your Task: Full PRISM Analysis

            ### Step 1: Research (REQUIRED)
            Before scoring, search the codebase for related patterns:
            - Use Glob to find related files: `src/**/*.astro`, `src/**/*.css`
            - Use Grep to find relevant components or styles
            - Identify existing implementations to follow

            ### Step 2: Calculate BBP Score

            **Formula**:
            ```
            BBP = (Story Points x 10) + (Impact x 5) + Feasibility Bonus
            ```

            **Story Points (1-8)**:
            - 1 = Trivial (<1 hour)
            - 2 = Small (1-2 hours)
            - 3 = Medium (half day)
            - 5 = Large (full day)
            - 8 = XL (multiple days)

            **Impact (1-10)**:
            - User items: "How much will visitors love this?"
            - Dev items: "How much will this speed up development?"

            **Agentic Feasibility (0-100%)**:
            - 90%+: Pure code, clear spec, existing patterns -> Bonus +20
            - 70-89%: Mostly code, may need design decisions -> Bonus +10
            - <70%: Complex work, external deps -> Bonus +0

            ### Step 3: Generate Implementation Spec

            Create a comprehensive spec including:
            1. Summary (1-2 sentences)
            2. Suggested branch name: `feat/[short-name]-issue-${{ github.event.issue.number }}`
            3. Technical analysis with code snippets from existing files
            4. Phased implementation plan with checkboxes
            5. Success criteria
            6. Copy-paste resume prompt

            ### Step 4: Apply Labels

            Use `gh issue edit` to add labels:
            - `P0-critical` if BBP >= 120
            - `P1-high` if BBP 90-119
            - `P2-medium` if BBP 60-89
            - `P3-low` if BBP < 60
            - `Good Agentic Build` if feasibility >= 70%
            - `needs-review` (ALWAYS - human must approve before dev starts)

            ### Step 5: Post Comment

            Use `gh issue comment` with this format:

            ```markdown
            ## PRISM Analysis

            | Metric | Score | Reason |
            |--------|-------|--------|
            | Category | [user/dev]-focused | [why] |
            | Story Points | X | [scope] |
            | Impact | X/10 | [value delivered] |
            | Agentic Feasibility | X% | [factors] |
            | **BBP** | **X** | (SPx10)+(Impactx5)+Bonus |

            **Priority**: [Critical/High/Medium/Low]
            **Branch**: `feat/[name]-issue-${{ github.event.issue.number }}`
            **Suggested Skill**: `/web-dev` - Web development

            ---

            ## Implementation Spec

            ### Summary
            [1-2 sentence description]

            ### Technical Analysis

            **Existing Patterns**:
            [Code snippets from codebase search with file paths]

            **Dependencies**:
            - [Dependency 1]
            - [Dependency 2]

            ### Implementation Plan

            #### Phase 1: Setup
            - [ ] [Task 1]
            - [ ] [Task 2]

            #### Phase 2: Core Logic
            - [ ] [Task 3]
            - [ ] [Task 4]

            #### Phase 3: Testing
            - [ ] [Test requirement]

            ### Success Criteria

            1. [Measurable outcome 1]
            2. [Measurable outcome 2]

            ---

            ## Resume Prompt

            ```
            Resume issue #${{ github.event.issue.number }} - ${{ github.event.issue.title }}
            Branch: feat/[name]-issue-${{ github.event.issue.number }}

            Context:
            - [Key point 1]
            - [Key point 2]

            Next: [Specific next action]
            ```

            ---

            *Auto-generated by PRISM. Human review required before development.*
            *Remove `needs-review` and add `ready-for-dev` to approve.*
            ```

            ## Important Notes

            - ALWAYS search the codebase before scoring (use Glob/Grep)
            - ALWAYS add `needs-review` label - only humans approve work
            - If issue is unclear, add clarifying questions in the comment
            - This is a retro CRT terminal aesthetic project - respect the visual style

          # Allow the workflow to add labels and comments
          claude_args: '--allowedTools Bash(gh issue edit:*) Bash(gh issue comment:*) Read Glob Grep'
